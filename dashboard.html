<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - TI Maestro v82.0 (Trazabilidad)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { --primary: #0066CC; --secondary: #E31837; --success: #22c55e; --warning: #f59e0b; --info: #3b82f6; --dark: #0f172a; --bg: #f8fafc; --border: #e2e8f0; --radius: 12px; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); height: 100vh; display: flex; font-size: 13px; overflow: hidden; }
        
        #sidebar { width: 260px; background: linear-gradient(180deg, var(--primary) 0%, #0052a3 100%); color: white; padding: 25px; display: flex; flex-direction: column; flex-shrink: 0; }
        .logo-img { width: 120px; height: auto; margin-bottom: 30px; align-self: center; filter: drop-shadow(0 0 5px rgba(255,255,255,0.2)); }
        .nav-btn { background: rgba(255,255,255,0.1); color: white; border: none; padding: 12px 15px; border-radius: 8px; width: 100%; margin-bottom: 8px; text-align: left; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; }
        .nav-btn:hover { background: rgba(255,255,255,0.2); }
        .nav-btn.active { background: var(--secondary); font-weight: 700; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        .main-container { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        header { background: white; padding: 18px 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .content-area { padding: 25px; overflow-y: auto; flex-grow: 1; }
        
        /* KPIS */
        .kpi-section { margin-bottom: 25px; }
        .kpi-title { font-size: 11px; font-weight: 800; color: #94a3b8; text-transform: uppercase; margin-bottom: 10px; letter-spacing: 0.5px; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; }
        .kpi-card { background: white; padding: 15px; border-radius: var(--radius); border: 1px solid var(--border); display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: transform 0.2s; }
        .kpi-card:hover { transform: translateY(-3px); border-color: var(--primary); }
        .kpi-icon { width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; color: white; flex-shrink: 0; }
        .kpi-content { display: flex; flex-direction: column; }
        .kpi-number { font-size: 20px; font-weight: 800; color: var(--dark); line-height: 1; }
        .kpi-label { font-size: 10px; color: #64748b; font-weight: 600; text-transform: uppercase; margin-top: 4px; }

        /* TABLAS & LISTAS */
        .home-table-section { background: white; border-radius: var(--radius); border: 1px solid var(--border); display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; min-height: 300px; }
        .home-table-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #f8fafc; }
        .table-wrapper { background: white; border-radius: var(--radius); border: 1px solid var(--border); display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; height: calc(100vh - 180px); }
        .table-scroll { overflow: auto; width: 100%; height: 100%; }
        table { width: 100%; border-collapse: collapse; table-layout: auto; }
        th { background: #f1f5f9; padding: 10px; text-align: left; position: sticky; top: 0; z-index: 10; font-size: 11px; text-transform: uppercase; border-bottom: 2px solid var(--border); white-space: nowrap; color: #64748b; font-weight: 700; }
        td { padding: 8px 10px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; color: #334155; }
        tr:hover td { background-color: #f8fafc; }

        /* CHARTS */
        .reports-toolbar { display: flex; justify-content: flex-end; margin-bottom: 15px; }
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; padding-bottom: 50px; }
        .chart-card { background: white; padding: 20px; border-radius: var(--radius); border: 1px solid var(--border); display: flex; flex-direction: column; }
        .chart-header { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; }
        .chart-select { padding: 5px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 11px; flex-grow: 1; }
        .chart-canvas-container { flex-grow: 1; position: relative; min-height: 300px; }
        .btn-remove-chart { color: #cbd5e1; cursor: pointer; } .btn-remove-chart:hover { color: var(--secondary); }

        /* UTILS & UI */
        .hidden { display: none !important; }
        .admin-only { display: none !important; }
        body.role-admin .admin-only { display: flex !important; }
        .role-badge { font-size: 10px; padding: 2px 8px; border-radius: 12px; text-transform: uppercase; font-weight: 800; margin-left: 10px; }
        .badge-viewer { background: #f1f5f9; color: #64748b; border: 1px solid #cbd5e1; }
        .badge-admin { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .csv-panel { background: #fff; border: 2px dashed var(--primary); padding: 15px; border-radius: var(--radius); margin-bottom: 20px; align-items: center; gap: 20px; }
        .action-group { display: flex; gap: 5px; }
        .btn-icon { border: none; background: none; cursor: pointer; font-size: 14px; transition: 0.2s; padding: 6px; border-radius: 4px; }
        .btn-edit { color: var(--primary); background: #e0f2fe; }
        .btn-return { color: var(--warning); background: #fef3c7; }
        .btn-hist { color: #64748b; background: #f1f5f9; } .btn-hist:hover { background: #cbd5e1; color: var(--dark); }
        .btn-delete { color: var(--secondary); background: #fee2e2; }

        /* TIMELINE & TOAST */
        .timeline { list-style: none; padding: 0; margin-top: 10px; }
        .timeline-item { border-left: 2px solid #e2e8f0; padding-left: 20px; margin-bottom: 20px; position: relative; }
        .timeline-item::before { content: ''; position: absolute; left: -6px; top: 0; width: 10px; height: 10px; border-radius: 50%; background: var(--primary); }
        .timeline-date { font-size: 10px; color: #94a3b8; font-weight: 700; }
        .timeline-content { background: #f8fafc; padding: 10px; border-radius: 8px; margin-top: 5px; border: 1px solid #e2e8f0; }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-left: 5px solid; display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s ease-out; font-weight: 600; }
        .toast.success { border-color: var(--success); } .toast.error { border-color: var(--secondary); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* MODAL */
        .modal { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(2px); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 95%; max-width: 1100px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .form-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .field { display: flex; flex-direction: column; gap: 5px; }
        .field label { font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; }
        input, select, textarea { padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; transition: 0.2s; }
        .section-tag { grid-column: span 4; color: var(--primary); font-weight: 800; border-bottom: 2px solid #f1f5f9; padding-bottom: 5px; margin: 20px 0 10px 0; font-size: 12px; }
        .switch-box { display: flex; align-items: center; gap: 10px; background: #f8fafc; padding: 8px 12px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .toggle { position: relative; display: inline-block; width: 36px; height: 20px; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #cbd5e1; transition: .3s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(16px); }
        .disabled-field { background-color: #f1f5f9 !important; color: #94a3b8 !important; cursor: not-allowed !important; }
        .click-name { cursor: pointer; color: var(--primary); font-weight: 700; text-decoration: none; border-bottom: 1px dotted var(--primary); }
        .user-header { display: flex; align-items: center; gap: 20px; margin-bottom: 25px; border-bottom: 1px solid #e2e8f0; padding-bottom: 20px; }
        .user-avatar { width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 26px; font-weight: 700; }
        .asset-list { list-style: none; padding: 0; }
        .asset-item { border: 1px solid #e2e8f0; margin-bottom: 10px; border-radius: 8px; background: #fff; padding: 15px; }
        .asset-detail-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .asset-icon { width: 24px; text-align: center; display: inline-block; margin-right: 8px; color: var(--primary); }
        .separator { border-top: 1px dashed #e2e8f0; margin: 8px 0; }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <aside id="sidebar">
        <img src="https://logos-world.net/wp-content/uploads/2021/08/Dominos-Logo.png" class="logo-img">
        <button class="nav-btn active" id="btn-home" onclick="showView('home')"><i class="fas fa-home"></i> Inicio</button>
        <button class="nav-btn" id="btn-inv" onclick="showView('inventory')"><i class="fas fa-boxes"></i> Inventario Data</button>
        <button class="nav-btn" id="btn-phone" onclick="showView('telephony')"><i class="fas fa-mobile-alt"></i> Telefon铆a</button>
        <button class="nav-btn" id="btn-metrics" onclick="showView('metrics')"><i class="fas fa-chart-pie"></i> Reportes TI</button>
        <hr style="margin: 20px 0; opacity: 0.2;">
        <button class="nav-btn admin-only" style="background: var(--success);" onclick="nuevoRegistro()"><i class="fas fa-plus-circle"></i> NUEVO REGISTRO</button>
        <button class="nav-btn" style="background: rgba(0,0,0,0.3); margin-top: auto;" onclick="cerrarSesion()"><i class="fas fa-sign-out-alt"></i> Salir</button>
    </aside>

    <main class="main-container">
        <header>
            <h2 id="viewTitle">Dashboard General</h2>
            <div id="sync" style="font-size: 12px; color: #334155; font-weight: 600; display:flex; align-items:center;">
                <span id="userEmail" style="margin-right: 5px;">Cargando...</span>
                <span id="userRoleBadge" class="role-badge badge-viewer">...</span>
            </div>
        </header>
        
        <div class="content-area">
            
            <div id="view-home">
                
                <div class="kpi-section">
                    <div class="kpi-title">Estado del Inventario</div>
                    <div class="kpi-grid">
                        <div class="kpi-card"><div class="kpi-icon" style="background: var(--dark);"><i class="fas fa-cubes"></i></div><div class="kpi-content"><span class="kpi-number" id="kpi-total">-</span><span class="kpi-label">Total Activos</span></div></div>
                        <div class="kpi-card"><div class="kpi-icon" style="background: var(--primary);"><i class="fas fa-user-check"></i></div><div class="kpi-content"><span class="kpi-number" id="kpi-asig">-</span><span class="kpi-label">Asignados</span></div></div>
                        <div class="kpi-card"><div class="kpi-icon" style="background: var(--success);"><i class="fas fa-check-circle"></i></div><div class="kpi-content"><span class="kpi-number" id="kpi-dispo">-</span><span class="kpi-label">Disponibles</span></div></div>
                        <div class="kpi-card"><div class="kpi-icon" style="background: var(--warning);"><i class="fas fa-tools"></i></div><div class="kpi-content"><span class="kpi-number" id="kpi-mant">-</span><span class="kpi-label">En Mantenci贸n</span></div></div>
                        <div class="kpi-card"><div class="kpi-icon" style="background: #94a3b8;"><i class="fas fa-trash"></i></div><div class="kpi-content"><span class="kpi-number" id="kpi-baja">-</span><span class="kpi-label">De Baja</span></div></div>
                    </div>
                </div>

                <div class="kpi-section">
                    <div class="kpi-title">Tipos de Equipamiento & Alertas</div>
                    <div class="kpi-grid">
                        <div class="kpi-card"><div class="kpi-icon" style="background: var(--info);"><i class="fas fa-laptop"></i></div><div class="kpi-content"><span class="kpi-number" id="kpi-pcs">-</span><span class="kpi-label">Computadores</span></div></div>
                        <div class="kpi-card"><div class="kpi-icon" style="background: var(--info);"><i class="fas fa-mobile-alt"></i></div><div class="kpi-content"><span class="kpi-number" id="kpi-cels">-</span><span class="kpi-label">Celulares</span></div></div>
                        <div class="kpi-card"><div class="kpi-icon" style="background: var(--info);"><i class="fas fa-sim-card"></i></div><div class="kpi-content"><span class="kpi-number" id="kpi-sims">-</span><span class="kpi-label">Chips / SIMs</span></div></div>
                        <div class="kpi-card"><div class="kpi-icon" style="background: var(--secondary);"><i class="fas fa-user-slash"></i></div><div class="kpi-content"><span class="kpi-number" id="kpi-cesados">-</span><span class="kpi-label">Usuario Cesado</span></div></div>
                    </div>
                </div>

                <div class="home-table-section">
                    <div class="home-table-header">
                        <h4 style="color: var(--primary); margin: 0; font-size: 16px;"><i class="fas fa-history"></i> ltimos Movimientos</h4>
                        <button onclick="resetHomeTable()" style="font-size: 11px; background: white; border: 1px solid #cbd5e1; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight:600;">Actualizar</button>
                    </div>
                    <div class="table-scroll">
                        <table style="width: 100%;">
                            <thead><tr><th style="width: 35%;">Nombre / RUT</th><th style="width: 25%;">Estado</th><th style="width: 40%;">Ubicaci贸n / Serie</th></tr></thead>
                            <tbody id="lastMovesTable"><tr><td colspan="3" style="text-align:center; padding:20px;">Cargando datos...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-inventory" class="hidden">
                <div class="csv-panel admin-only">
                    <div><label style="display:block; font-size:10px; font-weight:800; color:var(--primary); margin-bottom:5px;">CARGA MASIVA CSV</label><input type="file" id="csvFile" accept=".csv"></div>
                    <button onclick="procesarCSV()" id="btnCsv" class="nav-btn" style="width:auto; background:var(--dark); margin:0; padding: 8px 16px;"><i class="fas fa-upload"></i> PROCESAR</button>
                </div>
                <input type="search" id="mainSearch" placeholder=" Buscar por RUT, Nombre, Serie, Tienda..." style="width: 100%; margin-bottom: 15px; padding: 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px; font-family:'Inter';" autocomplete="off">
                <div class="table-wrapper">
                    <div class="table-scroll">
                        <table>
                            <thead><tr><th>RUT</th><th>Responsable</th><th>Estado</th><th>Contrato</th><th>rea</th><th>Tienda</th><th>Modelo</th><th>Serie</th><th class="admin-only">Acciones</th></tr></thead>
                            <tbody id="masterTableBody"><tr><td colspan="9" style="text-align:center; padding:20px;">Cargando datos...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-telephony" class="hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: var(--primary);">Gesti贸n de L铆neas y Equipos M贸viles</h3>
                    <input type="search" id="phoneSearch" placeholder=" Buscar tel茅fono, IMEI, Usuario..." style="padding: 10px; border-radius: 8px; border: 1px solid var(--border); width: 300px;">
                </div>
                <div class="table-wrapper">
                    <div class="table-scroll">
                        <table>
                            <thead><tr><th>Usuario / Cargo</th><th>N煤mero</th><th>Equipo</th><th>IMEI</th><th>SIM (IMSI)</th><th>Observaciones</th><th class="admin-only">Acciones</th></tr></thead>
                            <tbody id="phoneTableBody"><tr><td colspan="7" style="text-align:center; padding:20px;">Cargando datos...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-metrics" class="hidden">
                <div class="reports-toolbar">
                    <button class="nav-btn" style="width:auto; background:var(--success); font-weight:700;" onclick="addChart()"><i class="fas fa-plus"></i> Agregar Gr谩fico</button>
                </div>
                <div class="charts-grid" id="chartsContainer">
                    </div>
            </div>
        </div>
    </main>

    <div id="modalFicha" class="modal hidden">
        <div class="modal-content">
            <h2 style="color: var(--primary); margin-bottom: 20px;">Ficha T茅cnica</h2>
            <div class="form-grid">
                <div class="section-tag">1. Colaborador</div>
                <div class="field"><label>RUT *</label><input type="text" id="f_rut" placeholder="Ej: 11.222.333-k"></div>
                <div class="field" style="grid-column: span 2;"><label>Nombre Completo</label><input type="text" id="f_nombre" list="listaNombres"><datalist id="listaNombres"></datalist></div>
                <div class="field"><label>Correo</label><input type="email" id="f_correo"></div>
                <div class="field"><label>rea</label><select id="f_area"><option>Operaciones</option><option>Inform谩tica</option><option>Administraci贸n</option><option>Marketing</option><option>Log铆stica</option><option>Finanzas</option><option>RRHH</option></select></div>
                <div class="field"><label>Tienda / Ubicaci贸n</label><select id="f_tienda"></select></div>
                <div class="field"><label>Contrato</label><select id="f_contractual"><option>Vigente</option><option>Cesado</option></select></div>

                <div class="section-tag">2. Equipo PC</div>
                <div class="field"><label>Marca PC</label><input type="text" id="f_marca"></div>
                <div class="field"><label>Modelo PC</label><input type="text" id="f_modelo"></div>
                <div class="field"><label>Serie PC *</label><input type="text" id="f_serie"></div>
                <div class="field"><label>Estado Asignaci贸n</label><select id="f_estado"><option>Asignado</option><option>Disponible</option><option>Mantenci贸n</option><option>Baja</option></select></div>
                
                <div class="section-tag">3. Telefon铆a M贸vil</div>
                <div class="switch-box"><label class="toggle"><input type="checkbox" id="sw_equipo" onchange="toggleTelefonia()"><span class="slider"></span></label><span>Equipo Celular</span></div>
                <div class="switch-box"><label class="toggle"><input type="checkbox" id="sw_sim" onchange="toggleTelefonia()"><span class="slider"></span></label><span>SIM Card</span></div>
                <div class="field"><label>N煤mero Telef贸nico</label><input type="text" id="f_numero" placeholder="+569..."></div>
                <div class="field"><label>Marca Cel</label><input type="text" id="f_mar_cel" class="disabled-field" disabled></div>
                <div class="field"><label>Modelo Cel</label><input type="text" id="f_mod_cel" class="disabled-field" disabled></div>
                <div class="field"><label>IMEI Equipo</label><input type="text" id="f_imei" class="disabled-field" disabled></div>
                <div class="field"><label>IMSI (SIM)</label><input type="text" id="f_imsi" class="disabled-field" disabled></div>

                <div class="section-tag">4. Control & Auditor铆a</div>
                <div class="field"><label>Fecha Entrega</label><input type="date" id="f_fecha_ent"></div>
                <div class="field"><label>Entregado Por (IT)</label><input type="text" id="f_ent_it"></div>
                <div class="field" style="grid-column: span 2;"><label>Observaciones</label><input type="text" id="f_obs"></div>
            </div>
            <div style="margin-top: 25px; text-align: right; border-top: 1px solid #f1f5f9; padding-top: 20px;">
                <button onclick="cerrarFicha()" style="padding:10px 20px; border:none; background:#f1f5f9; color:#64748b; cursor:pointer; border-radius:6px; margin-right: 10px; font-weight:600;">Cancelar</button>
                <button onclick="guardarTodoSincronizado()" id="btnSave" style="padding:10px 25px; border:none; background:var(--primary); color:white; font-weight:700; cursor:pointer; border-radius:6px;">GUARDAR</button>
            </div>
        </div>
    </div>

    <div id="modalDevolucion" class="modal hidden" style="z-index: 1200;">
        <div class="modal-content" style="max-width: 500px;">
            <h3 style="color: var(--warning); margin-bottom: 15px;"><i class="fas fa-box-open"></i> Devoluci贸n a Bodega</h3>
            <p style="margin-bottom: 20px;">El equipo serie <strong id="dev_serie"></strong> ser谩 asignado a <strong>INFORMATICA</strong>.</p>
            <div class="field" style="margin-bottom: 15px;"><label>Nuevo Estado</label><select id="dev_estado"><option value="Disponible">Disponible (Stock)</option><option value="Mantenci贸n">A Mantenci贸n</option><option value="Baja">Dar de Baja</option></select></div>
            <div class="field" style="margin-bottom: 15px;"><label>Nueva Ubicaci贸n</label><select id="dev_ubicacion"><option>Bodega Central</option><option>Casa Matriz</option><option>Soporte IT</option></select></div>
            <div class="field" style="margin-bottom: 20px;"><label>Observaciones</label><textarea id="dev_obs" rows="3" placeholder="Ej: Pantalla con rayas..."></textarea></div>
            <div style="text-align: right;"><button onclick="document.getElementById('modalDevolucion').classList.add('hidden')" style="padding:10px 20px; border:none; background:#f1f5f9; cursor:pointer; border-radius:6px; margin-right:10px;">Cancelar</button><button onclick="procesarDevolucion()" style="padding:10px 20px; border:none; background:var(--warning); color:#fff; font-weight:700; cursor:pointer; border-radius:6px;">CONFIRMAR</button></div>
        </div>
    </div>

    <div id="modalHistorial" class="modal hidden" style="z-index: 1300;">
        <div class="modal-content" style="max-width: 600px;">
            <h3 style="color: var(--dark); margin-bottom: 15px;">Historial de Trazabilidad</h3>
            <div id="historialContent" style="max-height: 400px; overflow-y: auto;">Cargando...</div>
            <div style="text-align: right; margin-top: 20px;"><button onclick="document.getElementById('modalHistorial').classList.add('hidden')" style="padding:8px 20px; border:none; background:#f1f5f9; cursor:pointer; border-radius:6px;">Cerrar</button></div>
        </div>
    </div>

    <div id="modalVerUsuario" class="modal hidden" style="z-index: 1100;">
        <div class="modal-content" style="max-width: 600px;">
            <div id="userProfileContent"></div>
            <div style="text-align: right; margin-top: 20px;"><button onclick="document.getElementById('modalVerUsuario').classList.add('hidden')" style="background:var(--dark); color:white; padding:8px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:600;">Cerrar</button></div>
        </div>
    </div>

<script>
if(typeof ChartDataLabels!=='undefined') Chart.register(ChartDataLabels);
const CONFIG = { URL: "https://ivjwxvhixrskraepqzse.supabase.co", KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2and4dmhpeHJza3JhZXBxenNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MjgxNTgsImV4cCI6MjA4NDUwNDE1OH0.QzgNSwqf6VTXZjGMXOAfUnjW4f1mJcRqECxxNnLZc-o" };
let sb; try { sb = window.supabase.createClient(CONFIG.URL, CONFIG.KEY); } catch(e) { console.error(e); }

const TIENDAS = [ "Casa Matriz", "Antofagasta - Estadio Regional", "Antofagasta - Sector Norte", "Arica", "Buin", "Bustamante", "Calama", "Chiguayante", "Chill谩n", "Concepcion - Plaza Acevedo", "Conc贸n", "Copiap贸", "Curic贸", "Froilan Roa", "General Velasquez", "Gran Avenida", "Hualp茅n", "Iquique", "Irarr谩zaval", "La Florida (Santa Amalia)", "La Serena (Balmaceda)", "Lautaro", "Luis Pasteur", "Machal铆", "Macul", "Maipu 1", "Mall del Centro*", "Mall Paseo Los Dominicos", "Manuel Montt", "Osorno 2 Centro", "Osorno 1 Rahue", "Parque Angamos", "Pedro Fontova", "Pe帽alol茅n", "Plaza Atenas", "Pto. Montt 2 (Cardonal)", "Pto. Montt 1 (Ejercito)", "Puente Alto", "Punta Arenas", "Quilicura", "Quilpu茅", "Recoleta", "San Francisco", "San Pedro de la Paz", "Santa Ana", "La Serena (B. Universitario)", "Talca", "Temuco", "Tobalaba", "Vi帽a del Mar", "Commisary" ];

let DB_ACTIVOS = [], DB_COLABS = [], charts = [], currentUserRole = 'viewer', currentUserEmail = '';
let currentSerieDevolucion = null;

function showToast(msg, type='success') {
    const d = document.createElement('div'); d.className = `toast ${type}`;
    d.innerHTML = `<i class="fas fa-${type==='success'?'check-circle':'exclamation-circle'}"></i> ${msg}`;
    document.getElementById('toast-container').appendChild(d);
    setTimeout(() => d.remove(), 3000);
}

function initSystem() {
    if(localStorage.getItem('manualAuth') === 'true') { loadApp("Admin Local", "admin"); return; }
    sb.auth.getSession().then(({ data: { session } }) => {
        if (!session) window.location.href = 'index.html'; else checkUserRole(session.user.email);
    });
}

async function checkUserRole(email) {
    let role = 'viewer';
    try { const { data } = await sb.from('user_roles').select('role').eq('email', email).single(); if(data) role = data.role; } catch(e) {}
    loadApp(email, role);
}

function loadApp(email, role) {
    currentUserEmail = email;
    document.getElementById('userEmail').innerText = email;
    currentUserRole = role;
    const badge = document.getElementById('userRoleBadge');
    if(role === 'admin') {
        document.body.classList.add('role-admin');
        badge.className = 'role-badge badge-admin'; badge.innerText = 'ADMINISTRADOR';
    } else {
        document.body.classList.remove('role-admin');
        badge.className = 'role-badge badge-viewer'; badge.innerText = 'VISUALIZADOR';
    }
    const storeOptions = TIENDAS.map(t=>`<option>${t}</option>`).join('');
    document.getElementById('f_tienda').innerHTML = storeOptions;
    document.getElementById('dev_ubicacion').innerHTML = `<option>Bodega Central</option><option>Soporte IT</option>${storeOptions}`;
    
    setupSearchListeners();
    cargarDatos();
}

async function cerrarSesion() {
    localStorage.removeItem('manualAuth');
    await sb.auth.signOut();
    window.location.href = 'index.html';
}

async function cargarDatos() {
    try {
        const [resA, resC] = await Promise.all([sb.from('activos').select('*'), sb.from('colaboradores').select('*')]);
        
        if(resA.error || resC.error) throw new Error("Error en DB");

        DB_ACTIVOS = resA.data ? resA.data.sort((a,b)=> new Date(b.created_at||0) - new Date(a.created_at||0)) : [];
        DB_COLABS = resC.data || [];
        
        document.getElementById('listaNombres').innerHTML = DB_COLABS.map(c=>`<option value="${c.nombre}">`).join('');
        
        // 1. CARGAR TABLAS PRIMERO
        renderTablaMaestra(); 
        renderPhoneTable(); 
        renderTablaHome(DB_ACTIVOS.slice(0,10), "ltimos Movimientos");

        // 2. LUEGO CARGAR DASHBOARD (KPIS)
        actualizarDashboard(); 
        
        // 3. INICIALIZAR REPORTES
        document.getElementById('chartsContainer').innerHTML = ''; // Limpiar
        addChart('estado', 'doughnut');
        addChart('tienda', 'bar');

    } catch(e) {
        console.error(e);
        showToast("Error al cargar datos. Recarga la p谩gina.", "error");
    }
}

// --- DASHBOARD (HOME) ---
function safeSetText(id, value) {
    const el = document.getElementById(id);
    if (el) el.innerText = value;
}

function actualizarDashboard() {
    const total = DB_ACTIVOS.length;
    const disp = DB_ACTIVOS.filter(a=>a.estado==='Disponible').length;
    const mant = DB_ACTIVOS.filter(a=>a.estado==='Mantenci贸n').length;
    const asig = DB_ACTIVOS.filter(a=>a.estado==='Asignado').length;
    const baja = DB_ACTIVOS.filter(a=>a.estado==='Baja').length;
    
    // CONTEO ESTRICTO (SOLO SI HAY DATA EN COLUMNAS ESPECFICAS)
    const cels = DB_ACTIVOS.filter(a => (a.marca_cel && a.marca_cel.trim().length > 1) || (a.imei_cel && a.imei_cel.trim().length > 1)).length;
    const sims = DB_ACTIVOS.filter(a => (a.imei_sim && a.imei_sim.trim().length > 1) || (a.numero && a.numero.trim().length > 1)).length;
    const pcs = DB_ACTIVOS.filter(a => a.marca && a.marca.trim().length > 1).length;
    
    let ces = 0; DB_ACTIVOS.forEach(a=>{ const c=DB_COLABS.find(x=>x.rut===a.rut_responsable); if(c && c.estado_contractual==='Cesado') ces++; });

    safeSetText('kpi-total', total);
    safeSetText('kpi-dispo', disp);
    safeSetText('kpi-mant', mant);
    safeSetText('kpi-asig', asig);
    safeSetText('kpi-baja', baja);
    safeSetText('kpi-pcs', pcs);
    safeSetText('kpi-cels', cels);
    safeSetText('kpi-sims', sims);
    safeSetText('kpi-cesados', ces);
}

function renderTablaHome(data, title) {
    safeSetText('homeTableTitle', title);
    const b = document.getElementById('lastMovesTable');
    if(!b) return;
    if(data.length === 0) { b.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px; color:#64748b;">No hay movimientos recientes</td></tr>'; return; }
    b.innerHTML = data.map(a => {
        const c = DB_COLABS.find(x => x.rut === a.rut_responsable) || { nombre: 'N/A' };
        return `<tr>
            <td><div class="click-name" onclick="verUser('${a.rut_responsable}')" style="font-size:13px;">${c.nombre}</div><div style="font-size:10px; color:#64748b">${a.rut_responsable}</div></td>
            <td><span style="font-size:10px; padding:2px 6px; border-radius:4px; font-weight:600; background:${a.estado==='Disponible'?'#dcfce7':(a.estado==='Mantenci贸n'?'#ffedd5':'#f1f5f9')}; color:${a.estado==='Disponible'?'#166534':(a.estado==='Mantenci贸n'?'#9a3412':'#334155')}">${a.estado}</span></td>
            <td><div style="font-weight:600; font-size:12px;">${a.ubicacion||'-'}</div><code style="font-size:10px; color:var(--primary)">${a.serie}</code></td>
        </tr>`;
    }).join('');
}
function resetHomeTable() { renderTablaHome(DB_ACTIVOS.slice(0,10), "ltimos Movimientos"); }

// --- REPORTES DINMICOS ---
let chartCounter = 0;
function addChart(defaultKey='estado', defaultType='bar') {
    chartCounter++;
    const id = `chart_${chartCounter}`;
    const container = document.getElementById('chartsContainer');
    const div = document.createElement('div');
    div.className = 'chart-card';
    div.innerHTML = `
        <div class="chart-header">
            <select class="chart-select" id="sel_key_${id}" onchange="updateDynamicChart('${id}')">
                <option value="estado" ${defaultKey==='estado'?'selected':''}>Por Estado</option>
                <option value="tienda" ${defaultKey==='tienda'?'selected':''}>Por Tienda</option>
                <option value="area" ${defaultKey==='area'?'selected':''}>Por rea</option>
                <option value="marca" ${defaultKey==='marca'?'selected':''}>Por Marca</option>
            </select>
            <select class="chart-select" id="sel_type_${id}" onchange="updateDynamicChart('${id}')">
                <option value="bar" ${defaultType==='bar'?'selected':''}>Barras</option>
                <option value="doughnut" ${defaultType==='doughnut'?'selected':''}>Dona</option>
                <option value="line" ${defaultType==='line'?'selected':''}>L铆nea</option>
            </select>
            <i class="fas fa-times btn-remove-chart" onclick="this.parentElement.parentElement.remove()"></i>
        </div>
        <div class="chart-canvas-container"><canvas id="${id}"></canvas></div>`;
    container.appendChild(div);
    updateDynamicChart(id);
}

function updateDynamicChart(id) {
    const ctx = document.getElementById(id).getContext('2d');
    const keyFilter = document.getElementById(`sel_key_${id}`).value;
    const typeFilter = document.getElementById(`sel_type_${id}`).value;
    const existing = Chart.getChart(id); if(existing) existing.destroy();

    const dataCounts = {};
    DB_ACTIVOS.forEach(a => {
        let key = 'N/A';
        if(keyFilter === 'estado') key = a.estado;
        else if(keyFilter === 'tienda') key = a.ubicacion;
        else if(keyFilter === 'marca') key = a.marca || a.marca_cel;
        else if(keyFilter === 'area') { const c = DB_COLABS.find(x=>x.rut===a.rut_responsable); key = c ? c.area : 'Sin Asignar'; }
        dataCounts[key] = (dataCounts[key] || 0) + 1;
    });

    const colors = ['#0066CC', '#E31837', '#22c55e', '#f59e0b', '#64748b', '#8b5cf6', '#ec4899'];
    new Chart(ctx, {
        type: typeFilter,
        data: { labels: Object.keys(dataCounts), datasets: [{ label: 'Cantidad', data: Object.values(dataCounts), backgroundColor: typeFilter==='bar' ? '#0066CC' : colors, borderWidth: 1 }] },
        options: { maintainAspectRatio: false, responsive: true, plugins: { legend: { display: typeFilter !== 'bar', position:'right' }, datalabels: { color: typeFilter==='bar'?'black':'white', font:{weight:'bold'}, anchor: typeFilter==='bar'?'end':'center', align: typeFilter==='bar'?'top':'center' } }, scales: { y: { beginAtZero: true, display: typeFilter==='bar' || typeFilter==='line' } } }
    });
}

// --- ESCUCHADORES (BSQUEDA Y SUGERENCIA DE CORREO) ---
function setupSearchListeners() {
    const m = document.getElementById('mainSearch'), p = document.getElementById('phoneSearch');
    if(m) m.addEventListener('input', renderTablaMaestra);
    if(p) p.addEventListener('input', renderPhoneTable);

    const inputNombre = document.getElementById('f_nombre');
    const inputRut = document.getElementById('f_rut');
    
    if(inputNombre) {
        inputNombre.addEventListener('input', () => {
            const val = inputNombre.value;
            const c = DB_COLABS.find(x => x.nombre === val);
            if(c) {
                document.getElementById('f_rut').value = c.rut;
                document.getElementById('f_correo').value = c.correo;
                setSelect('f_area', c.area);
            } else {
                const parts = val.trim().toLowerCase().split(/\s+/);
                const currentEmail = document.getElementById('f_correo').value;
                if (parts.length >= 2 && (currentEmail === '' || currentEmail.includes('@dominospizza.cl'))) {
                    const cleanName = parts[0].replace(/[^a-z0-9]/g, '');
                    const cleanLast = parts[1].replace(/[^a-z0-9]/g, '');
                    document.getElementById('f_correo').value = `${cleanName}.${cleanLast}@dominospizza.cl`;
                }
            }
        });
    }

    if(inputRut) {
        inputRut.addEventListener('blur', () => {
            inputRut.value = formatearRut(inputRut.value);
            const c = DB_COLABS.find(x => x.rut === inputRut.value);
            if(c) { 
                document.getElementById('f_nombre').value = c.nombre; 
                document.getElementById('f_correo').value = c.correo;
                setSelect('f_area', c.area);
            }
        });
    }
}

async function registrarMovimiento(serie, accion, descripcion) { try { await sb.from('historial_activos').insert({ serie, accion, descripcion, usuario_editor: currentUserEmail }); } catch(e) {} }
async function verHistorial(serie) {
    document.getElementById('modalHistorial').classList.remove('hidden'); document.getElementById('historialContent').innerHTML = 'Cargando...';
    const { data } = await sb.from('historial_activos').select('*').eq('serie', serie).order('created_at', { ascending: false });
    if(!data || !data.length) { document.getElementById('historialContent').innerHTML = '<p style="text-align:center;color:#64748b;">Sin historial.</p>'; return; }
    document.getElementById('historialContent').innerHTML = `<ul class="timeline">${data.map(h => `<li class="timeline-item"><div class="timeline-date">${new Date(h.created_at).toLocaleString()}</div><div class="timeline-content"><div style="font-weight:700; color:var(--primary)">${h.accion}</div><div style="font-size:12px;">${h.descripcion}</div><div style="font-size:10px; color:#94a3b8; margin-top:4px;">Por: ${h.usuario_editor||'Sistema'}</div></div></li>`).join('')}</ul>`;
}

function getActionButtons(serie) {
    const histBtn = `<button class="btn-icon btn-hist" title="Ver Historial" onclick="verHistorial('${serie}')"><i class="fas fa-history"></i></button>`;
    if (currentUserRole !== 'admin') return `<div class="action-group">${histBtn}</div>`;
    return `<div class="action-group"><button class="btn-icon btn-edit" title="Editar" onclick="editar('${serie}')"><i class="fas fa-edit"></i></button><button class="btn-icon btn-return" title="Devolver a Bodega" onclick="abrirDevolucion('${serie}')"><i class="fas fa-box-open"></i></button>${histBtn}<button class="btn-icon btn-delete" title="Eliminar Registro" onclick="eliminarActivo('${serie}')"><i class="fas fa-trash-alt"></i></button></div>`;
}

function renderPhoneTable() {
    const inputVal = document.getElementById('phoneSearch').value.toLowerCase();
    const b = document.getElementById('phoneTableBody');
    if(!b) return;
    const filtered = DB_ACTIVOS.filter(a => {
        const tieneData = (a.marca_cel && a.marca_cel.length > 1) || (a.imei_cel && a.imei_cel.length > 1) || (a.imei_sim && a.imei_sim.length > 1) || (a.numero && a.numero.length > 1);
        if (!tieneData) return false;
        const c = DB_COLABS.find(col => col.rut === a.rut_responsable) || { nombre: '' };
        return `${c.nombre} ${a.numero||''} ${a.imei_cel||''} ${a.imei_sim||''}`.toLowerCase().includes(inputVal);
    });
    b.innerHTML = filtered.length ? filtered.map(a => {
        const c = DB_COLABS.find(col => col.rut === a.rut_responsable) || { nombre: 'N/A', area: '-' };
        const marcaMostrar = a.marca_cel || a.marca || '-';
        return `<tr><td><div style="font-weight:700;">${c.nombre}</div><small style="color:#64748b">${c.area}</small></td><td><span style="font-weight:700; color:var(--primary);">${a.numero || '-'}</span></td><td>${marcaMostrar} ${a.modelo_cel||''}</td><td>${a.imei_cel || '-'}</td><td>${a.imei_sim || '-'}</td><td><div style="font-size:11px; max-width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${a.observaciones || ''}</div></td><td>${getActionButtons(a.serie)}</td></tr>`;
    }).join('') : '<tr><td colspan="7" style="text-align:center; padding:20px; color:#64748b;">No hay registros</td></tr>';
}

function renderTablaMaestra() {
    const s = document.getElementById('mainSearch').value.toLowerCase();
    const b = document.getElementById('masterTableBody');
    if(!b) return;
    const filtered = DB_ACTIVOS.filter(a => {
        const c = DB_COLABS.find(col => col.rut === a.rut_responsable) || { nombre: '' };
        return `${a.serie} ${c.nombre} ${a.rut_responsable} ${a.ubicacion}`.toLowerCase().includes(s);
    }).sort((a, b) => (a.rut_responsable || '').localeCompare(b.rut_responsable || ''));

    b.innerHTML = filtered.length ? filtered.map(a => {
        const c = DB_COLABS.find(col => col.rut === a.rut_responsable) || { nombre: 'N/A', estado_contractual: 'Vigente' };
        return `<tr><td style="color:#64748b">${a.rut_responsable}</td><td class="click-name" onclick="verUser('${a.rut_responsable}')">${c.nombre}</td><td>${a.estado}</td><td style="color:${c.estado_contractual==='Cesado'?'#b91c1c':'#166534'}; font-weight:700;">${c.estado_contractual||'Vigente'}</td><td>${c.area}</td><td>${a.ubicacion}</td><td>${a.marca} ${a.modelo}</td><td><code style="color:var(--primary); font-weight:600;">${a.serie}</code></td><td>${getActionButtons(a.serie)}</td></tr>`;
    }).join('') : '<tr><td colspan="9" style="text-align:center; padding:20px; font-style:italic; color:#64748b;">No se encontraron resultados</td></tr>';
}

function abrirDevolucion(serie) { currentSerieDevolucion = serie; document.getElementById('dev_serie').innerText = serie; document.getElementById('dev_obs').value = ''; document.getElementById('modalDevolucion').classList.remove('hidden'); }

// --- LGICA DE TRAZABILIDAD (NUEVA) ---
async function procesarDevolucion() {
    if (!currentSerieDevolucion) return;
    const nuevoEstado = document.getElementById('dev_estado').value;
    const nuevaUbicacion = document.getElementById('dev_ubicacion').value;
    const obs = document.getElementById('dev_obs').value;

    try {
        // 1. Obtener due帽o anterior antes de cambiar
        const assetAnterior = DB_ACTIVOS.find(a => a.serie === currentSerieDevolucion);
        const nombreAnterior = assetAnterior ? (DB_COLABS.find(c => c.rut === assetAnterior.rut_responsable)?.nombre || 'Desconocido') : 'Desconocido';

        // 2. Realizar Devoluci贸n
        const { error } = await sb.from('activos').update({
            rut_responsable: '9.999.999-9', // Bodega Inform谩tica
            estado: nuevoEstado,
            ubicacion: nuevaUbicacion,
            observaciones: obs ? `DEVOLUCIN: ${obs}` : 'Devuelto a bodega'
        }).eq('serie', currentSerieDevolucion);

        if (error) throw error;
        
        // 3. Registrar con Detalle
        registrarMovimiento(currentSerieDevolucion, 'Devoluci贸n', `Devuelto por: ${nombreAnterior} -> A: ${nuevaUbicacion}. Estado: ${nuevoEstado}`);
        
        showToast("Devoluci贸n procesada correctamente");
        document.getElementById('modalDevolucion').classList.add('hidden');
        cargarDatos();
    } catch (e) { showToast("Error: " + e.message, "error"); }
}

async function eliminarActivo(serie) {
    if(!confirm("驴Eliminar permanentemente?")) return;
    try { await sb.from('activos').delete().eq('serie', serie); registrarMovimiento(serie, 'Eliminaci贸n', 'Registro borrado'); showToast("Eliminado"); cargarDatos(); } catch (e) { showToast("Error", "error"); }
}

function nuevoRegistro() {
    document.querySelectorAll('#modalFicha input').forEach(i => { i.value = ''; i.classList.remove('error-input'); });
    document.querySelectorAll('#modalFicha select').forEach(s => s.selectedIndex = 0);
    document.getElementById('sw_equipo').checked = false; document.getElementById('sw_sim').checked = false; toggleTelefonia(); document.getElementById('modalFicha').classList.remove('hidden');
}
function editar(serie) {
    const a = DB_ACTIVOS.find(x=>x.serie===serie); if(!a) return;
    const c = DB_COLABS.find(x=>x.rut===a.rut_responsable) || {};
    document.getElementById('f_rut').value = a.rut_responsable; document.getElementById('f_nombre').value = c.nombre||''; document.getElementById('f_correo').value = c.correo||'';
    setSelect('f_area', c.area); setSelect('f_tienda', a.ubicacion); setSelect('f_contractual', c.estado_contractual); setSelect('f_estado', a.estado);
    document.getElementById('f_marca').value = a.marca; document.getElementById('f_modelo').value = a.modelo; document.getElementById('f_serie').value = a.serie;
    document.getElementById('f_fecha_ent').value = a.fecha_entrega; document.getElementById('f_ent_it').value = a.entrega_it || ''; document.getElementById('f_obs').value = a.observaciones || '';
    document.getElementById('sw_equipo').checked = !!a.marca_cel; document.getElementById('sw_sim').checked = !!a.imei_sim;
    document.getElementById('f_numero').value = a.numero || ''; document.getElementById('f_mar_cel').value = a.marca_cel || ''; document.getElementById('f_mod_cel').value = a.modelo_cel || ''; document.getElementById('f_imei').value = a.imei_cel || ''; document.getElementById('f_imsi').value = a.imei_sim || '';
    toggleTelefonia(); document.getElementById('modalFicha').classList.remove('hidden');
}

async function guardarTodoSincronizado() {
    const btn = document.getElementById('btnSave'); 
    const rut = document.getElementById('f_rut').value.trim(); 
    const serie = document.getElementById('f_serie').value.trim();
    const nombreUsuario = document.getElementById('f_nombre').value;

    if(!rut || !serie) return showToast("Faltan datos", "error");
    btn.innerText = "PROCESANDO..."; btn.disabled = true;

    // --- LGICA DE TRAZABILIDAD ---
    // Buscar due帽o anterior en memoria antes de sobrescribir
    const assetAnterior = DB_ACTIVOS.find(a => a.serie === serie);
    let accionHistorial = 'Edici贸n';
    let descHistorial = `Datos actualizados por ${currentUserEmail}`;

    if (!assetAnterior) {
        accionHistorial = 'Alta';
        descHistorial = `Equipo nuevo ingresado. Asignado a: ${nombreUsuario}`;
    } else if (assetAnterior.rut_responsable !== rut) {
        const nombreAnterior = (DB_COLABS.find(c => c.rut === assetAnterior.rut_responsable)?.nombre || 'Bodega/Sin Asignar');
        accionHistorial = 'Transferencia';
        descHistorial = `Reasignado: De ${nombreAnterior} -> A ${nombreUsuario}`;
    }

    const colab = { rut, nombre: nombreUsuario, correo: document.getElementById('f_correo').value, area: document.getElementById('f_area').value, estado_contractual: document.getElementById('f_contractual').value };
    const activo = { serie, rut_responsable: rut, marca: document.getElementById('f_marca').value, modelo: document.getElementById('f_modelo').value, estado: document.getElementById('f_estado').value, ubicacion: document.getElementById('f_tienda').value, fecha_entrega: document.getElementById('f_fecha_ent').value, entrega_it: document.getElementById('f_ent_it').value, observaciones: document.getElementById('f_obs').value, numero: document.getElementById('f_numero').value, marca_cel: document.getElementById('sw_equipo').checked ? document.getElementById('f_mar_cel').value : null, modelo_cel: document.getElementById('sw_equipo').checked ? document.getElementById('f_mod_cel').value : null, imei_cel: document.getElementById('sw_equipo').checked ? document.getElementById('f_imei').value : null, imei_sim: document.getElementById('sw_sim').checked ? document.getElementById('f_imsi').value : null };
    
    try { 
        await sb.from('colaboradores').upsert(colab, {onConflict:'rut'}); 
        await sb.from('activos').upsert(activo, {onConflict:'serie'}); 
        
        // Registrar Historial
        registrarMovimiento(serie, accionHistorial, descHistorial);
        
        showToast("Guardado correctamente"); cerrarFicha(); cargarDatos(); 
    } catch(e) { showToast("Error", "error"); } finally { btn.innerText = "GUARDAR"; btn.disabled = false; }
}

function verUser(rut) {
    const c = DB_COLABS.find(x => x.rut === rut); if(!c) return;
    const activos = DB_ACTIVOS.filter(x => x.rut_responsable === rut);
    const html = `<div class="user-header"><div class="user-avatar">${c.nombre.charAt(0)}</div><div><h3 style="margin:0; font-size:20px;">${c.nombre}</h3><p style="color:#64748b;">${c.rut} | ${c.area}</p></div></div><h4 style="color:var(--primary);">Equipos (${activos.length})</h4><ul class="asset-list">${activos.map(a=>`<li class="asset-item"><div class="asset-detail-row"><div><strong>${a.marca} ${a.modelo}</strong></div><code style="color:var(--primary)">${a.serie}</code></div>${a.marca_cel?`<div class="separator"></div><div class="asset-detail-row"><div>Cel: ${a.marca_cel}</div><small>IMEI: ${a.imei_cel}</small></div>`:''}<div style="text-align:right;"><span class="role-badge badge-viewer">${a.estado}</span></div></li>`).join('')}</ul>`;
    document.getElementById('userProfileContent').innerHTML = html; document.getElementById('modalVerUsuario').classList.remove('hidden');
}

// UTILS
function procesarCSV() { const f = document.getElementById('csvFile').files[0]; if(!f) return showToast("Sin archivo", "error"); const r = new FileReader(); r.readAsText(f); r.onload = (e) => { const l = e.target.result.split(/\r?\n/); l.forEach(line => { /* L贸gica CSV */ }); showToast("Carga CSV iniciada"); cargarDatos(); }; }
function setSelect(id, val) { const el = document.getElementById(id); if(el) el.value = val; }
function toggleTelefonia() { const eq = document.getElementById('sw_equipo').checked; const sim = document.getElementById('sw_sim').checked; ['f_mar_cel', 'f_mod_cel', 'f_imei'].forEach(id => { const el = document.getElementById(id); el.disabled = !eq; el.classList.toggle('disabled-field', !eq); if(!eq) el.value = ""; }); const simEl = document.getElementById('f_imsi'); simEl.disabled = !sim; simEl.classList.toggle('disabled-field', !sim); if(!sim) simEl.value = ""; }
function setupListeners() {
    const ir = document.getElementById('f_rut'), iname = document.getElementById('f_nombre');
    ir.addEventListener('blur', () => { const c = DB_COLABS.find(x => x.rut === ir.value); if(c) { document.getElementById('f_nombre').value = c.nombre; setSelect('f_area', c.area); } });
    iname.addEventListener('input', () => {
        const c = DB_COLABS.find(x => x.nombre === iname.value);
        if(c) {
            ir.value = c.rut;
            document.getElementById('f_correo').value = c.correo;
            setSelect('f_area', c.area);
        } else {
            const parts = iname.value.trim().toLowerCase().split(/\s+/);
            const currentEmail = document.getElementById('f_correo').value;
            if (parts.length >= 2 && (currentEmail === '' || currentEmail.includes('@dominospizza.cl'))) {
                const cleanName = parts[0].replace(/[^a-z0-9]/g, '');
                const cleanLast = parts[1].replace(/[^a-z0-9]/g, '');
                document.getElementById('f_correo').value = `${cleanName}.${cleanLast}@dominospizza.cl`;
            }
        }
    });
}
function formatearRut(rut) { if(!rut) return ''; let v = rut.replace(/\./g, '').replace(/-/g, '').toLowerCase().trim(); if (v.length < 2) return v; return v.slice(0, -1).replace(/\B(?=(\d{3})+(?!\d))/g, ".") + "-" + v.slice(-1); }
function formatearFechaCSV(str) { if(!str) return null; const p = str.split(/[\/-]/); return (p.length === 3 && p[2].length === 4) ? `${p[2]}-${p[1]}-${p[0]}` : str; }
function showView(v) { document.querySelectorAll('.content-area > div').forEach(d=>d.classList.add('hidden')); document.getElementById('view-'+v).classList.remove('hidden'); document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); if(v==='telephony') document.getElementById('btn-phone').classList.add('active'); if(v==='home') document.getElementById('btn-home').classList.add('active'); if(v==='inventory') document.getElementById('btn-inv').classList.add('active'); if(v==='metrics') document.getElementById('btn-metrics').classList.add('active'); }
function abrirFicha() { document.getElementById('modalFicha').classList.remove('hidden'); setupListeners(); }
function cerrarFicha() { document.getElementById('modalFicha').classList.add('hidden'); }

initSystem();
</script>
</body>
</html>
