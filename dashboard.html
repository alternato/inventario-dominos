<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - TI Maestro v75.0</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { --primary: #0066CC; --secondary: #E31837; --success: #22c55e; --warning: #f59e0b; --bg: #f8fafc; --border: #e2e8f0; --dark: #0f172a; --radius: 12px; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); height: 100vh; display: flex; font-size: 13px; overflow: hidden; }
        
        #sidebar { width: 260px; background: linear-gradient(180deg, var(--primary) 0%, #0052a3 100%); color: white; padding: 25px; display: flex; flex-direction: column; flex-shrink: 0; }
        .logo-img { width: 120px; height: auto; margin-bottom: 30px; align-self: center; filter: drop-shadow(0 0 5px rgba(255,255,255,0.2)); }
        .nav-btn { background: rgba(255,255,255,0.1); color: white; border: none; padding: 12px 15px; border-radius: 8px; width: 100%; margin-bottom: 8px; text-align: left; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; }
        .nav-btn:hover { background: rgba(255,255,255,0.2); }
        .nav-btn.active { background: var(--secondary); font-weight: 700; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        .main-container { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        header { background: white; padding: 18px 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .content-area { padding: 25px; overflow-y: auto; flex-grow: 1; }
        
        /* --- HOME: KPIs & TABLA --- */
        .kpi-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: white; padding: 25px; border-radius: var(--radius); border: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; text-align: center; gap: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); transition: transform 0.2s; }
        .kpi-card:hover { transform: translateY(-3px); border-color: var(--primary); }
        .kpi-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; color: white; margin-bottom: 5px; }
        .kpi-number { font-size: 32px; font-weight: 800; color: var(--dark); margin: 0; line-height: 1; }
        .kpi-label { font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }

        .home-table-section { background: white; border-radius: var(--radius); border: 1px solid var(--border); display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; height: calc(100vh - 280px); }
        .home-table-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #f8fafc; }
        
        /* --- REPORTES: CONTROLES --- */
        .metrics-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .control-card { background: white; padding: 20px; border-radius: var(--radius); border: 1px solid var(--border); }
        .chart-selector { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 15px; font-weight: 600; color: var(--dark); }
        .chart-display { height: 350px; position: relative; }

        /* TABLAS GENERALES */
        .table-wrapper { background: white; border-radius: var(--radius); border: 1px solid var(--border); display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; }
        .table-scroll { overflow: auto; width: 100%; height: 100%; }
        table { width: 100%; border-collapse: collapse; table-layout: auto; }
        th { background: #f1f5f9; padding: 12px; text-align: left; position: sticky; top: 0; z-index: 10; font-size: 11px; text-transform: uppercase; border-bottom: 2px solid var(--border); white-space: nowrap; color: #64748b; font-weight: 700; }
        td { padding: 10px 12px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; color: #334155; }
        tr:hover td { background-color: #f8fafc; }

        .csv-panel { background: #fff; border: 2px dashed var(--primary); padding: 15px; border-radius: var(--radius); margin-bottom: 20px; align-items: center; gap: 20px; }

        /* ACTIONS */
        .action-group { display: flex; gap: 5px; }
        .btn-icon { border: none; background: none; cursor: pointer; font-size: 14px; transition: 0.2s; padding: 6px; border-radius: 4px; }
        .btn-edit { color: var(--primary); background: #e0f2fe; }
        .btn-return { color: var(--warning); background: #fef3c7; }
        .btn-hist { color: #64748b; background: #f1f5f9; } .btn-hist:hover { background: #cbd5e1; color: var(--dark); }
        .btn-delete { color: var(--secondary); background: #fee2e2; }

        /* TIMELINE */
        .timeline { list-style: none; padding: 0; margin-top: 10px; }
        .timeline-item { border-left: 2px solid #e2e8f0; padding-left: 20px; margin-bottom: 20px; position: relative; }
        .timeline-item::before { content: ''; position: absolute; left: -6px; top: 0; width: 10px; height: 10px; border-radius: 50%; background: var(--primary); }
        .timeline-date { font-size: 10px; color: #94a3b8; font-weight: 700; }
        .timeline-content { background: #f8fafc; padding: 10px; border-radius: 8px; margin-top: 5px; border: 1px solid #e2e8f0; }

        /* TOAST */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-left: 5px solid; display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s ease-out; font-weight: 600; }
        .toast.success { border-color: var(--success); } .toast.error { border-color: var(--secondary); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* UTILS & MODAL */
        .hidden { display: none !important; }
        .admin-only { display: none !important; }
        body.role-admin .admin-only { display: flex !important; }
        .role-badge { font-size: 10px; padding: 2px 8px; border-radius: 12px; text-transform: uppercase; font-weight: 800; margin-left: 10px; }
        .badge-viewer { background: #f1f5f9; color: #64748b; border: 1px solid #cbd5e1; }
        .badge-admin { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .modal { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(2px); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 95%; max-width: 1100px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .form-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .field { display: flex; flex-direction: column; gap: 5px; }
        .field label { font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; }
        input, select, textarea { padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; transition: 0.2s; }
        input:focus, select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(0,102,204,0.1); }
        .section-tag { grid-column: span 4; color: var(--primary); font-weight: 800; border-bottom: 2px solid #f1f5f9; padding-bottom: 5px; margin: 20px 0 10px 0; font-size: 12px; }
        .switch-box { display: flex; align-items: center; gap: 10px; background: #f8fafc; padding: 8px 12px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .toggle { position: relative; display: inline-block; width: 36px; height: 20px; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #cbd5e1; transition: .3s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(16px); }
        .disabled-field { background-color: #f1f5f9 !important; color: #94a3b8 !important; cursor: not-allowed !important; }
        .click-name { cursor: pointer; color: var(--primary); font-weight: 700; text-decoration: none; border-bottom: 1px dotted var(--primary); }
        .user-header { display: flex; align-items: center; gap: 20px; margin-bottom: 25px; border-bottom: 1px solid #e2e8f0; padding-bottom: 20px; }
        .user-avatar { width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 26px; font-weight: 700; }
        .asset-list { list-style: none; padding: 0; }
        .asset-item { border: 1px solid #e2e8f0; margin-bottom: 10px; border-radius: 8px; background: #fff; padding: 15px; }
        .asset-detail-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .asset-icon { width: 24px; text-align: center; display: inline-block; margin-right: 8px; color: var(--primary); }
        .separator { border-top: 1px dashed #e2e8f0; margin: 8px 0; }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <aside id="sidebar">
        <img src="https://logos-world.net/wp-content/uploads/2021/08/Dominos-Logo.png" class="logo-img">
        <button class="nav-btn active" id="btn-home" onclick="showView('home')"><i class="fas fa-home"></i> Inicio</button>
        <button class="nav-btn" id="btn-inv" onclick="showView('inventory')"><i class="fas fa-boxes"></i> Inventario Data</button>
        <button class="nav-btn" id="btn-phone" onclick="showView('telephony')"><i class="fas fa-mobile-alt"></i> Telefon铆a</button>
        <button class="nav-btn" id="btn-metrics" onclick="showView('metrics')"><i class="fas fa-chart-pie"></i> Reportes TI</button>
        <hr style="margin: 20px 0; opacity: 0.2;">
        <button class="nav-btn admin-only" style="background: var(--success);" onclick="nuevoRegistro()"><i class="fas fa-plus-circle"></i> NUEVO REGISTRO</button>
        <button class="nav-btn" style="background: rgba(0,0,0,0.3); margin-top: auto;" onclick="cerrarSesion()"><i class="fas fa-sign-out-alt"></i> Salir</button>
    </aside>

    <main class="main-container">
        <header>
            <h2 id="viewTitle">Dashboard General</h2>
            <div id="sync" style="font-size: 12px; color: #334155; font-weight: 600; display:flex; align-items:center;">
                <span id="userEmail" style="margin-right: 5px;">Cargando...</span>
                <span id="userRoleBadge" class="role-badge badge-viewer">...</span>
            </div>
        </header>
        
        <div class="content-area">
            
            <div id="view-home">
                <div class="kpi-grid">
                    <div class="kpi-card"><div class="kpi-icon" style="background: var(--dark);"><i class="fas fa-laptop"></i></div><h3 id="kpi-total" class="kpi-number">0</h3><span class="kpi-label">Total Activos</span></div>
                    <div class="kpi-card"><div class="kpi-icon" style="background: var(--primary);"><i class="fas fa-user-check"></i></div><h3 id="kpi-asig" class="kpi-number">0</h3><span class="kpi-label">Asignados</span></div>
                    <div class="kpi-card"><div class="kpi-icon" style="background: var(--success);"><i class="fas fa-box-open"></i></div><h3 id="kpi-dispo" class="kpi-number">0</h3><span class="kpi-label">Disponibles</span></div>
                    <div class="kpi-card"><div class="kpi-icon" style="background: var(--warning);"><i class="fas fa-tools"></i></div><h3 id="kpi-mant" class="kpi-number">0</h3><span class="kpi-label">En Mantenci贸n</span></div>
                    <div class="kpi-card"><div class="kpi-icon" style="background: var(--secondary);"><i class="fas fa-user-slash"></i></div><h3 id="kpi-cesados" class="kpi-number">0</h3><span class="kpi-label">Eq. en Cesados</span></div>
                </div>

                <div class="home-table-section">
                    <div class="home-table-header">
                        <h4 style="color: var(--primary); margin: 0; font-size: 16px;"><i class="fas fa-history"></i> ltimos Movimientos</h4>
                        <button onclick="resetHomeTable()" style="font-size: 11px; background: white; border: 1px solid #cbd5e1; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight:600;">Actualizar</button>
                    </div>
                    <div class="table-scroll">
                        <table style="width: 100%;">
                            <thead><tr><th style="width: 35%;">Nombre / RUT</th><th style="width: 25%;">Estado</th><th style="width: 40%;">Ubicaci贸n / Serie</th></tr></thead>
                            <tbody id="lastMovesTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-inventory" class="hidden">
                <div class="csv-panel admin-only">
                    <div><label style="display:block; font-size:10px; font-weight:800; color:var(--primary); margin-bottom:5px;">CARGA MASIVA CSV</label><input type="file" id="csvFile" accept=".csv"></div>
                    <button onclick="procesarCSV()" id="btnCsv" class="nav-btn" style="width:auto; background:var(--dark); margin:0; padding: 8px 16px;"><i class="fas fa-upload"></i> PROCESAR</button>
                </div>
                <input type="search" id="mainSearch" placeholder=" Buscar por RUT, Nombre, Serie, Tienda..." style="width: 100%; margin-bottom: 15px; padding: 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px; font-family:'Inter';" autocomplete="off">
                <div class="table-wrapper">
                    <div class="table-scroll">
                        <table>
                            <thead><tr><th>RUT</th><th>Responsable</th><th>Estado</th><th>Contrato</th><th>rea</th><th>Tienda</th><th>Modelo</th><th>Serie</th><th class="admin-only">Acciones</th></tr></thead>
                            <tbody id="masterTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-telephony" class="hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: var(--primary);">Gesti贸n de L铆neas y Equipos M贸viles</h3>
                    <input type="search" id="phoneSearch" placeholder=" Buscar tel茅fono, IMEI, Usuario..." style="padding: 10px; border-radius: 8px; border: 1px solid var(--border); width: 300px;">
                </div>
                <div class="table-wrapper">
                    <div class="table-scroll">
                        <table>
                            <thead><tr><th>Usuario / Cargo</th><th>N煤mero</th><th>Equipo</th><th>IMEI</th><th>SIM (IMSI)</th><th>Observaciones</th><th class="admin-only">Acciones</th></tr></thead>
                            <tbody id="phoneTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-metrics" class="hidden">
                <div class="metrics-controls">
                    <div class="control-card">
                        <label style="display:block; margin-bottom:5px; font-weight:700;">Gr谩fico 1: Distribuci贸n</label>
                        <select id="chart1_filter" class="chart-selector" onchange="updateCharts()">
                            <option value="estado">Por Estado del Equipo</option>
                            <option value="tienda">Por Ubicaci贸n / Tienda</option>
                            <option value="area">Por rea del Usuario</option>
                            <option value="marca">Por Marca de Equipo</option>
                        </select>
                        <div class="chart-display"><canvas id="dynamicChart1"></canvas></div>
                    </div>
                    <div class="control-card">
                        <label style="display:block; margin-bottom:5px; font-weight:700;">Gr谩fico 2: Resumen</label>
                        <select id="chart2_filter" class="chart-selector" onchange="updateCharts()">
                            <option value="area">Por rea</option>
                            <option value="estado">Por Estado</option>
                            <option value="marca">Por Marca</option>
                        </select>
                        <div class="chart-display"><canvas id="dynamicChart2"></canvas></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="modalFicha" class="modal hidden">
        <div class="modal-content">
            <h2 style="color: var(--primary); margin-bottom: 20px;">Ficha T茅cnica</h2>
            <div class="form-grid">
                <div class="section-tag">1. Colaborador</div>
                <div class="field"><label>RUT *</label><input type="text" id="f_rut" placeholder="Ej: 11.222.333-k"></div>
                <div class="field" style="grid-column: span 2;"><label>Nombre Completo</label><input type="text" id="f_nombre" list="listaNombres"><datalist id="listaNombres"></datalist></div>
                <div class="field"><label>Correo</label><input type="email" id="f_correo"></div>
                <div class="field"><label>rea</label><select id="f_area"><option>Operaciones</option><option>Inform谩tica</option><option>Administraci贸n</option><option>Marketing</option><option>Log铆stica</option><option>Finanzas</option><option>RRHH</option></select></div>
                <div class="field"><label>Tienda / Ubicaci贸n</label><select id="f_tienda"></select></div>
                <div class="field"><label>Contrato</label><select id="f_contractual"><option>Vigente</option><option>Cesado</option></select></div>

                <div class="section-tag">2. Equipo PC</div>
                <div class="field"><label>Marca PC</label><input type="text" id="f_marca"></div>
                <div class="field"><label>Modelo PC</label><input type="text" id="f_modelo"></div>
                <div class="field"><label>Serie PC *</label><input type="text" id="f_serie"></div>
                <div class="field"><label>Estado Asignaci贸n</label><select id="f_estado"><option>Asignado</option><option>Disponible</option><option>Mantenci贸n</option><option>Baja</option></select></div>
                
                <div class="section-tag">3. Telefon铆a M贸vil</div>
                <div class="switch-box"><label class="toggle"><input type="checkbox" id="sw_equipo" onchange="toggleTelefonia()"><span class="slider"></span></label><span>Equipo Celular</span></div>
                <div class="switch-box"><label class="toggle"><input type="checkbox" id="sw_sim" onchange="toggleTelefonia()"><span class="slider"></span></label><span>SIM Card</span></div>
                <div class="field"><label>N煤mero Telef贸nico</label><input type="text" id="f_numero" placeholder="+569..."></div>
                <div class="field"><label>Marca Cel</label><input type="text" id="f_mar_cel" class="disabled-field" disabled></div>
                <div class="field"><label>Modelo Cel</label><input type="text" id="f_mod_cel" class="disabled-field" disabled></div>
                <div class="field"><label>IMEI Equipo</label><input type="text" id="f_imei" class="disabled-field" disabled></div>
                <div class="field"><label>IMSI (SIM)</label><input type="text" id="f_imsi" class="disabled-field" disabled></div>

                <div class="section-tag">4. Control & Auditor铆a</div>
                <div class="field"><label>Fecha Entrega</label><input type="date" id="f_fecha_ent"></div>
                <div class="field"><label>Entregado Por (IT)</label><input type="text" id="f_ent_it"></div>
                <div class="field" style="grid-column: span 2;"><label>Observaciones</label><input type="text" id="f_obs"></div>
            </div>
            <div style="margin-top: 25px; text-align: right; border-top: 1px solid #f1f5f9; padding-top: 20px;">
                <button onclick="cerrarFicha()" style="padding:10px 20px; border:none; background:#f1f5f9; color:#64748b; cursor:pointer; border-radius:6px; margin-right: 10px; font-weight:600;">Cancelar</button>
                <button onclick="guardarTodoSincronizado()" id="btnSave" style="padding:10px 25px; border:none; background:var(--primary); color:white; font-weight:700; cursor:pointer; border-radius:6px;">GUARDAR</button>
            </div>
        </div>
    </div>

    <div id="modalDevolucion" class="modal hidden" style="z-index: 1200;">
        <div class="modal-content" style="max-width: 500px;">
            <h3 style="color: var(--warning); margin-bottom: 15px;"><i class="fas fa-box-open"></i> Devoluci贸n a Bodega</h3>
            <p style="margin-bottom: 20px;">El equipo serie <strong id="dev_serie"></strong> ser谩 asignado a <strong>INFORMATICA</strong>.</p>
            <div class="field" style="margin-bottom: 15px;"><label>Nuevo Estado</label><select id="dev_estado"><option value="Disponible">Disponible (Stock)</option><option value="Mantenci贸n">A Mantenci贸n</option><option value="Baja">Dar de Baja</option></select></div>
            <div class="field" style="margin-bottom: 15px;"><label>Nueva Ubicaci贸n</label><select id="dev_ubicacion"><option>Bodega Central</option><option>Casa Matriz</option><option>Soporte IT</option></select></div>
            <div class="field" style="margin-bottom: 20px;"><label>Observaciones</label><textarea id="dev_obs" rows="3" placeholder="Ej: Pantalla con rayas..."></textarea></div>
            <div style="text-align: right;"><button onclick="document.getElementById('modalDevolucion').classList.add('hidden')" style="padding:10px 20px; border:none; background:#f1f5f9; cursor:pointer; border-radius:6px; margin-right:10px;">Cancelar</button><button onclick="procesarDevolucion()" style="padding:10px 20px; border:none; background:var(--warning); color:#fff; font-weight:700; cursor:pointer; border-radius:6px;">CONFIRMAR</button></div>
        </div>
    </div>

    <div id="modalHistorial" class="modal hidden" style="z-index: 1300;">
        <div class="modal-content" style="max-width: 600px;">
            <h3 style="color: var(--dark); margin-bottom: 15px;">Historial de Trazabilidad</h3>
            <div id="historialContent" style="max-height: 400px; overflow-y: auto;">Cargando...</div>
            <div style="text-align: right; margin-top: 20px;"><button onclick="document.getElementById('modalHistorial').classList.add('hidden')" style="padding:8px 20px; border:none; background:#f1f5f9; cursor:pointer; border-radius:6px;">Cerrar</button></div>
        </div>
    </div>

    <div id="modalVerUsuario" class="modal hidden" style="z-index: 1100;">
        <div class="modal-content" style="max-width: 600px;">
            <div id="userProfileContent"></div>
            <div style="text-align: right; margin-top: 20px;"><button onclick="document.getElementById('modalVerUsuario').classList.add('hidden')" style="background:var(--dark); color:white; padding:8px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:600;">Cerrar</button></div>
        </div>
    </div>

<script>
if(typeof ChartDataLabels!=='undefined') Chart.register(ChartDataLabels);
const CONFIG = { URL: "https://ivjwxvhixrskraepqzse.supabase.co", KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2and4dmhpeHJza3JhZXBxenNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MjgxNTgsImV4cCI6MjA4NDUwNDE1OH0.QzgNSwqf6VTXZjGMXOAfUnjW4f1mJcRqECxxNnLZc-o" };
let sb; try { sb = window.supabase.createClient(CONFIG.URL, CONFIG.KEY); } catch(e) { console.error(e); }

const TIENDAS = [ "Antofagasta - Estadio Regional", "Antofagasta - Sector Norte", "Arica", "Buin", "Bustamante", "Calama", "Chiguayante", "Chill谩n", "Concepcion - Plaza Acevedo", "Conc贸n", "Copiap贸", "Curic贸", "Froilan Roa", "General Velasquez", "Gran Avenida", "Hualp茅n", "Iquique", "Irarr谩zaval", "La Florida (Santa Amalia)", "La Serena (Balmaceda)", "Lautaro", "Luis Pasteur", "Machal铆", "Macul", "Maipu 1", "Mall del Centro*", "Mall Paseo Los Dominicos", "Manuel Montt", "Osorno 2 Centro", "Osorno 1 Rahue", "Parque Angamos", "Pedro Fontova", "Pe帽alol茅n", "Plaza Atenas", "Pto. Montt 2 (Cardonal)", "Pto. Montt 1 (Ejercito)", "Puente Alto", "Punta Arenas", "Quilicura", "Quilpu茅", "Recoleta", "San Francisco", "San Pedro de la Paz", "Santa Ana", "La Serena (B. Universitario)", "Talca", "Temuco", "Tobalaba", "Vi帽a del Mar", "Commisary" ];

let DB_ACTIVOS = [], DB_COLABS = [], charts = {}, currentUserRole = 'viewer', currentUserEmail = '';
let currentSerieDevolucion = null;

function showToast(msg, type='success') {
    const d = document.createElement('div'); d.className = `toast ${type}`;
    d.innerHTML = `<i class="fas fa-${type==='success'?'check-circle':'exclamation-circle'}"></i> ${msg}`;
    document.getElementById('toast-container').appendChild(d);
    setTimeout(() => d.remove(), 3000);
}

// --- SYSTEM START ---
function initSystem() {
    if(localStorage.getItem('manualAuth') === 'true') { loadApp("Admin Local", "admin"); return; }
    sb.auth.getSession().then(({ data: { session } }) => {
        if (!session) window.location.href = 'index.html'; else checkUserRole(session.user.email);
    });
}

async function checkUserRole(email) {
    let role = 'viewer';
    try { const { data } = await sb.from('user_roles').select('role').eq('email', email).single(); if(data) role = data.role; } catch(e) {}
    loadApp(email, role);
}

function loadApp(email, role) {
    currentUserEmail = email;
    document.getElementById('userEmail').innerText = email;
    currentUserRole = role;
    const badge = document.getElementById('userRoleBadge');
    if(role === 'admin') {
        document.body.classList.add('role-admin');
        badge.className = 'role-badge badge-admin'; badge.innerText = 'ADMINISTRADOR';
    } else {
        document.body.classList.remove('role-admin');
        badge.className = 'role-badge badge-viewer'; badge.innerText = 'VISUALIZADOR';
    }
    const storeOptions = TIENDAS.map(t=>`<option>${t}</option>`).join('');
    document.getElementById('f_tienda').innerHTML = storeOptions;
    document.getElementById('dev_ubicacion').innerHTML = `<option>Bodega Central</option><option>Soporte IT</option>${storeOptions}`;
    
    // Iniciar escuchadores de b煤squeda
    setupSearchListeners();
    cargarDatos();
}

async function cerrarSesion() {
    localStorage.removeItem('manualAuth');
    await sb.auth.signOut();
    window.location.href = 'index.html';
}

// --- DATA FETCH ---
async function cargarDatos() {
    const [resA, resC] = await Promise.all([sb.from('activos').select('*'), sb.from('colaboradores').select('*')]);
    if(resA.data) DB_ACTIVOS = resA.data.sort((a,b)=> new Date(b.created_at||0) - new Date(a.created_at||0));
    if(resC.data) DB_COLABS = resC.data;
    document.getElementById('listaNombres').innerHTML = DB_COLABS.map(c=>`<option value="${c.nombre}">`).join('');
    
    actualizarDashboard(); 
    renderTablaMaestra(); 
    renderPhoneTable(); 
    updateCharts(); // Inicializar gr谩ficos din谩micos
}

// --- DASHBOARD (HOME) ---
function actualizarDashboard() {
    const total = DB_ACTIVOS.length;
    const disp = DB_ACTIVOS.filter(a=>a.estado==='Disponible').length;
    const mant = DB_ACTIVOS.filter(a=>a.estado==='Mantenci贸n').length;
    const asig = DB_ACTIVOS.filter(a=>a.estado==='Asignado').length;
    let ces = 0; DB_ACTIVOS.forEach(a=>{ const c=DB_COLABS.find(x=>x.rut===a.rut_responsable); if(c && c.estado_contractual==='Cesado') ces++; });

    document.getElementById('kpi-total').innerText = total; document.getElementById('kpi-dispo').innerText = disp;
    document.getElementById('kpi-mant').innerText = mant; document.getElementById('kpi-cesados').innerText = ces;
    document.getElementById('kpi-asig').innerText = asig;
    renderTablaHome(DB_ACTIVOS.slice(0,10), "ltimos Movimientos");
}

function renderTablaHome(data, title) {
    document.getElementById('homeTableTitle').innerText = title;
    const b = document.getElementById('lastMovesTable');
    b.innerHTML = data.length ? data.map(a => {
        const c = DB_COLABS.find(x => x.rut === a.rut_responsable) || { nombre: 'N/A' };
        return `<tr>
            <td><div class="click-name" onclick="verUser('${a.rut_responsable}')" style="font-size:13px;">${c.nombre}</div><div style="font-size:10px; color:#64748b">${a.rut_responsable}</div></td>
            <td><span style="font-size:10px; padding:2px 6px; border-radius:4px; font-weight:600; background:${a.estado==='Disponible'?'#dcfce7':(a.estado==='Mantenci贸n'?'#ffedd5':'#f1f5f9')}; color:${a.estado==='Disponible'?'#166534':(a.estado==='Mantenci贸n'?'#9a3412':'#334155')}">${a.estado}</span></td>
            <td><div style="font-weight:600; font-size:12px;">${a.ubicacion||'-'}</div><code style="font-size:10px; color:var(--primary)">${a.serie}</code></td>
        </tr>`;
    }).join('') : '<tr><td colspan="3" style="text-align:center; padding:15px; color:#94a3b8;">Sin datos recientes</td></tr>';
}
function resetHomeTable() { renderTablaHome(DB_ACTIVOS.slice(0,10), "ltimos Movimientos"); }

// --- REPORTES DINMICOS (CHARTS) ---
function updateCharts() {
    if(charts.c1) charts.c1.destroy();
    if(charts.c2) charts.c2.destroy();

    // Gr谩fico 1: Donut
    const filter1 = document.getElementById('chart1_filter').value;
    const data1 = {};
    DB_ACTIVOS.forEach(a => {
        let key = 'N/A';
        if(filter1 === 'estado') key = a.estado;
        else if(filter1 === 'tienda') key = a.ubicacion;
        else if(filter1 === 'marca') key = a.marca;
        else if(filter1 === 'area') { const c = DB_COLABS.find(x=>x.rut===a.rut_responsable); key = c ? c.area : 'Sin Asignar'; }
        data1[key] = (data1[key] || 0) + 1;
    });

    charts.c1 = new Chart(document.getElementById('dynamicChart1'), {
        type: 'doughnut',
        data: { labels: Object.keys(data1), datasets: [{ data: Object.values(data1), backgroundColor: ['#0066CC', '#E31837', '#22c55e', '#f59e0b', '#64748b'] }] },
        options: { maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
    });

    // Gr谩fico 2: Barras
    const filter2 = document.getElementById('chart2_filter').value;
    const data2 = {};
    DB_ACTIVOS.forEach(a => {
        let key = 'N/A';
        if(filter2 === 'estado') key = a.estado;
        else if(filter2 === 'marca') key = a.marca;
        else if(filter2 === 'area') { const c = DB_COLABS.find(x=>x.rut===a.rut_responsable); key = c ? c.area : 'Sin Asignar'; }
        data2[key] = (data2[key] || 0) + 1;
    });

    charts.c2 = new Chart(document.getElementById('dynamicChart2'), {
        type: 'bar',
        data: { labels: Object.keys(data2), datasets: [{ label: 'Cantidad', data: Object.values(data2), backgroundColor: '#E31837' }] },
        options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
    });
}

// --- BSQUEDA EN TIEMPO REAL ---
function setupSearchListeners() {
    const mainInput = document.getElementById('mainSearch');
    const phoneInput = document.getElementById('phoneSearch');
    
    // Escuchar evento 'input' (cada tecla) para filtrar al instante
    if(mainInput) mainInput.addEventListener('input', renderTablaMaestra);
    if(phoneInput) phoneInput.addEventListener('input', renderPhoneTable);
}

// --- HISTORIAL & ACCIONES ---
async function registrarMovimiento(serie, accion, descripcion) {
    try { await sb.from('historial_activos').insert({ serie, accion, descripcion, usuario_editor: currentUserEmail }); } catch(e) {}
}
async function verHistorial(serie) {
    document.getElementById('modalHistorial').classList.remove('hidden'); document.getElementById('historialContent').innerHTML = 'Cargando...';
    const { data } = await sb.from('historial_activos').select('*').eq('serie', serie).order('created_at', { ascending: false });
    if(!data || !data.length) { document.getElementById('historialContent').innerHTML = '<p style="text-align:center;color:#64748b;">Sin historial.</p>'; return; }
    document.getElementById('historialContent').innerHTML = `<ul class="timeline">${data.map(h => `<li class="timeline-item"><div class="timeline-date">${new Date(h.created_at).toLocaleString()}</div><div class="timeline-content"><div style="font-weight:700; color:var(--primary)">${h.accion}</div><div style="font-size:12px;">${h.descripcion}</div><div style="font-size:10px; color:#94a3b8; margin-top:4px;">Por: ${h.usuario_editor||'Sistema'}</div></div></li>`).join('')}</ul>`;
}

// --- TABLAS ---
function getActionButtons(serie) {
    const histBtn = `<button class="btn-icon btn-hist" title="Ver Historial" onclick="verHistorial('${serie}')"><i class="fas fa-history"></i></button>`;
    if (currentUserRole !== 'admin') return `<div class="action-group">${histBtn}</div>`;
    return `<div class="action-group"><button class="btn-icon btn-edit" title="Editar" onclick="editar('${serie}')"><i class="fas fa-edit"></i></button><button class="btn-icon btn-return" title="Devolver a Bodega" onclick="abrirDevolucion('${serie}')"><i class="fas fa-box-open"></i></button>${histBtn}<button class="btn-icon btn-delete" title="Eliminar Registro" onclick="eliminarActivo('${serie}')"><i class="fas fa-trash-alt"></i></button></div>`;
}

function renderPhoneTable() {
    const inputVal = document.getElementById('phoneSearch').value.toLowerCase();
    const b = document.getElementById('phoneTableBody');
    const filtered = DB_ACTIVOS.filter(a => {
        if (!a.marca_cel && !a.imei_sim) return false;
        const c = DB_COLABS.find(col => col.rut === a.rut_responsable) || { nombre: '' };
        return `${c.nombre} ${a.numero||''} ${a.imei_cel||''} ${a.imei_sim||''}`.toLowerCase().includes(inputVal);
    });
    b.innerHTML = filtered.length ? filtered.map(a => {
        const c = DB_COLABS.find(col => col.rut === a.rut_responsable) || { nombre: 'N/A', area: '-' };
        return `<tr><td><div style="font-weight:700;">${c.nombre}</div><small style="color:#64748b">${c.area}</small></td><td><span style="font-weight:700; color:var(--primary);">${a.numero || '-'}</span></td><td>${a.marca_cel || '-'} ${a.modelo_cel || ''}</td><td>${a.imei_cel || '-'}</td><td>${a.imei_sim || '-'}</td><td><div style="font-size:11px; max-width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${a.observaciones || ''}</div></td><td>${getActionButtons(a.serie)}</td></tr>`;
    }).join('') : '<tr><td colspan="7" style="text-align:center; padding:20px; color:#64748b;">No hay registros</td></tr>';
}

function renderTablaMaestra() {
    const s = document.getElementById('mainSearch').value.toLowerCase();
    const b = document.getElementById('masterTableBody');
    const filtered = DB_ACTIVOS.filter(a => {
        if(!s) return true;
        const c = DB_COLABS.find(col => col.rut === a.rut_responsable) || { nombre: '' };
        return `${a.serie} ${c.nombre} ${a.rut_responsable} ${a.ubicacion}`.toLowerCase().includes(s);
    }).sort((a, b) => (a.rut_responsable || '').localeCompare(b.rut_responsable || ''));

    b.innerHTML = filtered.length ? filtered.map(a => {
        const c = DB_COLABS.find(col => col.rut === a.rut_responsable) || { nombre: 'N/A', estado_contractual: 'Vigente' };
        return `<tr><td style="color:#64748b">${a.rut_responsable}</td><td class="click-name" onclick="verUser('${a.rut_responsable}')">${c.nombre}</td><td>${a.estado}</td><td style="color:${c.estado_contractual==='Cesado'?'#b91c1c':'#166534'}; font-weight:700;">${c.estado_contractual||'Vigente'}</td><td>${c.area}</td><td>${a.ubicacion}</td><td>${a.marca} ${a.modelo}</td><td><code style="color:var(--primary); font-weight:600;">${a.serie}</code></td><td>${getActionButtons(a.serie)}</td></tr>`;
    }).join('') : '<tr><td colspan="9" style="text-align:center; padding:20px; font-style:italic; color:#64748b;">No se encontraron resultados</td></tr>';
}

// --- DEVOLUCION ---
function abrirDevolucion(serie) { currentSerieDevolucion = serie; document.getElementById('dev_serie').innerText = serie; document.getElementById('dev_obs').value = ''; document.getElementById('modalDevolucion').classList.remove('hidden'); }
async function procesarDevolucion() {
    if (!currentSerieDevolucion) return;
    const nuevoEstado = document.getElementById('dev_estado').value, nuevaUbicacion = document.getElementById('dev_ubicacion').value, obs = document.getElementById('dev_obs').value;
    try {
        const { error } = await sb.from('activos').update({ rut_responsable: '9.999.999-9', estado: nuevoEstado, ubicacion: nuevaUbicacion, observaciones: obs ? `DEVOLUCIN: ${obs}` : 'Devuelto a bodega' }).eq('serie', currentSerieDevolucion);
        if (error) throw error;
        registrarMovimiento(currentSerieDevolucion, 'Devoluci贸n', `Devuelto a ${nuevaUbicacion} (${nuevoEstado}).`);
        showToast("Devoluci贸n exitosa"); document.getElementById('modalDevolucion').classList.add('hidden'); cargarDatos();
    } catch (e) { showToast("Error: " + e.message, "error"); }
}
async function eliminarActivo(serie) {
    if(!confirm("驴Eliminar permanentemente?")) return;
    try { await sb.from('activos').delete().eq('serie', serie); registrarMovimiento(serie, 'Eliminaci贸n', 'Registro borrado'); showToast("Eliminado"); cargarDatos(); } catch (e) { showToast("Error", "error"); }
}

// --- CRUD ---
function nuevoRegistro() {
    document.querySelectorAll('#modalFicha input').forEach(i => { i.value = ''; i.classList.remove('error-input'); });
    document.querySelectorAll('#modalFicha select').forEach(s => s.selectedIndex = 0);
    document.getElementById('sw_equipo').checked = false; document.getElementById('sw_sim').checked = false; toggleTelefonia(); document.getElementById('modalFicha').classList.remove('hidden');
}
function editar(serie) {
    const a = DB_ACTIVOS.find(x=>x.serie===serie); if(!a) return;
    const c = DB_COLABS.find(x=>x.rut===a.rut_responsable) || {};
    document.getElementById('f_rut').value = a.rut_responsable; document.getElementById('f_nombre').value = c.nombre||''; document.getElementById('f_correo').value = c.correo||'';
    setSelect('f_area', c.area); setSelect('f_tienda', a.ubicacion); setSelect('f_contractual', c.estado_contractual); setSelect('f_estado', a.estado);
    document.getElementById('f_marca').value = a.marca; document.getElementById('f_modelo').value = a.modelo; document.getElementById('f_serie').value = a.serie;
    document.getElementById('f_fecha_ent').value = a.fecha_entrega; document.getElementById('f_ent_it').value = a.entrega_it || ''; document.getElementById('f_obs').value = a.observaciones || '';
    document.getElementById('sw_equipo').checked = !!a.marca_cel; document.getElementById('sw_sim').checked = !!a.imei_sim;
    document.getElementById('f_numero').value = a.numero || ''; document.getElementById('f_mar_cel').value = a.marca_cel || ''; document.getElementById('f_mod_cel').value = a.modelo_cel || ''; document.getElementById('f_imei').value = a.imei_cel || ''; document.getElementById('f_imsi').value = a.imei_sim || '';
    toggleTelefonia(); document.getElementById('modalFicha').classList.remove('hidden');
}
async function guardarTodoSincronizado() {
    const btn = document.getElementById('btnSave'); const rut = document.getElementById('f_rut').value.trim(); const serie = document.getElementById('f_serie').value.trim();
    if(!rut || !serie) return showToast("Faltan datos", "error");
    btn.innerText = "PROCESANDO..."; btn.disabled = true;
    const colab = { rut, nombre: document.getElementById('f_nombre').value, correo: document.getElementById('f_correo').value, area: document.getElementById('f_area').value, estado_contractual: document.getElementById('f_contractual').value };
    const activo = { serie, rut_responsable: rut, marca: document.getElementById('f_marca').value, modelo: document.getElementById('f_modelo').value, estado: document.getElementById('f_estado').value, ubicacion: document.getElementById('f_tienda').value, fecha_entrega: document.getElementById('f_fecha_ent').value, entrega_it: document.getElementById('f_ent_it').value, observaciones: document.getElementById('f_obs').value, numero: document.getElementById('f_numero').value, marca_cel: document.getElementById('sw_equipo').checked ? document.getElementById('f_mar_cel').value : null, modelo_cel: document.getElementById('sw_equipo').checked ? document.getElementById('f_mod_cel').value : null, imei_cel: document.getElementById('sw_equipo').checked ? document.getElementById('f_imei').value : null, imei_sim: document.getElementById('sw_sim').checked ? document.getElementById('f_imsi').value : null };
    try { await sb.from('colaboradores').upsert(colab, {onConflict:'rut'}); await sb.from('activos').upsert(activo, {onConflict:'serie'}); registrarMovimiento(serie, 'Edici贸n', `Actualizado por ${currentUserEmail}`); showToast("Guardado"); cerrarFicha(); cargarDatos(); } catch(e) { showToast("Error", "error"); } finally { btn.innerText = "GUARDAR"; btn.disabled = false; }
}
function verUser(rut) {
    const c = DB_COLABS.find(x => x.rut === rut); if(!c) return;
    const activos = DB_ACTIVOS.filter(x => x.rut_responsable === rut);
    const html = `<div class="user-header"><div class="user-avatar">${c.nombre.charAt(0)}</div><div><h3 style="margin:0; font-size:20px;">${c.nombre}</h3><p style="color:#64748b;">${c.rut} | ${c.area}</p></div></div><h4 style="color:var(--primary);">Equipos (${activos.length})</h4><ul class="asset-list">${activos.map(a=>`<li class="asset-item"><div class="asset-detail-row"><div><strong>${a.marca} ${a.modelo}</strong></div><code style="color:var(--primary)">${a.serie}</code></div>${a.marca_cel?`<div class="separator"></div><div class="asset-detail-row"><div>Cel: ${a.marca_cel}</div><small>IMEI: ${a.imei_cel}</small></div>`:''}<div style="text-align:right;"><span class="role-badge badge-viewer">${a.estado}</span></div></li>`).join('')}</ul>`;
    document.getElementById('userProfileContent').innerHTML = html; document.getElementById('modalVerUsuario').classList.remove('hidden');
}

// UTILS
function procesarCSV() { const f = document.getElementById('csvFile').files[0]; if(!f) return showToast("Sin archivo", "error"); const r = new FileReader(); r.readAsText(f); r.onload = (e) => { const l = e.target.result.split(/\r?\n/); l.forEach(line => { /* L贸gica CSV Simplificada */ }); showToast("Carga CSV iniciada"); cargarDatos(); }; }
function setSelect(id, val) { const el = document.getElementById(id); if(el) el.value = val; }
function toggleTelefonia() { const eq = document.getElementById('sw_equipo').checked; const sim = document.getElementById('sw_sim').checked; ['f_mar_cel', 'f_mod_cel', 'f_imei'].forEach(id => { const el = document.getElementById(id); el.disabled = !eq; el.classList.toggle('disabled-field', !eq); if(!eq) el.value = ""; }); const simEl = document.getElementById('f_imsi'); simEl.disabled = !sim; simEl.classList.toggle('disabled-field', !sim); if(!sim) simEl.value = ""; }
function setupListeners() { const ir = document.getElementById('f_rut'), iname = document.getElementById('f_nombre'); ir.addEventListener('blur', () => { const c = DB_COLABS.find(x => x.rut === ir.value); if(c) { document.getElementById('f_nombre').value = c.nombre; setSelect('f_area', c.area); } }); iname.addEventListener('input', () => { const c = DB_COLABS.find(x => x.nombre === iname.value); if(c) ir.value = c.rut; }); }
function showView(v) { document.querySelectorAll('.content-area > div').forEach(d=>d.classList.add('hidden')); document.getElementById('view-'+v).classList.remove('hidden'); document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); if(v==='telephony') document.getElementById('btn-phone').classList.add('active'); if(v==='home') document.getElementById('btn-home').classList.add('active'); if(v==='inventory') document.getElementById('btn-inv').classList.add('active'); if(v==='metrics') document.getElementById('btn-metrics').classList.add('active'); }
function abrirFicha() { document.getElementById('modalFicha').classList.remove('hidden'); setupListeners(); }
function cerrarFicha() { document.getElementById('modalFicha').classList.add('hidden'); }

initSystem();
</script>
</body>
</html>
