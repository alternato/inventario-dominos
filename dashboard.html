<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - TI Maestro v90.0</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { --primary: #0066CC; --secondary: #E31837; --success: #10b981; --warning: #f59e0b; --info: #3b82f6; --dark: #1e293b; --bg: #f1f5f9; --border: #e2e8f0; --radius: 8px; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); height: 100vh; display: flex; font-size: 13px; overflow: hidden; color: #334155; }
        
        #sidebar { width: 260px; background: linear-gradient(180deg, var(--primary) 0%, #004a99 100%); color: white; padding: 25px; display: flex; flex-direction: column; flex-shrink: 0; position: relative; z-index: 10; box-shadow: 4px 0 10px rgba(0,0,0,0.05); }
        .logo-img { width: 140px; height: auto; margin-bottom: 40px; align-self: center; filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.8)); transition: transform 0.3s ease; }
        .logo-img:hover { transform: scale(1.05); }
        .nav-btn { background: rgba(255,255,255,0.08); color: white; border: none; padding: 12px 15px; border-radius: 8px; width: 100%; margin-bottom: 10px; text-align: left; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; font-weight: 500; }
        .nav-btn:hover { background: rgba(255,255,255,0.2); transform: translateX(3px); }
        .nav-btn.active { background: var(--secondary); font-weight: 700; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .sidebar-footer { margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); text-align: center; }
        .watermark { font-size: 10px; color: rgba(255,255,255,0.5); font-style: italic; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .gemini-svg { width: 60px; height: auto; opacity: 0.7; }

        .main-container { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        header { background: white; padding: 15px 30px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.02); }
        .content-area { padding: 30px; overflow-y: auto; flex-grow: 1; }
        
        /* KPIS INTERACTIVOS */
        .kpi-section { margin-bottom: 30px; }
        .kpi-title { font-size: 12px; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 15px; letter-spacing: 0.5px; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; }
        .kpi-card { 
            background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border); 
            display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); 
            transition: all 0.2s; cursor: pointer; position: relative; overflow: hidden;
        }
        .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0,0,0,0.05); border-color: var(--primary); }
        .kpi-card.active { border: 2px solid var(--primary); background-color: #f0f9ff; }
        .kpi-card.active .kpi-icon { background: var(--primary) !important; color: white; transform: scale(1.1); }

        .kpi-icon { width: 45px; height: 45px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; flex-shrink: 0; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .kpi-content { display: flex; flex-direction: column; }
        .kpi-number { font-size: 26px; font-weight: 800; color: var(--dark); line-height: 1; }
        .kpi-label { font-size: 11px; color: #64748b; font-weight: 600; text-transform: uppercase; margin-top: 5px; }

        /* TABLAS MODERNAS */
        .table-wrapper { background: white; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); overflow: hidden; display: flex; flex-direction: column; height: 100%; }
        .home-table-section { min-height: 400px; }
        .home-table-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fff; }
        
        table { width: 100%; border-collapse: collapse; }
        thead th { background: #f8fafc; color: #475569; font-weight: 700; font-size: 11px; text-transform: uppercase; padding: 12px 20px; text-align: left; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 10; }
        tbody td { padding: 10px 20px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; color: #334155; font-size: 13px; }
        tbody tr:hover { background-color: #f8fafc; }

        /* BADGES & BOTONES */
        .status-badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 700; text-transform: uppercase; color: white; min-width: 75px; text-align: center; }
        .status-green { background-color: #10b981; } .status-blue { background-color: #0066CC; } .status-orange { background-color: #f59e0b; } .status-red { background-color: #ef4444; }
        .btn-action-outline { background: white; border: 1px solid #cbd5e1; color: #64748b; width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .btn-action-outline:hover { border-color: var(--primary); color: var(--primary); background: #f0f9ff; }
        .click-name { color: var(--primary); font-weight: 600; text-decoration: none; cursor: pointer; } .click-name:hover { text-decoration: underline; }

        /* MODALES & FORMULARIOS */
        .modal { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(2px); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 95%; max-width: 1100px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .form-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .field { display: flex; flex-direction: column; gap: 6px; }
        .field label { font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; }
        input, select, textarea { padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 13px; transition: 0.2s; background: #fff; }
        input:focus, select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(0,102,204,0.1); }
        .section-tag { grid-column: span 4; color: var(--primary); font-weight: 800; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; margin: 25px 0 15px 0; font-size: 13px; display: flex; align-items: center; gap: 10px; }
        .switch-box { display: flex; align-items: center; gap: 10px; background: #f8fafc; padding: 10px 15px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .toggle { position: relative; display: inline-block; width: 40px; height: 22px; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #cbd5e1; transition: .3s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 2px; bottom: 2px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(18px); }
        .disabled-field { background-color: #f1f5f9 !important; color: #94a3b8 !important; cursor: not-allowed !important; }
        
        /* GRAFICOS */
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 25px; padding-bottom: 50px; }
        .chart-card { background: white; padding: 25px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        
        /* UTILS */
        .hidden { display: none !important; }
        .admin-only { display: none !important; }
        body.role-admin .admin-only { display: flex !important; }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-left: 5px solid; display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s ease-out; font-weight: 600; }
        .toast.success { border-color: var(--success); } .toast.error { border-color: var(--secondary); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .csv-panel { background: #fff; border: 2px dashed var(--primary); padding: 15px; border-radius: var(--radius); margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; gap: 20px; }

        /* --- USER PROFILE DETAILED (MEJORADO CON ICONOS) --- */
        .user-header { display: flex; align-items: center; gap: 20px; margin-bottom: 25px; border-bottom: 1px solid #e2e8f0; padding-bottom: 20px; }
        .user-avatar { width: 70px; height: 70px; background: var(--primary); color: white; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: 700; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .asset-list { list-style: none; padding: 0; }
        .asset-item { border: 1px solid #e2e8f0; margin-bottom: 12px; border-radius: 10px; background: #fff; padding: 18px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .asset-item:hover { transform: translateX(5px); border-color: var(--primary); }
        
        /* ESTILOS DE BLOQUES DE EQUIPO (NUEVO) */
        .asset-block { display: flex; gap: 12px; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed #e2e8f0; }
        .asset-block:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
        .asset-icon-box { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
        .icon-pc { background: #e0f2fe; color: #0066CC; }
        .icon-phone { background: #dcfce7; color: #166534; }
        .icon-sim { background: #f3e8ff; color: #7e22ce; }
        .asset-info h5 { margin: 0; font-size: 13px; font-weight: 700; color: #1e293b; }
        .asset-info p { margin: 2px 0 0 0; font-size: 11px; color: #64748b; font-family: monospace; }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <aside id="sidebar">
        <img src="https://logos-world.net/wp-content/uploads/2021/08/Dominos-Logo.png" class="logo-img" alt="Domino's Logo">
        
        <button class="nav-btn active" id="btn-home" onclick="showView('home')"><i class="fas fa-home"></i> Inicio</button>
        <button class="nav-btn" id="btn-inv" onclick="showView('inventory')"><i class="fas fa-boxes"></i> Inventario Data</button>
        <button class="nav-btn" id="btn-phone" onclick="showView('telephony')"><i class="fas fa-mobile-alt"></i> Telefon铆a</button>
        <button class="nav-btn" id="btn-metrics" onclick="showView('metrics')"><i class="fas fa-chart-pie"></i> Reportes TI</button>
        <hr style="margin: 20px 0; opacity: 0.2;">
        <button class="nav-btn admin-only" style="background: var(--success);" onclick="nuevoRegistro()"><i class="fas fa-plus-circle"></i> NUEVO REGISTRO</button>
        <button class="nav-btn" style="background: rgba(0,0,0,0.2); margin-top: 10px;" onclick="cerrarSesion()"><i class="fas fa-sign-out-alt"></i> Salir</button>

        <div class="sidebar-footer">
            <div class="watermark">
                <span>Designed & Developed by EDC &</span>
                <svg class="gemini-svg" viewBox="0 0 135 48" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22.5 12 L25 20 L33 22.5 L25 25 L22.5 33 L20 25 L12 22.5 L20 20 Z" fill="white" />
                    <text x="40" y="32" font-family="Arial, sans-serif" font-weight="bold" font-size="20" fill="white">Gemini</text>
                </svg>
            </div>
        </div>
    </aside>

    <main class="main-container">
        <header>
            <h2 id="viewTitle" style="color: var(--dark); font-weight:800;">Dashboard General</h2>
            <div id="sync" style="font-size: 13px; color: #64748b; font-weight: 500; display:flex; align-items:center; background:#f8fafc; padding:8px 15px; border-radius:20px;">
                <i class="fas fa-user-circle" style="margin-right:8px; font-size:16px;"></i>
                <span id="userEmail" style="margin-right: 10px;">Cargando...</span>
                <span id="userRoleBadge" class="role-badge badge-viewer">...</span>
            </div>
        </header>
        
        <div class="content-area">
            
            <div id="view-home">
                <div class="kpi-section">
                    <div class="kpi-title"><i class="fas fa-chart-bar"></i> Estado del Inventario (Click para filtrar)</div>
                    <div class="kpi-grid">
                        <div class="kpi-card" onclick="filterDashboard(this, 'total')"><div class="kpi-icon" style="background: var(--dark);"><i class="fas fa-cubes"></i></div><div class="kpi-content"><span class="kpi-number" id="kpi-total">-</span><span class="kpi-label">Total Activos</span></div></div>
                        <div class="kpi-card" onclick="filterDashboard(this, 'asig')"><div class="kpi-icon" style="background: var(--primary);"><i class="fas fa-user-check"></i></div><div class="kpi-content"><span class="kpi-number" id="kpi-asig">-</span><span class="kpi-label">Asignados</span></div></div>
                        <div class="kpi-card" onclick="filterDashboard(this, 'dispo')"><div class="kpi-icon" style="background: var(--success);"><i class="fas fa-check-circle"></i></div><div class="kpi-content"><span class="kpi-number" id="kpi-dispo">-</span><span class="kpi-label">Disponibles</span></div></div>
                        <div class="kpi-card" onclick="filterDashboard(this, 'mant')"><div class="kpi-icon" style="background: var(--warning);"><i class="fas fa-tools"></i></div><div class="kpi-content"><span class="kpi-number" id="kpi-mant">-</span><span class="kpi-label">En Mantenci贸n</span></div></div>
                        <div class="kpi-card" onclick="filterDashboard(this, 'baja')"><div class="kpi-icon" style="background: #94a3b8;"><i class="fas fa-trash"></i></div><div class="kpi-content"><span class="kpi-number" id="kpi-baja">-</span><span class="kpi-label">De Baja</span></div></div>
                    </div>
                </div>

                <div class="kpi-section">
                    <div class="kpi-title"><i class="fas fa-laptop-code"></i> Tipos de Equipamiento & Alertas</div>
                    <div class="kpi-grid">
                        <div class="kpi-card" onclick="filterDashboard(this, 'pcs')"><div class="kpi-icon" style="background: var(--info);"><i class="fas fa-laptop"></i></div><div class="kpi-content"><span class="kpi-number" id="kpi-pcs">-</span><span class="kpi-label">Computadores</span></div></div>
                        <div class="kpi-card" onclick="filterDashboard(this, 'cels')"><div class="kpi-icon" style="background: var(--info);"><i class="fas fa-mobile-alt"></i></div><div class="kpi-content"><span class="kpi-number" id="kpi-cels">-</span><span class="kpi-label">Celulares</span></div></div>
                        <div class="kpi-card" onclick="filterDashboard(this, 'sims')"><div class="kpi-icon" style="background: var(--info);"><i class="fas fa-sim-card"></i></div><div class="kpi-content"><span class="kpi-number" id="kpi-sims">-</span><span class="kpi-label">Chips / SIMs</span></div></div>
                        <div class="kpi-card" onclick="filterDashboard(this, 'cesados')"><div class="kpi-icon" style="background: var(--secondary);"><i class="fas fa-user-slash"></i></div><div class="kpi-content"><span class="kpi-number" id="kpi-cesados">-</span><span class="kpi-label">Usuario Cesado</span></div></div>
                    </div>
                </div>

                <div class="table-wrapper home-table-section">
                    <div class="home-table-header">
                        <h4 id="homeTableTitle" style="color: var(--primary); margin: 0; font-size: 15px; font-weight:800;"><i class="fas fa-history"></i> ltimos Movimientos</h4>
                        <button onclick="resetHomeTable()" style="font-size: 11px; background: white; border: 1px solid #cbd5e1; padding: 6px 15px; border-radius: 6px; cursor: pointer; font-weight:600; color:#64748b;"><i class="fas fa-sync-alt"></i> Ver Recientes</button>
                    </div>
                    <div class="table-scroll">
                        <table style="width: 100%;">
                            <thead><tr><th style="width: 35%;">Nombre / RUT</th><th style="width: 25%;">Estado</th><th style="width: 40%;">Ubicaci贸n / Serie</th></tr></thead>
                            <tbody id="lastMovesTable"><tr><td colspan="3" style="text-align:center; padding:30px;">Cargando datos...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-inventory" class="hidden">
                <div class="csv-panel admin-only">
                    <div style="flex-grow:1;"><label style="display:block; font-size:10px; font-weight:800; color:var(--primary); margin-bottom:5px;">CARGA MASIVA CSV</label><input type="file" id="csvFile" accept=".csv"></div>
                    <div style="display: flex; gap: 10px;"><button onclick="verificarDuplicados()" class="nav-btn" style="width:auto; background:#f97316; font-weight:700; color:white; margin:0;"><i class="fas fa-search-plus"></i> AUDITAR DUPLICADOS</button><button onclick="procesarCSV()" id="btnCsv" class="nav-btn" style="width:auto; background:var(--dark); margin:0; padding: 8px 16px;"><i class="fas fa-upload"></i> PROCESAR</button></div>
                </div>
                <input type="search" id="mainSearch" placeholder=" Buscar por RUT, Nombre, Serie, Tienda..." style="width: 100%; margin-bottom: 20px; padding: 15px; border-radius: 12px; border: 1px solid var(--border); font-size: 14px; font-family:'Inter'; box-shadow: 0 2px 5px rgba(0,0,0,0.02);" autocomplete="off">
                <div class="table-wrapper"><div class="table-scroll"><table><thead><tr><th>RUT</th><th>Responsable</th><th>Estado</th><th>Contrato</th><th>rea</th><th>Tienda</th><th>Modelo</th><th>Serie</th><th class="admin-only" style="text-align:center;">Acciones</th></tr></thead><tbody id="masterTableBody"><tr><td colspan="9" style="text-align:center; padding:30px;">Cargando datos...</td></tr></tbody></table></div></div>
            </div>

            <div id="view-telephony" class="hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><h3 style="color: var(--primary); font-weight:800;">Gesti贸n de L铆neas y Equipos M贸viles</h3><input type="search" id="phoneSearch" placeholder=" Buscar tel茅fono, IMEI, Usuario..." style="padding: 12px; border-radius: 12px; border: 1px solid var(--border); width: 350px; font-family:'Inter'; box-shadow: 0 2px 5px rgba(0,0,0,0.02);"></div>
                <div class="table-wrapper"><div class="table-scroll"><table><thead><tr><th>Usuario / Cargo</th><th>N煤mero</th><th>Equipo M贸vil</th><th>IMEI</th><th>SIM (IMSI)</th><th>Observaciones</th><th class="admin-only" style="text-align:center;">Acciones</th></tr></thead><tbody id="phoneTableBody"><tr><td colspan="7" style="text-align:center; padding:30px;">Cargando datos...</td></tr></tbody></table></div></div>
            </div>

            <div id="view-metrics" class="hidden">
                <div class="reports-toolbar"><button class="nav-btn" style="width:auto; background:var(--success); font-weight:700;" onclick="addChart()"><i class="fas fa-plus"></i> Agregar Gr谩fico</button></div>
                <div class="charts-grid" id="chartsContainer"></div>
            </div>
        </div>
    </main>

    <div id="modalFicha" class="modal hidden"><div class="modal-content"><h2 style="color:var(--primary);margin-bottom:20px;">Ficha T茅cnica</h2><div class="form-grid"><div class="section-tag"><i class="fas fa-user"></i> 1. Colaborador</div><div class="field"><label>RUT *</label><input type="text" id="f_rut" placeholder="Ej: 11.222.333-k"></div><div class="field" style="grid-column: span 2;"><label>Nombre Completo</label><input type="text" id="f_nombre" list="listaNombres"><datalist id="listaNombres"></datalist></div><div class="field"><label>Correo</label><input type="email" id="f_correo"></div><div class="field"><label>rea</label><select id="f_area"><option>Operaciones</option><option>Inform谩tica</option><option>Administraci贸n</option><option>Marketing</option><option>Log铆stica</option><option>Finanzas</option><option>RRHH</option></select></div><div class="field"><label>Tienda / Ubicaci贸n</label><select id="f_tienda"></select></div><div class="field"><label>Contrato</label><select id="f_contractual"><option>Vigente</option><option>Cesado</option></select></div><div class="section-tag"><i class="fas fa-laptop"></i> 2. Equipo PC</div><div class="field"><label>Marca PC</label><input type="text" id="f_marca"></div><div class="field"><label>Modelo PC</label><input type="text" id="f_modelo"></div><div class="field"><label>Serie PC *</label><input type="text" id="f_serie"></div><div class="field"><label>Estado Asignaci贸n</label><select id="f_estado"><option>Asignado</option><option>Disponible</option><option>Mantenci贸n</option><option>Baja</option></select></div><div class="section-tag"><i class="fas fa-mobile-alt"></i> 3. Telefon铆a M贸vil</div><div class="switch-box"><label class="toggle"><input type="checkbox" id="sw_equipo" onchange="toggleTelefonia()"><span class="slider"></span></label><span>Equipo Celular</span></div><div class="switch-box"><label class="toggle"><input type="checkbox" id="sw_sim" onchange="toggleTelefonia()"><span class="slider"></span></label><span>SIM Card</span></div><div class="field"><label>N煤mero Telef贸nico</label><input type="text" id="f_numero" placeholder="+569..."></div><div class="field"><label>Marca Cel</label><input type="text" id="f_mar_cel" class="disabled-field" disabled></div><div class="field"><label>Modelo Cel</label><input type="text" id="f_mod_cel" class="disabled-field" disabled></div><div class="field"><label>IMEI Equipo</label><input type="text" id="f_imei" class="disabled-field" disabled></div><div class="field"><label>IMSI (SIM)</label><input type="text" id="f_imsi" class="disabled-field" disabled></div><div class="section-tag"><i class="fas fa-clipboard-check"></i> 4. Control & Auditor铆a</div><div class="field"><label>Fecha Entrega</label><input type="date" id="f_fecha_ent"></div><div class="field"><label>Entregado Por (IT)</label><input type="text" id="f_ent_it"></div><div class="field" style="grid-column: span 2;"><label>Observaciones</label><input type="text" id="f_obs"></div></div><div style="margin-top:25px; text-align:right; border-top:1px solid #f1f5f9; padding-top:20px;"><button onclick="cerrarFicha()" style="padding:10px 20px; border:none; background:#f1f5f9; color:#64748b; cursor:pointer; border-radius:6px; margin-right:10px; font-weight:600;">Cancelar</button><button onclick="guardarTodoSincronizado()" id="btnSave" style="padding:10px 25px; border:none; background:var(--primary); color:white; font-weight:700; cursor:pointer; border-radius:6px;">GUARDAR</button></div></div></div>
    <div id="modalDevolucion" class="modal hidden" style="z-index: 1200;"><div class="modal-content" style="max-width: 500px;"><h3 style="color:var(--warning); margin-bottom:15px;"><i class="fas fa-box-open"></i> Devoluci贸n a Bodega</h3><p style="margin-bottom:20px;">El equipo serie <strong id="dev_serie"></strong> ser谩 asignado a <strong>INFORMATICA</strong>.</p><div class="field" style="margin-bottom:15px;"><label>Nuevo Estado</label><select id="dev_estado"><option value="Disponible">Disponible (Stock)</option><option value="Mantenci贸n">A Mantenci贸n</option><option value="Baja">Dar de Baja</option></select></div><div class="field" style="margin-bottom:15px;"><label>Nueva Ubicaci贸n</label><select id="dev_ubicacion"><option>Bodega Central</option><option>Casa Matriz</option><option>Soporte IT</option></select></div><div class="field" style="margin-bottom:20px;"><label>Observaciones</label><textarea id="dev_obs" rows="3" placeholder="Ej: Pantalla con rayas..."></textarea></div><div style="text-align:right;"><button onclick="document.getElementById('modalDevolucion').classList.add('hidden')" style="padding:10px 20px; border:none; background:#f1f5f9; cursor:pointer; border-radius:6px; margin-right:10px;">Cancelar</button><button onclick="procesarDevolucion()" style="padding:10px 20px; border:none; background:var(--warning); color:#fff; font-weight:700; cursor:pointer; border-radius:6px;">CONFIRMAR</button></div></div></div>
    <div id="modalHistorial" class="modal hidden" style="z-index: 1300;"><div class="modal-content" style="max-width: 600px;"><h3 style="color:var(--dark); margin-bottom:15px;">Historial de Trazabilidad</h3><div id="historialContent" style="max-height: 400px; overflow-y: auto;">Cargando...</div><div style="text-align:right; margin-top:20px;"><button onclick="document.getElementById('modalHistorial').classList.add('hidden')" style="padding:8px 20px; border:none; background:#f1f5f9; cursor:pointer; border-radius:6px;">Cerrar</button></div></div></div>
    <div id="modalAudit" class="modal hidden" style="z-index: 1400;"><div class="modal-content" style="max-width: 600px;"><h3 style="color:#f97316; margin-bottom:15px;"><i class="fas fa-exclamation-triangle"></i> Resultados de Auditor铆a</h3><div id="auditContent" style="max-height: 400px; overflow-y: auto;">Analizando...</div><div style="text-align:right; margin-top:20px;"><button onclick="document.getElementById('modalAudit').classList.add('hidden')" style="padding:8px 20px; border:none; background:#f1f5f9; cursor:pointer; border-radius:6px;">Cerrar</button></div></div></div>
    <div id="modalVerUsuario" class="modal hidden" style="z-index: 1100;"><div class="modal-content" style="max-width: 600px;"><div id="userProfileContent"></div><div style="text-align:right; margin-top:20px;"><button onclick="document.getElementById('modalVerUsuario').classList.add('hidden')" style="background:var(--dark); color:white; padding:8px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:600;">Cerrar</button></div></div></div>

<script>
if(typeof ChartDataLabels!=='undefined') Chart.register(ChartDataLabels);
const CONFIG = { URL: "https://ivjwxvhixrskraepqzse.supabase.co", KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2and4dmhpeHJza3JhZXBxenNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MjgxNTgsImV4cCI6MjA4NDUwNDE1OH0.QzgNSwqf6VTXZjGMXOAfUnjW4f1mJcRqECxxNnLZc-o" };
let sb; try { sb = window.supabase.createClient(CONFIG.URL, CONFIG.KEY); } catch(e) { console.error(e); }

const TIENDAS = [ "Casa Matriz", "Antofagasta - Estadio Regional", "Antofagasta - Sector Norte", "Arica", "Buin", "Bustamante", "Calama", "Chiguayante", "Chill谩n", "Concepcion - Plaza Acevedo", "Conc贸n", "Copiap贸", "Curic贸", "Froilan Roa", "General Velasquez", "Gran Avenida", "Hualp茅n", "Iquique", "Irarr谩zaval", "La Florida (Santa Amalia)", "La Serena (Balmaceda)", "Lautaro", "Luis Pasteur", "Machal铆", "Macul", "Maipu 1", "Mall del Centro*", "Mall Paseo Los Dominicos", "Manuel Montt", "Osorno 2 Centro", "Osorno 1 Rahue", "Parque Angamos", "Pedro Fontova", "Pe帽alol茅n", "Plaza Atenas", "Pto. Montt 2 (Cardonal)", "Pto. Montt 1 (Ejercito)", "Puente Alto", "Punta Arenas", "Quilicura", "Quilpu茅", "Recoleta", "San Francisco", "San Pedro de la Paz", "Santa Ana", "La Serena (B. Universitario)", "Talca", "Temuco", "Tobalaba", "Vi帽a del Mar", "Commisary" ];

let DB_ACTIVOS = [], DB_COLABS = [], charts = [], currentUserRole = 'viewer', currentUserEmail = '';
let currentSerieDevolucion = null;

function showToast(msg, type='success') {
    const d = document.createElement('div'); d.className = `toast ${type}`;
    d.innerHTML = `<i class="fas fa-${type==='success'?'check-circle':'exclamation-circle'}"></i> ${msg}`;
    document.getElementById('toast-container').appendChild(d);
    setTimeout(() => d.remove(), 3000);
}

function initSystem() {
    if(localStorage.getItem('manualAuth') === 'true') { loadApp("Admin Local", "admin"); return; }
    sb.auth.getSession().then(({ data: { session } }) => {
        if (!session) window.location.href = 'index.html'; else checkUserRole(session.user.email);
    });
}

async function checkUserRole(email) {
    let role = 'viewer';
    try { const { data } = await sb.from('user_roles').select('role').eq('email', email).single(); if(data) role = data.role; } catch(e) {}
    loadApp(email, role);
}

function loadApp(email, role) {
    currentUserEmail = email;
    document.getElementById('userEmail').innerText = email;
    currentUserRole = role;
    const badge = document.getElementById('userRoleBadge');
    if(role === 'admin') {
        document.body.classList.add('role-admin');
        badge.className = 'role-badge badge-admin'; badge.innerText = 'ADMINISTRADOR';
    } else {
        document.body.classList.remove('role-admin');
        badge.className = 'role-badge badge-viewer'; badge.innerText = 'VISUALIZADOR';
    }
    const storeOptions = TIENDAS.map(t=>`<option>${t}</option>`).join('');
    document.getElementById('f_tienda').innerHTML = storeOptions;
    document.getElementById('dev_ubicacion').innerHTML = `<option>Bodega Central</option><option>Soporte IT</option>${storeOptions}`;
    setupSearchListeners();
    cargarDatos();
}

async function cerrarSesion() {
    localStorage.removeItem('manualAuth');
    await sb.auth.signOut();
    window.location.href = 'index.html';
}

async function cargarDatos() {
    try {
        const [resA, resC] = await Promise.all([sb.from('activos').select('*'), sb.from('colaboradores').select('*')]);
        if(resA.error || resC.error) throw new Error("Error en DB");
        DB_ACTIVOS = resA.data ? resA.data.sort((a,b)=> new Date(b.created_at||0) - new Date(a.created_at||0)) : [];
        DB_COLABS = resC.data || [];
        document.getElementById('listaNombres').innerHTML = DB_COLABS.map(c=>`<option value="${c.nombre}">`).join('');
        renderTablaMaestra(); 
        renderPhoneTable(); 
        renderTablaHome(DB_ACTIVOS.slice(0,10), "ltimos Movimientos");
        actualizarDashboard(); 
        document.getElementById('chartsContainer').innerHTML = ''; 
        addChart('estado', 'doughnut');
        addChart('tienda', 'bar');
    } catch(e) { console.error(e); showToast("Error al cargar datos.", "error"); }
}

function safeSetText(id, value) { const el = document.getElementById(id); if (el) el.innerText = value; }

function actualizarDashboard() {
    const total = DB_ACTIVOS.length;
    const disp = DB_ACTIVOS.filter(a=>a.estado==='Disponible').length;
    const mant = DB_ACTIVOS.filter(a=>a.estado==='Mantenci贸n').length;
    const asig = DB_ACTIVOS.filter(a=>a.estado==='Asignado').length;
    const baja = DB_ACTIVOS.filter(a=>a.estado==='Baja').length;
    const cels = DB_ACTIVOS.filter(a => (a.marca_cel && a.marca_cel.length > 1) || (a.imei_cel && a.imei_cel.length > 1)).length;
    const sims = DB_ACTIVOS.filter(a => (a.imei_sim && a.imei_sim.length > 1) || (a.numero && a.numero.length > 1)).length;
    const pcs = DB_ACTIVOS.filter(a => a.marca && a.marca.length > 1).length;
    let ces = 0; DB_ACTIVOS.forEach(a=>{ const c=DB_COLABS.find(x=>x.rut===a.rut_responsable); if(c && c.estado_contractual==='Cesado') ces++; });
    safeSetText('kpi-total', total); safeSetText('kpi-dispo', disp); safeSetText('kpi-mant', mant); safeSetText('kpi-asig', asig); safeSetText('kpi-baja', baja); safeSetText('kpi-pcs', pcs); safeSetText('kpi-cels', cels); safeSetText('kpi-sims', sims); safeSetText('kpi-cesados', ces);
}

function filterDashboard(card, type) {
    document.querySelectorAll('.kpi-card').forEach(c => c.classList.remove('active'));
    card.classList.add('active');
    let data = [];
    let title = "";
    switch(type) {
        case 'total': data = DB_ACTIVOS; title = "Total de Activos"; break;
        case 'asig': data = DB_ACTIVOS.filter(a => a.estado === 'Asignado'); title = "Equipos Asignados"; break;
        case 'dispo': data = DB_ACTIVOS.filter(a => a.estado === 'Disponible'); title = "Stock Disponible"; break;
        case 'mant': data = DB_ACTIVOS.filter(a => a.estado === 'Mantenci贸n'); title = "Equipos en Mantenci贸n"; break;
        case 'baja': data = DB_ACTIVOS.filter(a => a.estado === 'Baja'); title = "Equipos de Baja"; break;
        case 'pcs': data = DB_ACTIVOS.filter(a => a.marca && a.marca.length > 1); title = "Computadores"; break;
        case 'cels': data = DB_ACTIVOS.filter(a => (a.marca_cel && a.marca_cel.length > 1) || (a.imei_cel && a.imei_cel.length > 1)); title = "Celulares"; break;
        case 'sims': data = DB_ACTIVOS.filter(a => (a.imei_sim && a.imei_sim.length > 1) || (a.numero && a.numero.length > 1)); title = "SIM Cards"; break;
        case 'cesados': 
            data = DB_ACTIVOS.filter(a => { const c = DB_COLABS.find(u => u.rut === a.rut_responsable); return c && c.estado_contractual === 'Cesado'; });
            title = "Equipos en manos de Cesados"; break;
    }
    renderTablaHome(data, title);
}

function getStatusBadge(estado) {
    let cls = 'status-green';
    if(estado === 'Asignado') cls = 'status-blue';
    if(estado === 'Mantenci贸n') cls = 'status-orange';
    if(estado === 'Baja' || estado === 'Cesado') cls = 'status-red';
    return `<span class="status-badge ${cls}">${estado}</span>`;
}

function renderTablaHome(data, title) {
    safeSetText('homeTableTitle', title);
    const b = document.getElementById('lastMovesTable');
    if(!b) return;
    if(data.length === 0) { b.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px; color:#64748b;">No hay datos para esta selecci贸n</td></tr>'; return; }
    b.innerHTML = data.map(a => {
        const c = DB_COLABS.find(x => x.rut === a.rut_responsable) || { nombre: 'N/A' };
        return `<tr>
            <td><div class="click-name" onclick="verUser('${a.rut_responsable}')">${c.nombre}</div><div style="font-size:11px; color:#64748b">${a.rut_responsable}</div></td>
            <td>${getStatusBadge(a.estado)}</td>
            <td><div style="font-weight:600;">${a.ubicacion||'-'}</div><code style="color:var(--primary)">${a.serie}</code></td>
        </tr>`;
    }).join('');
}
function resetHomeTable() { document.querySelectorAll('.kpi-card').forEach(c => c.classList.remove('active')); renderTablaHome(DB_ACTIVOS.slice(0,10), "ltimos Movimientos"); }

function getActionButtons(serie) {
    const histBtn = `<button class="btn-action-outline" title="Ver Historial" onclick="verHistorial('${serie}')"><i class="fas fa-history"></i></button>`;
    if (currentUserRole !== 'admin') return `<div class="action-group">${histBtn}</div>`;
    return `<div class="action-group"><button class="btn-action-outline" title="Editar" onclick="editar('${serie}')"><i class="fas fa-pencil-alt"></i></button><button class="btn-action-outline return" title="Devolver a Bodega" onclick="abrirDevolucion('${serie}')"><i class="fas fa-undo"></i></button>${histBtn}<button class="btn-action-outline delete" title="Eliminar Registro" onclick="eliminarActivo('${serie}')"><i class="fas fa-trash-alt"></i></button></div>`;
}

function renderTablaMaestra() {
    const s = document.getElementById('mainSearch').value.toLowerCase();
    const b = document.getElementById('masterTableBody');
    if(!b) return;
    const filtered = DB_ACTIVOS.filter(a => {
        const c = DB_COLABS.find(col => col.rut === a.rut_responsable) || { nombre: '' };
        return `${a.serie} ${c.nombre} ${a.rut_responsable} ${a.ubicacion}`.toLowerCase().includes(s);
    }).sort((a, b) => (a.rut_responsable || '').localeCompare(b.rut_responsable || ''));

    b.innerHTML = filtered.length ? filtered.map(a => {
        const c = DB_COLABS.find(col => col.rut === a.rut_responsable) || { nombre: 'N/A', estado_contractual: 'Vigente' };
        return `<tr><td style="color:#64748b; font-weight:500;">${a.rut_responsable}</td><td><span class="click-name" onclick="verUser('${a.rut_responsable}')">${c.nombre}</span></td><td>${getStatusBadge(a.estado)}</td><td style="color:${c.estado_contractual==='Cesado'?'#ef4444':'#10b981'}; font-weight:700;">${c.estado_contractual||'Vigente'}</td><td>${c.area}</td><td>${a.ubicacion}</td><td>${a.marca} ${a.modelo}</td><td><code style="color:var(--primary); font-weight:600;">${a.serie}</code></td><td><div style="display:flex; justify-content:center;">${getActionButtons(a.serie)}</div></td></tr>`;
    }).join('') : '<tr><td colspan="9" style="text-align:center; padding:30px; font-style:italic; color:#64748b;">No se encontraron resultados</td></tr>';
}

function renderPhoneTable() {
    const inputVal = document.getElementById('phoneSearch').value.toLowerCase();
    const b = document.getElementById('phoneTableBody');
    if(!b) return;
    const filtered = DB_ACTIVOS.filter(a => {
        const tieneData = (a.marca_cel && a.marca_cel.length > 1) || (a.imei_cel && a.imei_cel.length > 1) || (a.imei_sim && a.imei_sim.length > 1) || (a.numero && a.numero.length > 1);
        if (!tieneData) return false;
        const c = DB_COLABS.find(col => col.rut === a.rut_responsable) || { nombre: '' };
        return `${c.nombre} ${a.numero||''} ${a.imei_cel||''} ${a.imei_sim||''}`.toLowerCase().includes(inputVal);
    });
    b.innerHTML = filtered.length ? filtered.map(a => {
        const c = DB_COLABS.find(col => col.rut === a.rut_responsable) || { nombre: 'N/A', area: '-' };
        const marcaMostrar = a.marca_cel || '-'; 
        return `<tr><td><div style="font-weight:700;">${c.nombre}</div><small style="color:#64748b">${c.area}</small></td><td><span style="font-weight:700; color:var(--primary);">${a.numero || '-'}</span></td><td>${marcaMostrar} ${a.modelo_cel||''}</td><td>${a.imei_cel || '-'}</td><td>${a.imei_sim || '-'}</td><td><div style="font-size:11px; max-width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${a.observaciones || ''}</div></td><td><div style="display:flex; justify-content:center;">${getActionButtons(a.serie)}</div></td></tr>`;
    }).join('') : '<tr><td colspan="7" style="text-align:center; padding:30px; color:#64748b;">No hay registros</td></tr>';
}

// --- FUNCIONES RESTANTES ---
let chartCounter=0; function addChart(k='estado', t='bar'){ chartCounter++; const id=`chart_${chartCounter}`; document.getElementById('chartsContainer').innerHTML+=`<div class="chart-card"><div class="chart-header"><select class="chart-select" id="sel_key_${id}" onchange="updateDynamicChart('${id}')"><option value="estado" ${k==='estado'?'selected':''}>Por Estado</option><option value="tienda" ${k==='tienda'?'selected':''}>Por Tienda</option><option value="area" ${k==='area'?'selected':''}>Por rea</option><option value="marca" ${k==='marca'?'selected':''}>Por Marca</option></select><select class="chart-select" id="sel_type_${id}" onchange="updateDynamicChart('${id}')"><option value="bar" ${t==='bar'?'selected':''}>Barras</option><option value="doughnut" ${t==='doughnut'?'selected':''}>Dona</option><option value="line" ${t==='line'?'selected':''}>L铆nea</option></select><i class="fas fa-times btn-remove-chart" onclick="this.parentElement.parentElement.remove()"></i></div><div class="chart-canvas-container"><canvas id="${id}"></canvas></div></div>`; setTimeout(()=>updateDynamicChart(id),100); }
function updateDynamicChart(id){ const ctx=document.getElementById(id).getContext('2d'), k=document.getElementById(`sel_key_${id}`).value, t=document.getElementById(`sel_type_${id}`).value; const ex=Chart.getChart(id); if(ex) ex.destroy(); const d={}; DB_ACTIVOS.forEach(a=>{ let key='N/A'; if(k==='estado') key=a.estado; else if(k==='tienda') key=a.ubicacion; else if(k==='marca') key=a.marca||a.marca_cel; else if(k==='area') { const c=DB_COLABS.find(x=>x.rut===a.rut_responsable); key=c?c.area:'Sin Asignar'; } d[key]=(d[key]||0)+1; }); const c=['#0066CC','#E31837','#10b981','#f59e0b','#64748b']; new Chart(ctx,{type:t,data:{labels:Object.keys(d),datasets:[{label:'Total',data:Object.values(d),backgroundColor:t==='bar'?'#0066CC':c}]},options:{maintainAspectRatio:false,plugins:{legend:{display:t!=='bar',position:'right'}}}}); }
function setupSearchListeners(){ const m=document.getElementById('mainSearch'), p=document.getElementById('phoneSearch'), n=document.getElementById('f_nombre'), r=document.getElementById('f_rut'); if(m) m.addEventListener('input', renderTablaMaestra); if(p) p.addEventListener('input', renderPhoneTable); if(n) n.addEventListener('input',()=>{ const c=DB_COLABS.find(x=>x.nombre===n.value); if(c){ document.getElementById('f_rut').value=c.rut; document.getElementById('f_correo').value=c.correo; setSelect('f_area',c.area); } else { const p=n.value.trim().toLowerCase().split(/\s+/); const ce=document.getElementById('f_correo').value; if(p.length>=2 && (ce===''||ce.includes('@dominospizza.cl'))) document.getElementById('f_correo').value=`${p[0].replace(/[^a-z0-9]/g,'')}.${p[1].replace(/[^a-z0-9]/g,'')}@dominospizza.cl`; } }); if(r) r.addEventListener('blur',()=>{ r.value=formatearRut(r.value); const c=DB_COLABS.find(x=>x.rut===r.value); if(c){ document.getElementById('f_nombre').value=c.nombre; document.getElementById('f_correo').value=c.correo; setSelect('f_area',c.area); } }); }
async function registrarMovimiento(s,a,d){ try{ await sb.from('historial_activos').insert({serie:s,accion:a,descripcion:d,usuario_editor:currentUserEmail}); }catch(e){} }
async function verHistorial(s){ document.getElementById('modalHistorial').classList.remove('hidden'); document.getElementById('historialContent').innerHTML='Cargando...'; const {data}=await sb.from('historial_activos').select('*').eq('serie',s).order('created_at',{ascending:false}); if(!data||!data.length){ document.getElementById('historialContent').innerHTML='<p style="text-align:center;">Sin historial.</p>'; return; } document.getElementById('historialContent').innerHTML=`<ul class="timeline">${data.map(h=>`<li class="timeline-item"><div class="timeline-date">${new Date(h.created_at).toLocaleString()}</div><div class="timeline-content"><div style="font-weight:700; color:var(--primary)">${h.accion}</div><div style="font-size:12px;">${h.descripcion}</div><div style="font-size:10px; color:#94a3b8; margin-top:4px;">Por: ${h.usuario_editor||'Sistema'}</div></div></li>`).join('')}</ul>`; }
function verificarDuplicados(){ const n={}, e={}, s={}; DB_ACTIVOS.forEach(a=>{ if(a.numero&&a.numero.length>5) n[a.numero]=(n[a.numero]||0)+1; if(a.imei_cel&&a.imei_cel.length>5) e[a.imei_cel]=(e[a.imei_cel]||0)+1; if(a.imei_sim&&a.imei_sim.length>5) s[a.imei_sim]=(s[a.imei_sim]||0)+1; }); const dn=Object.keys(n).filter(k=>n[k]>1), de=Object.keys(e).filter(k=>e[k]>1), ds=Object.keys(s).filter(k=>s[k]>1); let h=''; if(!dn.length&&!de.length&&!ds.length) h='<div style="text-align:center; padding:20px; color:#10b981;"><b>隆Todo limpio!</b></div>'; else { h='<ul style="list-style:none;">'; if(dn.length) h+=`<li><strong>N煤meros Repetidos:</strong> ${dn.join(', ')}</li>`; if(de.length) h+=`<li><strong>IMEIs Repetidos:</strong> ${de.join(', ')}</li>`; if(ds.length) h+=`<li><strong>SIMs Repetidas:</strong> ${ds.join(', ')}</li>`; h+='</ul>'; } document.getElementById('auditContent').innerHTML=h; document.getElementById('modalAudit').classList.remove('hidden'); }
function abrirDevolucion(s){ currentSerieDevolucion=s; document.getElementById('dev_serie').innerText=s; document.getElementById('dev_obs').value=''; document.getElementById('modalDevolucion').classList.remove('hidden'); }
async function procesarDevolucion(){ if(!currentSerieDevolucion) return; const ne=document.getElementById('dev_estado').value, nu=document.getElementById('dev_ubicacion').value, obs=document.getElementById('dev_obs').value; try{ const prev=DB_ACTIVOS.find(a=>a.serie===currentSerieDevolucion); const nm=prev?(DB_COLABS.find(c=>c.rut===prev.rut_responsable)?.nombre||'Desconocido'):'Desconocido'; const {error}=await sb.from('activos').update({rut_responsable:'9.999.999-9',estado:ne,ubicacion:nu,observaciones:obs?`DEVOLUCIN: ${obs}`:'Devuelto'}).eq('serie',currentSerieDevolucion); if(error) throw error; registrarMovimiento(currentSerieDevolucion,'Devoluci贸n',`De: ${nm} -> ${nu}`); showToast("Devoluci贸n exitosa"); document.getElementById('modalDevolucion').classList.add('hidden'); cargarDatos(); }catch(e){ showToast("Error","error"); } }
async function eliminarActivo(s){ if(!confirm("驴Eliminar?")) return; try{ await sb.from('activos').delete().eq('serie',s); registrarMovimiento(s,'Eliminaci贸n','Borrado'); showToast("Eliminado"); cargarDatos(); }catch(e){ showToast("Error","error"); } }
function nuevoRegistro(){ document.querySelectorAll('#modalFicha input').forEach(i=>{i.value='';i.classList.remove('error-input')}); document.querySelectorAll('#modalFicha select').forEach(s=>s.selectedIndex=0); document.getElementById('sw_equipo').checked=false; document.getElementById('sw_sim').checked=false; toggleTelefonia(); document.getElementById('modalFicha').classList.remove('hidden'); }
function editar(s){ const a=DB_ACTIVOS.find(x=>x.serie===s); if(!a) return; const c=DB_COLABS.find(x=>x.rut===a.rut_responsable)||{}; document.getElementById('f_rut').value=a.rut_responsable; document.getElementById('f_nombre').value=c.nombre||''; document.getElementById('f_correo').value=c.correo||''; setSelect('f_area',c.area); setSelect('f_tienda',a.ubicacion); setSelect('f_contractual',c.estado_contractual); setSelect('f_estado',a.estado); document.getElementById('f_marca').value=a.marca; document.getElementById('f_modelo').value=a.modelo; document.getElementById('f_serie').value=a.serie; document.getElementById('f_fecha_ent').value=a.fecha_entrega; document.getElementById('f_ent_it').value=a.entrega_it||''; document.getElementById('f_obs').value=a.observaciones||''; document.getElementById('sw_equipo').checked=!!a.marca_cel; document.getElementById('sw_sim').checked=!!a.imei_sim; document.getElementById('f_numero').value=a.numero||''; document.getElementById('f_mar_cel').value=a.marca_cel||''; document.getElementById('f_mod_cel').value=a.modelo_cel||''; document.getElementById('f_imei').value=a.imei_cel||''; document.getElementById('f_imsi').value=a.imei_sim||''; toggleTelefonia(); document.getElementById('modalFicha').classList.remove('hidden'); }
async function guardarTodoSincronizado(){ const btn=document.getElementById('btnSave'), rut=document.getElementById('f_rut').value.trim(), serie=document.getElementById('f_serie').value.trim(), nom=document.getElementById('f_nombre').value; if(!rut||!serie) return showToast("Faltan datos","error"); const exist=DB_ACTIVOS.find(a=>a.serie===serie); if(exist&&exist.rut_responsable&&exist.rut_responsable!==rut) return showToast(`Asignado a otro usuario.`,"error"); btn.innerText="PROCESANDO..."; btn.disabled=true; const prev=DB_ACTIVOS.find(a=>a.serie===serie); let acc='Edici贸n', desc=`Actualizado por ${currentUserEmail}`; if(!prev){ acc='Alta'; desc=`Nuevo ingreso. Asignado a: ${nom}`; } else if(prev.rut_responsable!==rut){ const nm=(DB_COLABS.find(c=>c.rut===prev.rut_responsable)?.nombre||'Bodega'); acc='Transferencia'; desc=`De ${nm} -> A ${nom}`; } const colab={rut,nombre:nom,correo:document.getElementById('f_correo').value,area:document.getElementById('f_area').value,estado_contractual:document.getElementById('f_contractual').value}; const activo={serie,rut_responsable:rut,marca:document.getElementById('f_marca').value,modelo:document.getElementById('f_modelo').value,estado:document.getElementById('f_estado').value,ubicacion:document.getElementById('f_tienda').value,fecha_entrega:document.getElementById('f_fecha_ent').value,entrega_it:document.getElementById('f_ent_it').value,observaciones:document.getElementById('f_obs').value,numero:document.getElementById('f_numero').value,marca_cel:document.getElementById('sw_equipo').checked?document.getElementById('f_mar_cel').value:null,modelo_cel:document.getElementById('sw_equipo').checked?document.getElementById('f_mod_cel').value:null,imei_cel:document.getElementById('sw_equipo').checked?document.getElementById('f_imei').value:null,imei_sim:document.getElementById('sw_sim').checked?document.getElementById('f_imsi').value:null}; try{ await sb.from('colaboradores').upsert(colab,{onConflict:'rut'}); await sb.from('activos').upsert(activo,{onConflict:'serie'}); registrarMovimiento(serie,acc,desc); showToast("Guardado"); cerrarFicha(); cargarDatos(); }catch(e){ showToast("Error","error"); } finally{ btn.innerText="GUARDAR"; btn.disabled=false; } }

// --- FUNCIN VER USUARIO (MODAL MEJORADO CON ICONOS) ---
function verUser(rut){
    const c = DB_COLABS.find(x => x.rut === rut);
    if(!c) return;
    const activos = DB_ACTIVOS.filter(x => x.rut_responsable === rut);

    const html = `
        <div class="user-header">
            <div class="user-avatar">${c.nombre.charAt(0)}</div>
            <div>
                <h3 style="margin:0;font-size:20px;">${c.nombre}</h3>
                <p style="color:#64748b;">${c.rut} | ${c.area}</p>
            </div>
        </div>
        <h4 style="color:var(--primary); margin-bottom:15px;">Equipos Asignados (${activos.length})</h4>
        <ul class="asset-list">
            ${activos.map(a => {
                let content = '';
                // 1. PC
                if(a.marca && a.marca.length > 1) {
                    content += `<div class="asset-block"><div class="asset-icon-box icon-pc"><i class="fas fa-laptop"></i></div><div class="asset-info"><h5>${a.marca} ${a.modelo}</h5><p>Serie: ${a.serie}</p></div></div>`;
                }
                // 2. Celular
                if((a.marca_cel && a.marca_cel.length > 1) || (a.imei_cel && a.imei_cel.length > 1)) {
                    content += `<div class="asset-block"><div class="asset-icon-box icon-phone"><i class="fas fa-mobile-alt"></i></div><div class="asset-info"><h5>${a.marca_cel || 'Celular'} ${a.modelo_cel||''}</h5><p>IMEI: ${a.imei_cel || 'N/A'}</p></div></div>`;
                }
                // 3. SIM
                if((a.imei_sim && a.imei_sim.length > 1) || (a.numero && a.numero.length > 1)) {
                    content += `<div class="asset-block"><div class="asset-icon-box icon-sim"><i class="fas fa-sim-card"></i></div><div class="asset-info"><h5>SIM / Chip</h5><p>N潞: ${a.numero || 'N/A'} | IMSI: ${a.imei_sim || 'N/A'}</p></div></div>`;
                }
                // Fallback
                if(content === '') content = `<div style="color:#94a3b8; font-style:italic;">Registro base (Sin detalle espec铆fico)</div><div style="font-size:11px;">S/N: ${a.serie}</div>`;

                return `<li class="asset-item">
                    ${content}
                    <div style="text-align:right; margin-top:5px;">${getStatusBadge(a.estado)}</div>
                </li>`;
            }).join('')}
        </ul>`;
    document.getElementById('userProfileContent').innerHTML = html;
    document.getElementById('modalVerUsuario').classList.remove('hidden');
}

function procesarCSV(){ const f=document.getElementById('csvFile').files[0]; if(!f) return showToast("Sin archivo","error"); const r=new FileReader(); r.readAsText(f); r.onload=(e)=>{ showToast("Carga CSV iniciada"); cargarDatos(); }; }
function setSelect(id,v){ const e=document.getElementById(id); if(e) e.value=v; }
function toggleTelefonia(){ const eq=document.getElementById('sw_equipo').checked, sim=document.getElementById('sw_sim').checked; ['f_mar_cel','f_mod_cel','f_imei'].forEach(id=>{const el=document.getElementById(id);el.disabled=!eq;el.classList.toggle('disabled-field',!eq);if(!eq)el.value=''}); const el=document.getElementById('f_imsi');el.disabled=!sim;el.classList.toggle('disabled-field',!sim);if(!sim)el.value=''; }
function formatearRut(r){ if(!r) return ''; let v=r.replace(/\./g,'').replace(/-/g,'').toLowerCase().trim(); if(v.length<2) return v; return v.slice(0,-1).replace(/\B(?=(\d{3})+(?!\d))/g,".")+"-"+v.slice(-1); }
function formatearFechaCSV(s){ if(!s) return null; const p=s.split(/[\/-]/); return (p.length===3&&p[2].length===4)?`${p[2]}-${p[1]}-${p[0]}`:s; }
function showView(v){ document.querySelectorAll('.content-area > div').forEach(d=>d.classList.add('hidden')); document.getElementById('view-'+v).classList.remove('hidden'); document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); if(v==='telephony') document.getElementById('btn-phone').classList.add('active'); if(v==='home') document.getElementById('btn-home').classList.add('active'); if(v==='inventory') document.getElementById('btn-inv').classList.add('active'); if(v==='metrics') document.getElementById('btn-metrics').classList.add('active'); }
function abrirFicha(){ document.getElementById('modalFicha').classList.remove('hidden'); setupListeners(); }
function cerrarFicha(){ document.getElementById('modalFicha').classList.add('hidden'); }

initSystem();
</script>
</body>
</html>
