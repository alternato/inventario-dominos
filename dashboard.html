<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - TI Maestro v70.2</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { --primary: #0066CC; --secondary: #E31837; --success: #22c55e; --bg: #f8fafc; --border: #e2e8f0; --dark: #0f172a; --radius: 12px; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); height: 100vh; display: flex; font-size: 13px; overflow: hidden; }
        
        #sidebar { width: 260px; background: linear-gradient(180deg, var(--primary) 0%, #0052a3 100%); color: white; padding: 25px; display: flex; flex-direction: column; flex-shrink: 0; }
        .logo-img { width: 120px; height: auto; margin-bottom: 30px; align-self: center; filter: drop-shadow(0 0 5px rgba(255,255,255,0.2)); }
        .nav-btn { background: rgba(255,255,255,0.1); color: white; border: none; padding: 12px 15px; border-radius: 8px; width: 100%; margin-bottom: 8px; text-align: left; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; }
        .nav-btn:hover { background: rgba(255,255,255,0.2); }
        .nav-btn.active { background: var(--secondary); font-weight: 700; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        .main-container { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        header { background: white; padding: 18px 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .content-area { padding: 25px; overflow-y: auto; flex-grow: 1; }
        
        /* DASHBOARD GRID */
        .dashboard-top { display: grid; grid-template-columns: 3fr 1fr; gap: 20px; margin-bottom: 20px; }
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .kpi-card { background: white; padding: 20px; border-radius: var(--radius); border: 1px solid var(--border); display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .kpi-icon { width: 45px; height: 45px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; }
        .kpi-info h3 { font-size: 24px; font-weight: 800; color: var(--dark); margin: 0; }
        .kpi-info p { font-size: 11px; color: #64748b; font-weight: 600; text-transform: uppercase; margin: 0; }
        .graph-card { background: white; border-radius: var(--radius); border: 1px solid var(--border); padding: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        /* TABLAS */
        .table-wrapper { background: white; padding: 20px; border-radius: var(--radius); border: 1px solid var(--border); display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; }
        .table-scroll { overflow: auto; width: 100%; }
        table { width: 100%; border-collapse: collapse; table-layout: auto; }
        th { background: #f1f5f9; padding: 12px; text-align: left; position: sticky; top: 0; z-index: 10; font-size: 11px; text-transform: uppercase; border-bottom: 2px solid var(--border); white-space: nowrap; color: #64748b; font-weight: 700; }
        td { padding: 10px 12px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; color: #334155; }
        tr:hover td { background-color: #f8fafc; }

        .csv-panel { background: #fff; border: 2px dashed var(--primary); padding: 15px; border-radius: var(--radius); margin-bottom: 20px; align-items: center; gap: 20px; }

        /* TOAST */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-left: 5px solid; display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s ease-out; font-weight: 600; }
        .toast.success { border-color: var(--success); } .toast.error { border-color: var(--secondary); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* UTILS */
        .hidden { display: none !important; }
        .admin-only { display: none !important; }
        body.role-admin .admin-only { display: flex !important; }
        
        .role-badge { font-size: 10px; padding: 2px 8px; border-radius: 12px; text-transform: uppercase; font-weight: 800; margin-left: 10px; }
        .badge-viewer { background: #f1f5f9; color: #64748b; border: 1px solid #cbd5e1; }
        .badge-admin { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }

        /* MODAL FORM */
        .modal { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(2px); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 95%; max-width: 1100px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .form-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .field { display: flex; flex-direction: column; gap: 5px; }
        .field label { font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; }
        input, select, textarea { padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; transition: 0.2s; }
        input:focus, select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(0,102,204,0.1); }
        .error-input { border-color: var(--secondary) !important; background-color: #fff1f2; }
        .section-tag { grid-column: span 4; color: var(--primary); font-weight: 800; border-bottom: 2px solid #f1f5f9; padding-bottom: 5px; margin: 20px 0 10px 0; font-size: 12px; }
        
        .switch-box { display: flex; align-items: center; gap: 10px; background: #f8fafc; padding: 8px 12px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .toggle { position: relative; display: inline-block; width: 36px; height: 20px; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #cbd5e1; transition: .3s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(16px); }
        .disabled-field { background-color: #f1f5f9 !important; color: #94a3b8 !important; cursor: not-allowed !important; }

        /* USER PROFILE DETAILED */
        .click-name { cursor: pointer; color: var(--primary); font-weight: 700; text-decoration: none; border-bottom: 1px dotted var(--primary); }
        .click-name:hover { color: #004488; border-bottom-style: solid; }
        .user-header { display: flex; align-items: center; gap: 20px; margin-bottom: 25px; border-bottom: 1px solid #e2e8f0; padding-bottom: 20px; }
        .user-avatar { width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 26px; font-weight: 700; }
        .asset-list { list-style: none; padding: 0; }
        .asset-item { border: 1px solid #e2e8f0; margin-bottom: 10px; border-radius: 8px; background: #fff; padding: 15px; }
        .asset-detail-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .asset-icon { width: 24px; text-align: center; display: inline-block; margin-right: 8px; color: var(--primary); }
        .separator { border-top: 1px dashed #e2e8f0; margin: 8px 0; }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <aside id="sidebar">
        <img src="https://logos-world.net/wp-content/uploads/2021/08/Dominos-Logo.png" class="logo-img">
        <button class="nav-btn active" id="btn-home" onclick="showView('home')"><i class="fas fa-home"></i> Inicio</button>
        <button class="nav-btn" id="btn-inv" onclick="showView('inventory')"><i class="fas fa-boxes"></i> Inventario Data</button>
        <button class="nav-btn" id="btn-metrics" onclick="showView('metrics')"><i class="fas fa-chart-pie"></i> Reportes TI</button>
        <hr style="margin: 20px 0; opacity: 0.2;">
        <button class="nav-btn admin-only" style="background: var(--success);" onclick="nuevoRegistro()"><i class="fas fa-plus-circle"></i> NUEVO REGISTRO</button>
        <button class="nav-btn" style="background: rgba(0,0,0,0.3); margin-top: auto;" onclick="cerrarSesion()"><i class="fas fa-sign-out-alt"></i> Salir</button>
    </aside>

    <main class="main-container">
        <header>
            <h2 id="viewTitle">Dashboard General</h2>
            <div id="sync" style="font-size: 12px; color: #334155; font-weight: 600; display:flex; align-items:center;">
                <span id="userEmail" style="margin-right: 5px;">Cargando...</span>
                <span id="userRoleBadge" class="role-badge badge-viewer">...</span>
            </div>
        </header>
        
        <div class="content-area">
            
            <div id="view-home">
                <div class="dashboard-top">
                    <div class="kpi-grid">
                        <div class="kpi-card"><div class="kpi-icon" style="background: var(--primary);"><i class="fas fa-laptop"></i></div><div class="kpi-info"><h3 id="kpi-total">0</h3><p>Total Activos</p></div></div>
                        <div class="kpi-card"><div class="kpi-icon" style="background: var(--success);"><i class="fas fa-check-circle"></i></div><div class="kpi-info"><h3 id="kpi-dispo">0</h3><p>Stock Disponible</p></div></div>
                        <div class="kpi-card"><div class="kpi-icon" style="background: #f59e0b;"><i class="fas fa-tools"></i></div><div class="kpi-info"><h3 id="kpi-mant">0</h3><p>En Mantenci贸n</p></div></div>
                        <div class="kpi-card"><div class="kpi-icon" style="background: var(--secondary);"><i class="fas fa-user-slash"></i></div><div class="kpi-info"><h3 id="kpi-cesados">0</h3><p>Equipos en Cesados</p></div></div>
                    </div>
                    <div class="graph-card">
                        <div style="font-size: 10px; font-weight: 800; color: var(--primary); text-transform: uppercase; margin-bottom: 5px;">Distribuci贸n</div>
                        <div style="height: 100px; width: 100%; position: relative;"><canvas id="chartMini"></canvas></div>
                    </div>
                </div>

                <div class="table-wrapper">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 id="homeTableTitle" style="color: var(--primary); margin: 0; font-size: 16px;">ltimos Movimientos</h4>
                        <button onclick="resetHomeTable()" style="font-size: 11px; background: #f1f5f9; border: 1px solid #e2e8f0; padding: 6px 12px; border-radius: 6px; cursor: pointer; color: var(--dark); font-weight:600;">Ver Todo</button>
                    </div>
                    <div class="table-scroll">
                        <table style="width: 100%;">
                            <thead><tr><th style="width: 40%;">Nombre / RUT</th><th style="width: 20%;">Estado</th><th style="width: 40%;">Ubicaci贸n / Serie</th></tr></thead>
                            <tbody id="lastMovesTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-inventory" class="hidden">
                <div class="csv-panel admin-only">
                    <div><label style="display:block; font-size:10px; font-weight:800; color:var(--primary); margin-bottom:5px;">CARGA MASIVA CSV</label><input type="file" id="csvFile" accept=".csv"></div>
                    <button onclick="procesarCSV()" id="btnCsv" class="nav-btn" style="width:auto; background:var(--dark); margin:0; padding: 8px 16px;"><i class="fas fa-upload"></i> PROCESAR</button>
                </div>
                <input type="search" id="mainSearch" placeholder=" Buscar por RUT, Nombre, Serie..." style="width: 100%; margin-bottom: 15px; padding: 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px;" oninput="renderMasterTable()" onsearch="renderMasterTable()">
                <div class="table-wrapper">
                    <div class="table-scroll">
                        <table>
                            <thead><tr><th>RUT</th><th>Responsable</th><th>Estado</th><th>Contrato</th><th>rea</th><th>Tienda</th><th>Modelo</th><th>Serie</th><th class="admin-only">Acci贸n</th></tr></thead>
                            <tbody id="masterTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-metrics" class="hidden">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div style="background:white; padding:20px; border-radius:12px; height: 400px;"><canvas id="chartArea"></canvas></div>
                    <div style="background:white; padding:20px; border-radius:12px; height: 400px;"><canvas id="chartEstado"></canvas></div>
                </div>
            </div>
        </div>
    </main>

    <div id="modalFicha" class="modal hidden">
        <div class="modal-content">
            <h2 style="color: var(--primary); margin-bottom: 20px;">Ficha T茅cnica</h2>
            <div class="form-grid">
                <div class="section-tag">1. Colaborador</div>
                <div class="field"><label>RUT *</label><input type="text" id="f_rut" placeholder="Ej: 11.222.333-k"></div>
                <div class="field" style="grid-column: span 2;"><label>Nombre Completo</label><input type="text" id="f_nombre" list="listaNombres"><datalist id="listaNombres"></datalist></div>
                <div class="field"><label>Correo</label><input type="email" id="f_correo"></div>
                <div class="field"><label>rea</label><select id="f_area">
                    <option>Operaciones</option>
                    <option>Inform谩tica</option>
                    <option>Administraci贸n</option>
                    <option>Marketing</option>
                    <option>Log铆stica</option>
                    <option>Finanzas</option>
                    <option>RRHH</option>
                </select></div>
                <div class="field"><label>Tienda / Ubicaci贸n</label><select id="f_tienda"></select></div>
                <div class="field"><label>Contrato</label><select id="f_contractual"><option>Vigente</option><option>Cesado</option></select></div>

                <div class="section-tag">2. Equipo PC</div>
                <div class="field"><label>Marca PC</label><input type="text" id="f_marca"></div>
                <div class="field"><label>Modelo PC</label><input type="text" id="f_modelo"></div>
                <div class="field"><label>Serie PC *</label><input type="text" id="f_serie"></div>
                <div class="field"><label>Estado Asignaci贸n</label><select id="f_estado"><option>Asignado</option><option>Disponible</option><option>Mantenci贸n</option></select></div>
                
                <div class="section-tag">3. Telefon铆a M贸vil</div>
                <div class="switch-box"><label class="toggle"><input type="checkbox" id="sw_equipo" onchange="toggleTelefonia()"><span class="slider"></span></label><span>Equipo Celular</span></div>
                <div class="switch-box"><label class="toggle"><input type="checkbox" id="sw_sim" onchange="toggleTelefonia()"><span class="slider"></span></label><span>SIM Card</span></div>
                <div class="field"><label>Marca Cel</label><input type="text" id="f_mar_cel" class="disabled-field" disabled></div>
                <div class="field"><label>Modelo Cel</label><input type="text" id="f_mod_cel" class="disabled-field" disabled></div>
                <div class="field"><label>IMEI Equipo</label><input type="text" id="f_imei" class="disabled-field" disabled></div>
                <div class="field"><label>IMSI (SIM)</label><input type="text" id="f_imsi" class="disabled-field" disabled></div>

                <div class="section-tag">4. Control & Auditor铆a</div>
                <div class="field"><label>Fecha Entrega</label><input type="date" id="f_fecha_ent"></div>
                <div class="field"><label>Entregado Por (IT)</label><input type="text" id="f_ent_it"></div>
                <div class="field" style="grid-column: span 2;"><label>Observaciones</label><input type="text" id="f_obs"></div>
            </div>
            <div style="margin-top: 25px; text-align: right; border-top: 1px solid #f1f5f9; padding-top: 20px;">
                <button onclick="cerrarFicha()" style="padding:10px 20px; border:none; background:#f1f5f9; color:#64748b; cursor:pointer; border-radius:6px; margin-right: 10px; font-weight:600;">Cancelar</button>
                <button onclick="guardarTodoSincronizado()" id="btnSave" style="padding:10px 25px; border:none; background:var(--primary); color:white; font-weight:700; cursor:pointer; border-radius:6px;">GUARDAR</button>
            </div>
        </div>
    </div>

    <div id="modalVerUsuario" class="modal hidden" style="z-index: 1100;">
        <div class="modal-content" style="max-width: 600px;">
            <div id="userProfileContent"></div>
            <div style="text-align: right; margin-top: 20px;"><button onclick="document.getElementById('modalVerUsuario').classList.add('hidden')" style="background:var(--dark); color:white; padding:8px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:600;">Cerrar</button></div>
        </div>
    </div>

<script>
if(typeof ChartDataLabels!=='undefined') Chart.register(ChartDataLabels);
const CONFIG = { URL: "https://ivjwxvhixrskraepqzse.supabase.co", KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2and4dmhpeHJza3JhZXBxenNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MjgxNTgsImV4cCI6MjA4NDUwNDE1OH0.QzgNSwqf6VTXZjGMXOAfUnjW4f1mJcRqECxxNnLZc-o" };
let sb; try { sb = window.supabase.createClient(CONFIG.URL, CONFIG.KEY); } catch(e) { console.error(e); }

// --- LISTA DE TIENDAS REAL ---
const TIENDAS = [
    "Antofagasta - Estadio Regional", "Antofagasta - Sector Norte", "Arica", "Buin", "Bustamante", "Calama", 
    "Chiguayante", "Chill谩n", "Concepcion - Plaza Acevedo", "Conc贸n", "Copiap贸", "Curic贸", "Froilan Roa", 
    "General Velasquez", "Gran Avenida", "Hualp茅n", "Iquique", "Irarr谩zaval", "La Florida (Santa Amalia)", 
    "La Serena (Balmaceda)", "Lautaro", "Luis Pasteur", "Machal铆", "Macul", "Maipu 1", "Mall del Centro*", 
    "Mall Paseo Los Dominicos", "Manuel Montt", "Osorno 2 Centro", "Osorno 1 Rahue", "Parque Angamos", 
    "Pedro Fontova", "Pe帽alol茅n", "Plaza Atenas", "Pto. Montt 2 (Cardonal)", "Pto. Montt 1 (Ejercito)", 
    "Puente Alto", "Punta Arenas", "Quilicura", "Quilpu茅", "Recoleta", "San Francisco", "San Pedro de la Paz", 
    "Santa Ana", "La Serena (B. Universitario)", "Talca", "Temuco", "Tobalaba", "Vi帽a del Mar", "Commisary"
];

let DB_ACTIVOS = [], DB_COLABS = [], charts = {}, currentUserRole = 'viewer';

function showToast(msg, type='success') {
    const d = document.createElement('div'); d.className = `toast ${type}`;
    d.innerHTML = `<i class="fas fa-${type==='success'?'check-circle':'exclamation-circle'}"></i> ${msg}`;
    document.getElementById('toast-container').appendChild(d);
    setTimeout(() => d.remove(), 3000);
}

// --- SYSTEM START ---
function initSystem() {
    if(localStorage.getItem('manualAuth') === 'true') { loadApp("Admin Local", "admin"); return; }
    sb.auth.getSession().then(({ data: { session } }) => {
        if (!session) window.location.href = 'index.html'; else checkUserRole(session.user.email);
    });
}

async function checkUserRole(email) {
    let role = 'viewer';
    try { const { data } = await sb.from('user_roles').select('role').eq('email', email).single(); if(data) role = data.role; } catch(e) {}
    loadApp(email, role);
}

function loadApp(email, role) {
    document.getElementById('userEmail').innerText = email;
    currentUserRole = role;
    const badge = document.getElementById('userRoleBadge');
    if(role === 'admin') {
        document.body.classList.add('role-admin');
        badge.className = 'role-badge badge-admin'; badge.innerText = 'ADMINISTRADOR';
    } else {
        document.body.classList.remove('role-admin');
        badge.className = 'role-badge badge-viewer'; badge.innerText = 'VISUALIZADOR';
    }
    document.getElementById('f_tienda').innerHTML = TIENDAS.map(t=>`<option>${t}</option>`).join('');
    cargarDatos();
}

function cerrarSesion() { sb.auth.signOut(); localStorage.removeItem('manualAuth'); window.location.href = 'index.html'; }

// --- DATA FETCH ---
async function cargarDatos() {
    const [resA, resC] = await Promise.all([sb.from('activos').select('*'), sb.from('colaboradores').select('*')]);
    if(resA.data) DB_ACTIVOS = resA.data.sort((a,b)=> new Date(b.created_at||0) - new Date(a.created_at||0));
    if(resC.data) DB_COLABS = resC.data;
    document.getElementById('listaNombres').innerHTML = DB_COLABS.map(c=>`<option value="${c.nombre}">`).join('');
    actualizarDashboard(); renderTablaMaestra(); initCharts();
}

// --- DASHBOARD ---
function actualizarDashboard() {
    const total = DB_ACTIVOS.length;
    const disp = DB_ACTIVOS.filter(a=>a.estado==='Disponible').length;
    const mant = DB_ACTIVOS.filter(a=>a.estado==='Mantenci贸n').length;
    let ces = 0; DB_ACTIVOS.forEach(a=>{ const c=DB_COLABS.find(x=>x.rut===a.rut_responsable); if(c && c.estado_contractual==='Cesado') ces++; });

    document.getElementById('kpi-total').innerText = total; document.getElementById('kpi-dispo').innerText = disp;
    document.getElementById('kpi-mant').innerText = mant; document.getElementById('kpi-cesados').innerText = ces;
    renderTablaHome(DB_ACTIVOS.slice(0,10), "ltimos Movimientos");

    if(charts.mini) charts.mini.destroy();
    charts.mini = new Chart(document.getElementById('chartMini').getContext('2d'), {
        type: 'doughnut',
        data: { labels: ['Disp', 'Asig', 'Mant'], datasets: [{ data: [disp, total-disp-mant, mant], backgroundColor: ['#22c55e','#0066CC','#f59e0b'] }] },
        options: { maintainAspectRatio: false, plugins: { legend: {display:false}, datalabels: {color:'white', font:{weight:'bold'}} }, onClick: (e,el)=>{ if(el.length>0){ const l=charts.mini.data.labels[el[0].index]; renderTablaHome(DB_ACTIVOS.filter(a=>a.estado.includes(l.substring(0,3))), `Filtro: ${l}`); } } }
    });
}

function renderTablaHome(data, title) {
    document.getElementById('homeTableTitle').innerText = title;
    const b = document.getElementById('lastMovesTable');
    b.innerHTML = data.length ? data.map(a => {
        const c = DB_COLABS.find(x => x.rut === a.rut_responsable) || { nombre: 'N/A' };
        return `<tr>
            <td>
                <div class="click-name" onclick="verUser('${a.rut_responsable}')" style="font-size:13px;">${c.nombre}</div>
                <div style="font-size:10px; color:#64748b">${a.rut_responsable}</div>
            </td>
            <td><span style="font-size:10px; padding:2px 6px; border-radius:4px; font-weight:600; background:${a.estado==='Disponible'?'#dcfce7':(a.estado==='Mantenci贸n'?'#ffedd5':'#f1f5f9')}; color:${a.estado==='Disponible'?'#166534':(a.estado==='Mantenci贸n'?'#9a3412':'#334155')}">${a.estado}</span></td>
            <td><div style="font-weight:600; font-size:12px;">${a.ubicacion||'-'}</div><code style="font-size:10px; color:var(--primary)">${a.serie}</code></td>
        </tr>`;
    }).join('') : '<tr><td colspan="3" style="text-align:center; padding:15px; color:#94a3b8;">Sin datos recientes</td></tr>';
}
function resetHomeTable() { renderTablaHome(DB_ACTIVOS.slice(0,10), "ltimos Movimientos"); }

// --- TABLA MAESTRA ---
function renderTablaMaestra() {
    const inputVal = document.getElementById('mainSearch').value;
    const s = inputVal ? inputVal.toLowerCase() : "";
    const b = document.getElementById('masterTableBody');
    let lastRut = null;
    
    const filtered = DB_ACTIVOS.filter(a => {
        if(!s) return true;
        const c = DB_COLABS.find(col => col.rut === a.rut_responsable) || { nombre: '' };
        return `${a.serie} ${c.nombre} ${a.rut_responsable} ${a.ubicacion}`.toLowerCase().includes(s);
    }).sort((a, b) => (a.rut_responsable || '').localeCompare(b.rut_responsable || ''));

    b.innerHTML = filtered.length ? filtered.map(a => {
        const c = DB_COLABS.find(col => col.rut === a.rut_responsable) || { nombre: 'N/A', estado_contractual: 'Vigente' };
        const isSame = lastRut === a.rut_responsable; lastRut = a.rut_responsable;
        const border = isSame ? 'border-top:none;' : 'border-top:1px solid #e2e8f0;';
        const opacity = isSame ? 'opacity:0; pointer-events:none;' : '';
        const action = currentUserRole==='admin' ? `<i class="fas fa-edit" style="cursor:pointer; color:var(--primary); font-size:14px;" onclick="editar('${a.serie}')"></i>` : `<i class="fas fa-eye" style="cursor:pointer; color:#94a3b8" onclick="verUser('${a.rut_responsable}')"></i>`;

        return `<tr style="${border}">
            <td style="${opacity} color:#64748b">${a.rut_responsable}</td>
            <td style="${opacity}" class="click-name" onclick="verUser('${a.rut_responsable}')">${c.nombre}</td>
            <td>${a.estado}</td>
            <td style="${opacity} color:${c.estado_contractual==='Cesado'?'#b91c1c':'#166534'}; font-weight:700;">${c.estado_contractual||'Vigente'}</td>
            <td style="${opacity}">${c.area}</td>
            <td style="${opacity}">${a.ubicacion}</td>
            <td>${a.marca} ${a.modelo}</td>
            <td><code style="color:var(--primary); font-weight:600;">${a.serie}</code></td>
            <td>${action}</td>
        </tr>`;
    }).join('') : '<tr><td colspan="9" style="text-align:center; padding:20px; font-style:italic; color:#64748b;">No se encontraron resultados</td></tr>';
}

// --- CRUD ---
function nuevoRegistro() {
    document.querySelectorAll('#modalFicha input').forEach(i => { i.value = ''; i.classList.remove('error-input'); });
    document.querySelectorAll('#modalFicha select').forEach(s => s.selectedIndex = 0);
    document.getElementById('sw_equipo').checked = false;
    document.getElementById('sw_sim').checked = false;
    toggleTelefonia(); 
    document.getElementById('modalFicha').classList.remove('hidden');
}

function editar(serie) {
    const a = DB_ACTIVOS.find(x=>x.serie===serie); if(!a) return;
    const c = DB_COLABS.find(x=>x.rut===a.rut_responsable) || {};
    document.getElementById('f_rut').value = a.rut_responsable;
    document.getElementById('f_nombre').value = c.nombre||'';
    document.getElementById('f_correo').value = c.correo||'';
    setSelect('f_area', c.area); setSelect('f_tienda', a.ubicacion); 
    setSelect('f_contractual', c.estado_contractual); setSelect('f_estado', a.estado);
    document.getElementById('f_marca').value = a.marca;
    document.getElementById('f_modelo').value = a.modelo;
    document.getElementById('f_serie').value = a.serie;
    document.getElementById('f_fecha_ent').value = a.fecha_entrega;
    document.getElementById('f_ent_it').value = a.entrega_it || '';
    document.getElementById('f_obs').value = a.observaciones || '';
    
    document.getElementById('sw_equipo').checked = !!a.marca_cel;
    document.getElementById('sw_sim').checked = !!a.imei_sim;
    document.getElementById('f_mar_cel').value = a.marca_cel || '';
    document.getElementById('f_mod_cel').value = a.modelo_cel || '';
    document.getElementById('f_imei').value = a.imei_cel || '';
    document.getElementById('f_imsi').value = a.imei_sim || '';
    toggleTelefonia();
    document.getElementById('modalFicha').classList.remove('hidden');
}

// --- MODAL USUARIO MEJORADO ---
function verUser(rut) {
    const c = DB_COLABS.find(x => x.rut === rut); if(!c) return;
    const activos = DB_ACTIVOS.filter(x => x.rut_responsable === rut);
    
    const html = `
        <div class="user-header">
            <div class="user-avatar">${c.nombre.charAt(0)}</div>
            <div><h3 style="margin:0; font-size:20px;">${c.nombre}</h3><p style="color:#64748b;">${c.rut} | ${c.area}</p></div>
        </div>
        <h4 style="color:var(--primary); margin-bottom:15px;">Equipos Asignados (${activos.length})</h4>
        <ul class="asset-list">
            ${activos.map(a => `
                <li class="asset-item">
                    <div class="asset-detail-row">
                        <div><span class="asset-icon"><i class="fas fa-laptop"></i></span> <strong>PC:</strong> ${a.marca} ${a.modelo}</div>
                        <code style="color:var(--primary)">${a.serie}</code>
                    </div>
                    ${a.marca_cel ? `
                    <div class="separator"></div>
                    <div class="asset-detail-row">
                        <div><span class="asset-icon"><i class="fas fa-mobile-alt"></i></span> <strong>Cel:</strong> ${a.marca_cel} ${a.modelo_cel}</div>
                        <small>IMEI: ${a.imei_cel}</small>
                    </div>` : ''}
                    ${a.imei_sim ? `
                    <div class="asset-detail-row">
                        <div><span class="asset-icon"><i class="fas fa-sim-card"></i></span> <strong>SIM:</strong> ${a.imei_sim}</div>
                    </div>` : ''}
                    <div style="text-align:right; margin-top:5px;"><span class="role-badge badge-viewer">${a.estado}</span></div>
                </li>
            `).join('')}
        </ul>`;
    document.getElementById('userProfileContent').innerHTML = html;
    document.getElementById('modalVerUsuario').classList.remove('hidden');
}

async function guardarTodoSincronizado() {
    const btn = document.getElementById('btnSave');
    const rut = document.getElementById('f_rut').value.trim(); 
    const serie = document.getElementById('f_serie').value.trim();
    if(!rut || !serie) { 
        if(!rut) document.getElementById('f_rut').classList.add('error-input');
        if(!serie) document.getElementById('f_serie').classList.add('error-input');
        return showToast("Faltan campos (RUT o Serie)", "error"); 
    }
    
    btn.innerText = "PROCESANDO..."; btn.disabled = true;

    const colab = { rut, nombre: document.getElementById('f_nombre').value, correo: document.getElementById('f_correo').value, area: document.getElementById('f_area').value, estado_contractual: document.getElementById('f_contractual').value };
    const activo = { 
        serie, rut_responsable: rut, marca: document.getElementById('f_marca').value, modelo: document.getElementById('f_modelo').value, 
        estado: document.getElementById('f_estado').value, ubicacion: document.getElementById('f_tienda').value, fecha_entrega: document.getElementById('f_fecha_ent').value, 
        entrega_it: document.getElementById('f_ent_it').value, observaciones: document.getElementById('f_obs').value,
        marca_cel: document.getElementById('sw_equipo').checked ? document.getElementById('f_mar_cel').value : null,
        modelo_cel: document.getElementById('sw_equipo').checked ? document.getElementById('f_mod_cel').value : null,
        imei_cel: document.getElementById('sw_equipo').checked ? document.getElementById('f_imei').value : null,
        imei_sim: document.getElementById('sw_sim').checked ? document.getElementById('f_imsi').value : null
    };

    try {
        await sb.from('colaboradores').upsert(colab, {onConflict:'rut'});
        await sb.from('activos').upsert(activo, {onConflict:'serie'});
        showToast("Registro guardado exitosamente"); cerrarFicha(); cargarDatos();
    } catch(e) { console.error(e); showToast("Error al guardar", "error"); } 
    finally { btn.innerText = "GUARDAR"; btn.disabled = false; }
}

async function procesarCSV() {
    const file = document.getElementById('csvFile').files[0]; if (!file) return showToast("Selecciona CSV", "error");
    const btn = document.getElementById('btnCsv'); btn.innerText = "CARGANDO..."; btn.disabled = true;
    const reader = new FileReader(); reader.readAsText(file, 'UTF-8');
    reader.onload = async function(e) {
        const lines = e.target.result.split(/\r?\n/);
        let count = 0;
        for (let i = 1; i < lines.length; i++) {
            if (!lines[i].trim()) continue;
            const col = lines[i].split(',').map(v => v.replace(/^"|"$/g, '').trim());
            if(col.length<5) continue;
            const c = { rut: formatearRut(col[0]), nombre: col[1], correo: col[4], area: col[5], estado_contractual: col[16] || 'Vigente' };
            const a = { serie: col[9], rut_responsable: c.rut, ubicacion: col[6], marca: col[7], modelo: col[8], estado: col[3], fecha_entrega: formatearFechaCSV(col[2]), entrega_it: col[13], observaciones: col[15] };
            sb.from('colaboradores').upsert(c, { onConflict: 'rut' }).then();
            sb.from('activos').upsert(a, { onConflict: 'serie' }).then(); count++;
        }
        setTimeout(() => { showToast(`Procesados ${count} registros`); cargarDatos(); btn.innerText = "PROCESAR"; btn.disabled = false; }, 2000);
    };
}

// UTILS
function formatearRut(rut) { if(!rut) return ''; let v = rut.replace(/\./g, '').replace(/-/g, '').toLowerCase().trim(); if (v.length < 2) return v; return v.slice(0, -1).replace(/\B(?=(\d{3})+(?!\d))/g, ".") + "-" + v.slice(-1); }
function formatearFechaCSV(str) { if(!str) return null; const p = str.split(/[\/-]/); return (p.length === 3 && p[2].length === 4) ? `${p[2]}-${p[1]}-${p[0]}` : str; }
function setSelect(id, val) { const el = document.getElementById(id); if(el) el.value = val; }
function toggleTelefonia() { const eq = document.getElementById('sw_equipo').checked; const sim = document.getElementById('sw_sim').checked; ['f_mar_cel', 'f_mod_cel', 'f_imei'].forEach(id => { const el = document.getElementById(id); el.disabled = !eq; el.classList.toggle('disabled-field', !eq); if(!eq) el.value = ""; }); const simEl = document.getElementById('f_imsi'); simEl.disabled = !sim; simEl.classList.toggle('disabled-field', !sim); if(!sim) simEl.value = ""; }
function setupListeners() { const inputRut = document.getElementById('f_rut'); const inputNombre = document.getElementById('f_nombre'); inputRut.addEventListener('blur', () => { inputRut.value = formatearRut(inputRut.value); const c = DB_COLABS.find(x => x.rut === inputRut.value); if(c) { document.getElementById('f_nombre').value = c.nombre||''; document.getElementById('f_correo').value = c.correo||''; setSelect('f_area', c.area); setSelect('f_contractual', c.estado_contractual); } }); inputNombre.addEventListener('input', () => { const c = DB_COLABS.find(x => x.nombre === inputNombre.value); if(c) { inputRut.value = c.rut; document.getElementById('f_correo').value = c.correo; setSelect('f_area', c.area); setSelect('f_contractual', c.estado_contractual); } }); }
function initCharts() { if(charts.a) charts.a.destroy(); if(charts.e) charts.e.destroy(); const a = {}, e = {}; DB_COLABS.forEach(x => a[x.area] = (a[x.area]||0)+1); DB_ACTIVOS.forEach(x => e[x.estado] = (e[x.estado]||0)+1); charts.a = new Chart(document.getElementById('chartArea').getContext('2d'), { type: 'doughnut', data: { labels: Object.keys(a), datasets: [{ data: Object.values(a), backgroundColor: ['#0066CC','#E31837','#22c55e','#f59e0b'] }] } }); charts.e = new Chart(document.getElementById('chartEstado').getContext('2d'), { type: 'bar', data: { labels: Object.keys(e), datasets: [{ label: 'Total', data: Object.values(e), backgroundColor: '#E31837' }] } }); }
function showView(v) { document.querySelectorAll('.content-area > div').forEach(d=>d.classList.add('hidden')); document.getElementById('view-'+v).classList.remove('hidden'); }
function abrirFicha() { document.getElementById('modalFicha').classList.remove('hidden'); setupListeners(); }
function cerrarFicha() { document.getElementById('modalFicha').classList.add('hidden'); }

// ARRANQUE
initSystem();
</script>
</body>
</html>
