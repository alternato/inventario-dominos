<script>
// 1. INICIALIZACIÓN SEGURA DE LIBRERÍAS
// Registramos el plugin de etiquetas para los gráficos
if (typeof ChartDataLabels !== 'undefined') {
    Chart.register(ChartDataLabels);
}

// 2. CONFIGURACIÓN Y CLIENTE SUPABASE
const CONFIG = {
    URL: "https://ivjwxvhixrskraepqzse.supabase.co",
    KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2and4dmhpeHJza3JhZXBxenNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MjgxNTgsImV4cCI6MjA4NDUwNDE1OH0.QzgNSwqf6VTXZjGMXOAfUnjW4f1mJcRqECxxNnLZc-o"
};

// CORRECCIÓN CRÍTICA: Usamos 'sb' para evitar conflictos de nombre
let sb;
try {
    sb = window.supabase.createClient(CONFIG.URL, CONFIG.KEY);
} catch (err) {
    console.error("Error al iniciar Supabase:", err);
    alert("Error crítico: No se pudo conectar con la base de datos.");
}

const TIENDAS = ["Casa Matriz", "Bodega Central", "Santiago Alameda", "Viña 15 Norte", "Antofagasta Regional", "Concepción", "La Serena", "Puerto Montt"];
let DB_ACTIVOS = []; let DB_COLABS = []; let charts = {}; let currentUserRole = 'viewer';

// --- 3. AUTENTICACIÓN (LOGIN) ---

// Botón: Ingresar con Domino's (Microsoft Entra ID)
async function signInWithMicrosoft() {
    try {
        const { data, error } = await sb.auth.signInWithOAuth({
            provider: 'azure',
            options: {
                scopes: 'email',
                queryParams: { prompt: 'select_account' }
            }
        });
        if (error) throw error;
    } catch (err) {
        alert("Error al conectar con Microsoft: " + err.message);
    }
}

// Botón: Acceso Manual (Respaldo)
function intentarLogin() {
    const pass = document.getElementById('passInput').value;
    if(pass === "DominoTI2026") {
        iniciarSesionManual();
    } else {
        alert("Clave incorrecta");
    }
}

function iniciarSesionManual() {
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    
    // Configuración manual de Admin
    document.getElementById('userEmail').innerText = "Admin Local (Respaldo)";
    document.body.classList.add('role-admin'); 
    
    const badge = document.getElementById('userRoleBadge');
    if(badge) {
        badge.className = 'role-badge badge-admin';
        badge.innerText = 'ADMINISTRADOR';
    }

    llenarSelectores();
    cargarTodo();
}

function cerrarSesion() {
    sb.auth.signOut();
    location.reload(); // Recargar página para limpiar todo
}

// LISTENER: Detectar cuando el usuario vuelve del login de Microsoft
sb.auth.onAuthStateChange(async (event, session) => {
    if (event === 'SIGNED_IN' && session) {
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        document.getElementById('userEmail').innerText = session.user.email;
        
        // Verificar Rol en Base de Datos
        try {
            const { data: roleData } = await sb.from('user_roles')
                .select('role')
                .eq('email', session.user.email)
                .single();
            
            currentUserRole = roleData ? roleData.role : 'viewer';
        } catch (e) {
            currentUserRole = 'viewer'; // Fallback seguro
        }
        
        // Aplicar permisos visuales
        const badge = document.getElementById('userRoleBadge');
        if(currentUserRole === 'admin') {
            document.body.classList.add('role-admin');
            if(badge) { badge.className = 'role-badge badge-admin'; badge.innerText = 'ADMINISTRADOR'; }
        } else {
            document.body.classList.remove('role-admin');
            if(badge) { badge.className = 'role-badge badge-viewer'; badge.innerText = 'VISUALIZADOR'; }
        }

        llenarSelectores();
        cargarTodo();
    }
});

// --- 4. LÓGICA DE INTERFAZ Y DATOS ---

function llenarSelectores() {
    document.getElementById('f_tienda').innerHTML = TIENDAS.map(t => `<option>${t}</option>`).join('');
}

// Utils
function formatearRut(rut) {
    if(!rut) return '';
    let valor = rut.replace(/\./g, '').replace(/-/g, '').toLowerCase().trim();
    if (valor.length < 2) return valor;
    let cuerpo = valor.slice(0, -1);
    let dv = valor.slice(-1);
    return cuerpo.replace(/\B(?=(\d{3})+(?!\d))/g, ".") + "-" + dv;
}
function setSelect(id, val) { const el = document.getElementById(id); if(el) el.value = val; }

// Listeners de Formulario
function setupListeners() {
    const inputRut = document.getElementById('f_rut');
    const inputNombre = document.getElementById('f_nombre');
    const inputCorreo = document.getElementById('f_correo');

    inputRut.addEventListener('blur', () => {
        inputRut.value = formatearRut(inputRut.value);
        const c = DB_COLABS.find(x => x.rut === inputRut.value);
        if(c) {
            inputNombre.value = c.nombre || '';
            inputCorreo.value = c.correo || '';
            setSelect('f_area', c.area || 'Operaciones');
            setSelect('f_contractual', c.estado_contractual || 'Vigente');
        }
    });

    inputNombre.addEventListener('input', () => {
        const c = DB_COLABS.find(x => x.nombre === inputNombre.value);
        if(c) {
            inputRut.value = c.rut;
            inputCorreo.value = c.correo;
            setSelect('f_area', c.area);
            setSelect('f_contractual', c.estado_contractual);
        }
        if ((inputCorreo.value === "" || inputCorreo.value.includes('@dominos.cl')) && inputNombre.value.includes(' ')) {
            const parts = inputNombre.value.toLowerCase().trim().split(" ");
            if (parts.length >= 2) inputCorreo.value = `${parts[0][0]}${parts[1]}@dominospizza.cl`.replace(/\s/g, '');
        }
    });
}

function toggleTelefonia() {
    const eq = document.getElementById('sw_equipo').checked;
    const sim = document.getElementById('sw_sim').checked;
    ['f_mar_cel', 'f_mod_cel', 'f_imei'].forEach(id => { 
        const el = document.getElementById(id); el.disabled = !eq; el.classList.toggle('disabled-field', !eq); if(!eq) el.value = "";
    });
    const simEl = document.getElementById('f_imsi'); simEl.disabled = !sim; simEl.classList.toggle('disabled-field', !sim); if(!sim) simEl.value = "";
}

// Carga de Datos Principal
async function cargarTodo() {
    try {
        const [resA, resC] = await Promise.all([
            sb.from('activos').select('*'),
            sb.from('colaboradores').select('*')
        ]);
        
        if (resA.error) throw resA.error;
        if (resC.error) throw resC.error;

        DB_ACTIVOS = resA.data.sort((a,b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
        DB_COLABS = resC.data;
        
        const dataList = document.getElementById('listaNombres');
        if(dataList) dataList.innerHTML = DB_COLABS.map(c => `<option value="${c.nombre}">`).join('');
        
        actualizarKPIs();
        renderMasterTable();
        initCharts();
    } catch(e) { 
        console.error(e); 
    }
}

// Funciones de Visualización
function verUsuario(rut) {
    const colab = DB_COLABS.find(c => c.rut === rut);
    if (!colab) return;
    const activos = DB_ACTIVOS.filter(a => a.rut_responsable === rut);
    const canEdit = document.body.classList.contains('role-admin');

    const html = `
        <div class="user-header">
            <div class="user-avatar">${colab.nombre.charAt(0)}</div>
            <div>
                <h3 style="margin:0; font-size: 20px; color:var(--dark)">${colab.nombre}</h3>
                <p style="margin:5px 0; color:#64748b; font-size:12px;">${colab.rut} | ${colab.area}</p>
                <span style="background:${colab.estado_contractual==='Cesado'?'#fee2e2':'#dcfce7'}; color:${colab.estado_contractual==='Cesado'?'#b91c1c':'#166534'}; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700;">
                    ${colab.estado_contractual || 'Vigente'}
                </span>
            </div>
        </div>
        <h4 style="color:var(--primary); margin-bottom:15px; border-left: 4px solid var(--secondary); padding-left: 10px;">Equipos Asignados (${activos.length})</h4>
        <ul class="asset-list">
            ${activos.length > 0 ? activos.map(a => `
                <li class="asset-item">
                    <div>
                        <div style="font-weight:700; color:var(--dark)">${a.marca} ${a.modelo}</div>
                        <div style="font-size:11px; color:#64748b">Serie: <code style="color:var(--primary)">${a.serie}</code></div>
                        ${a.marca_cel ? `<div style="font-size:10px; color:#64748b; margin-top:2px;"><i class="fas fa-mobile-alt"></i> ${a.marca_cel} (IMEI: ${a.imei_cel})</div>` : ''}
                    </div>
                    <div style="text-align:right;">
                        <span style="font-size:10px; background:#f1f5f9; padding:3px 6px; border-radius:4px;">${a.estado}</span>
                        ${canEdit ? `<div style="margin-top:5px;"><i class="fas fa-edit" style="cursor:pointer; color:var(--primary)" onclick="document.getElementById('modalVerUsuario').classList.add('hidden'); editarActivo('${a.serie}')"></i></div>` : ''}
                    </div>
                </li>
            `).join('') : '<p style="color:#64748b; font-style:italic;">No tiene equipos asignados actualmente.</p>'}
        </ul>
    `;
    document.getElementById('userProfileContent').innerHTML = html;
    document.getElementById('modalVerUsuario').classList.remove('hidden');
}

function actualizarKPIs() {
    const total = DB_ACTIVOS.length;
    const disponibles = DB_ACTIVOS.filter(a => a.estado === 'Disponible').length;
    const mantencion = DB_ACTIVOS.filter(a => a.estado === 'Mantención').length;
    let cesados = 0;
    DB_ACTIVOS.forEach(a => {
        if(a.estado === 'Asignado') {
            const c = DB_COLABS.find(x => x.rut === a.rut_responsable);
            if(c && c.estado_contractual === 'Cesado') cesados++;
        }
    });

    document.getElementById('kpi-total').innerText = total;
    document.getElementById('kpi-dispo').innerText = disponibles;
    document.getElementById('kpi-mant').innerText = mantencion;
    document.getElementById('kpi-cesados').innerText = cesados;

    renderHomeTable(DB_ACTIVOS.slice(0, 5), "Últimos Movimientos");

    if(charts.mini) charts.mini.destroy();
    charts.mini = new Chart(document.getElementById('chartMini').getContext('2d'), { 
        type: 'doughnut', 
        data: { labels: ['Disponible', 'Asignado', 'Mantención'], datasets: [{ data: [disponibles, (total - disponibles - mantencion), mantencion], backgroundColor: ['#22c55e','#0066CC','#f59e0b'] }] },
        options: { 
            maintainAspectRatio: false, 
            plugins: { 
                legend: { display: false }, 
                datalabels: { color: 'white', font: { weight: 'bold', size: 11 }, formatter: (val, ctx) => val > 0 ? ctx.chart.data.labels[ctx.dataIndex] + '\n' + val : '' } 
            }, 
            onClick: (e, elements) => { 
                if(elements.length > 0) { 
                    const label = charts.mini.data.labels[elements[0].index]; 
                    renderHomeTable(DB_ACTIVOS.filter(a => a.estado === label), `Detalle: ${label}`); 
                } 
            } 
        }
    });
}

function renderHomeTable(data, title) {
    document.getElementById('homeTableTitle').innerText = title;
    const tbody = document.getElementById('lastMovesTable');
    if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;">Sin resultados</td></tr>'; return; }
    tbody.innerHTML = data.map(a => {
        const c = DB_COLABS.find(x => x.rut === a.rut_responsable) || { nombre: 'N/A' };
        return `<tr><td><div style="font-weight:700; color:var(--primary)">${a.serie}</div><div style="font-size:10px; color:#64748b">${a.rut_responsable}</div></td><td><div style="font-weight:600;">${c.nombre}</div><div style="font-size:10px;">${a.ubicacion || '-'}</div></td><td><span style="font-size:11px; padding:2px 6px; border-radius:4px; background:${a.estado==='Disponible'?'#dcfce7':'#f1f5f9'}; color:${a.estado==='Disponible'?'#166534':'#334155'}">${a.estado}</span></td></tr>`;
    }).join('');
}
function resetHomeTable() { renderHomeTable(DB_ACTIVOS.slice(0, 5), "Últimos Movimientos"); }

// --- GUARDAR Y PROCESAR ---
async function guardarTodoSincronizado() {
    const btn = document.getElementById('btnSave'); btn.innerText = "GUARDANDO..."; btn.disabled = true;
    const rut = document.getElementById('f_rut').value.trim();
    const serie = document.getElementById('f_serie').value.trim();
    
    if(!rut || !serie) { alert("Datos faltantes (RUT o Serie)"); btn.disabled = false; btn.innerText = "GUARDAR"; return; }

    const colab = { rut, nombre: document.getElementById('f_nombre').value.trim(), correo: document.getElementById('f_correo').value.trim(), area: document.getElementById('f_area').value, estado_contractual: document.getElementById('f_contractual').value };
    const activo = { serie, rut_responsable: rut, marca: document.getElementById('f_marca').value.trim(), modelo: document.getElementById('f_modelo').value.trim(), estado: document.getElementById('f_estado').value, ubicacion: document.getElementById('f_tienda').value, fecha_entrega: document.getElementById('f_fecha_ent').value || null, entrega_it: document.getElementById('f_ent_it').value.trim(), observaciones: document.getElementById('f_obs').value.trim(), marca_cel: document.getElementById('sw_equipo').checked?document.getElementById('f_mar_cel').value:null, modelo_cel: document.getElementById('sw_equipo').checked?document.getElementById('f_mod_cel').value:null, imei_cel: document.getElementById('sw_equipo').checked?document.getElementById('f_imei').value:null, imei_sim: document.getElementById('sw_sim').checked?document.getElementById('f_imsi').value:null };

    try {
        await sb.from('colaboradores').upsert(colab, { onConflict: 'rut' });
        const resA = await sb.from('activos').upsert(activo, { onConflict: 'serie' });
        
        if (resA.error) throw resA.error;
        
        alert("✅ Guardado Exitoso"); cerrarFicha(); cargarTodo();
    } catch(e) { console.error(e); alert("Error al guardar: " + e.message); } 
    finally { btn.innerText = "GUARDAR"; btn.disabled = false; }
}

async function procesarCSV() {
    const file = document.getElementById('csvFile').files[0]; if (!file) return alert("Selecciona CSV");
    const reader = new FileReader(); reader.readAsText(file, 'UTF-8');
    reader.onload = async function(e) {
        const lines = e.target.result.split(/\r?\n/);
        let count = 0;
        for (let i = 1; i < lines.length; i++) {
            if (!lines[i].trim()) continue;
            const col = lines[i].split(',').map(v => v.replace(/^"|"$/g, '').trim());
            if(col.length<5) continue;
            const c = { rut: formatearRut(col[0]), nombre: col[1], correo: col[4], area: col[5], estado_contractual: col[16] || 'Vigente' };
            const a = { serie: col[9], rut_responsable: c.rut, ubicacion: col[6], marca: col[7], modelo: col[8], estado: col[3], fecha_entrega: formatearFechaCSV(col[2]), entrega_it: col[13], observaciones: col[15] };
            
            sb.from('colaboradores').upsert(c, { onConflict: 'rut' }).then();
            sb.from('activos').upsert(a, { onConflict: 'serie' }).then();
            count++;
        }
        setTimeout(() => { alert(`Proceso iniciado para ${count} registros.`); cargarTodo(); }, 2000);
    };
}
function formatearFechaCSV(str) { if(!str) return null; const p = str.split(/[\/-]/); return (p.length === 3 && p[2].length === 4) ? `${p[2]}-${p[1]}-${p[0]}` : str; }

// --- NAVEGACIÓN Y TABLA ---
function editarActivo(serie) {
    const a = DB_ACTIVOS.find(x => x.serie === serie); if(!a) return;
    const c = DB_COLABS.find(x => x.rut === a.rut_responsable) || {};
    document.getElementById('f_rut').value = a.rut_responsable; document.getElementById('f_nombre').value = c.nombre||''; document.getElementById('f_correo').value = c.correo||'';
    setSelect('f_area', c.area||'Operaciones'); setSelect('f_tienda', a.ubicacion); setSelect('f_contractual', c.estado_contractual||'Vigente'); setSelect('f_estado', a.estado);
    document.getElementById('f_marca').value = a.marca; document.getElementById('f_modelo').value = a.modelo; document.getElementById('f_serie').value = a.serie;
    document.getElementById('f_fecha_ent').value = a.fecha_entrega; document.getElementById('f_ent_it').value = a.entrega_it; document.getElementById('f_obs').value = a.observaciones;
    document.getElementById('sw_equipo').checked = !!a.marca_cel; document.getElementById('f_mar_cel').value = a.marca_cel||''; document.getElementById('f_mod_cel').value = a.modelo_cel||''; document.getElementById('f_imei').value = a.imei_cel||'';
    document.getElementById('sw_sim').checked = !!a.imei_sim; document.getElementById('f_imsi').value = a.imei_sim||'';
    toggleTelefonia(); abrirFicha();
}

function renderMasterTable() {
    const b = document.getElementById('masterTableBody'); const s = document.getElementById('mainSearch').value.toLowerCase();
    let lastRut = null;
    const filtered = DB_ACTIVOS.filter(a => {
        const c = DB_COLABS.find(col => col.rut === a.rut_responsable) || { nombre: '' };
        return `${a.serie} ${c.nombre} ${a.rut_responsable} ${a.ubicacion}`.toLowerCase().includes(s);
    }).sort((a, b) => (a.rut_responsable || '').localeCompare(b.rut_responsable || ''));

    b.innerHTML = filtered.map(a => {
        const c = DB_COLABS.find(col => col.rut === a.rut_responsable) || { nombre: 'N/A', estado_contractual: 'Vigente' };
        const isSame = lastRut === a.rut_responsable; lastRut = a.rut_responsable;
        const trClass = isSame ? 'group-continue' : 'group-start'; const tdClass = isSame ? 'dim-text' : '';
        const contractStyle = c.estado_contractual==='Cesado' ? 'color:#b91c1c; font-weight:800;' : 'color:#15803d; font-weight:700;';
        
        const actionBtn = document.body.classList.contains('role-admin') 
            ? `<i class="fas fa-edit" style="cursor:pointer; color:var(--primary)" onclick="editarActivo('${a.serie}')"></i>` 
            : `<i class="fas fa-eye" style="cursor:pointer; color:#94a3b8" onclick="verUsuario('${a.rut_responsable}')"></i>`;

        return `<tr class="${trClass}">
            <td class="${tdClass}" style="color:#64748b">${a.rut_responsable}</td>
            <td class="${tdClass} click-name" onclick="verUsuario('${a.rut_responsable}')">${c.nombre}</td>
            <td>${a.estado}</td>
            <td class="${tdClass}" style="${contractStyle}">${c.estado_contractual||'Vigente'}</td>
            <td class="${tdClass}">${c.area}</td>
            <td class="${tdClass}">${a.ubicacion}</td>
            <td>${a.marca} ${a.modelo}</td>
            <td><code style="color:var(--primary);">${a.serie}</code></td>
            <td>${actionBtn}</td>
        </tr>`;
    }).join('');
}

function showView(v) { document.getElementById('view-home').classList.toggle('hidden', v!=='home'); document.getElementById('view-inventory').classList.toggle('hidden', v!=='inventory'); document.getElementById('view-metrics').classList.toggle('hidden', v!=='metrics'); document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); if(v==='home') document.getElementById('btn-home').classList.add('active'); if(v==='inventory') document.getElementById('btn-inv').classList.add('active'); if(v==='metrics') document.getElementById('btn-metrics').classList.add('active'); }
function initCharts() {
    if(charts.a) charts.a.destroy(); if(charts.e) charts.e.destroy();
    const a = {}, e = {}; DB_COLABS.forEach(x => a[x.area] = (a[x.area]||0)+1); DB_ACTIVOS.forEach(x => e[x.estado] = (e[x.estado]||0)+1);
    charts.a = new Chart(document.getElementById('chartArea').getContext('2d'), { type: 'doughnut', data: { labels: Object.keys(a), datasets: [{ data: Object.values(a), backgroundColor: ['#0066CC','#E31837','#22c55e','#f59e0b'] }] } });
    charts.e = new Chart(document.getElementById('chartEstado').getContext('2d'), { type: 'bar', data: { labels: Object.keys(e), datasets: [{ label: 'Total', data: Object.values(e), backgroundColor: '#E31837' }] } });
}
function abrirFicha() { document.getElementById('modalFicha').classList.remove('hidden'); setupListeners(); }
function cerrarFicha() { document.getElementById('modalFicha').classList.add('hidden'); }
</script>
