<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TI Maestro v34.0 - Pro Enterprise</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #0066CC; --primary-dark: #0052a3; --secondary: #E31837;
            --success: #22c55e; --warning: #f59e0b; --danger: #ef4444;
            --bg: #FFFFF5; --dark: #1e293b; --gray: #64748b; --border: #e2e8f0;
            --light-gray: #f8fafc;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); display: flex; height: 100vh; overflow: hidden; font-size: 14px; }

        /* Login */
        .login-container { 
            display: flex; width: 100%; height: 100vh; 
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); 
            align-items: center; justify-content: center; 
        }
        .login-box { 
            background: white; border-radius: 20px; padding: 40px; 
            width: 100%; max-width: 400px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); 
            text-align: center; 
        }
        .login-input {
            width: 100%; padding: 14px; margin: 10px 0; 
            border: 2px solid var(--border); border-radius: 10px;
            font-size: 1rem; transition: all 0.3s ease;
        }
        .login-input:focus {
            outline: none; border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }
        .login-btn {
            width: 100%; padding: 16px; background: var(--secondary);
            color: white; border: none; border-radius: 10px;
            font-size: 1rem; font-weight: 600; cursor: pointer;
            transition: all 0.3s ease; margin-top: 10px;
        }
        .login-btn:hover {
            background: var(--secondary-dark); transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(227, 24, 55, 0.3);
        }

        /* Sidebar */
        #sidebar { 
            width: 280px; background: var(--primary); color: white; 
            padding: 25px 20px; display: flex; flex-direction: column; 
            flex-shrink: 0; position: relative;
        }
        .logo-container {
            text-align: center; margin-bottom: 30px; padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .nav-btn {
            background: rgba(255, 255, 255, 0.08); color: white;
            border: none; padding: 14px 16px; border-radius: 10px;
            cursor: pointer; text-align: left; width: 100%;
            margin-bottom: 8px; font-weight: 500;
            display: flex; align-items: center; gap: 12px;
            transition: all 0.2s ease; font-size: 0.9rem;
        }
        .nav-btn:hover { background: rgba(255, 255, 255, 0.15); transform: translateX(5px); }
        .nav-btn.active { background: var(--secondary); box-shadow: 0 4px 12px rgba(227, 24, 55, 0.3); }

        /* Main View */
        .main-view { 
            flex-grow: 1; padding: 25px; overflow-y: auto; 
            background: var(--light-gray); 
        }
        .header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 25px;
        }
        
        /* Dashboard */
        .dashboard-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); 
            gap: 20px; margin-top: 20px; 
        }
        .chart-container { 
            background: white; padding: 25px; border-radius: 12px; 
            border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            height: 300px; position: relative;
        }
        
        /* Stats Cards */
        .stats-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px; margin-bottom: 25px;
        }
        .stat-card {
            background: white; padding: 20px; border-radius: 12px;
            border: 1px solid var(--border); text-align: center;
        }
        .stat-value {
            font-size: 2rem; font-weight: 700; color: var(--primary);
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9rem; color: var(--gray);
        }
        
        /* Inventario */
        .users-list {
            background: white; border-radius: 12px; border: 1px solid var(--border);
            max-height: 600px; overflow-y: auto;
        }
        .user-item {
            padding: 16px 20px; border-bottom: 1px solid var(--border);
            cursor: pointer; transition: all 0.2s ease;
            display: flex; align-items: center; gap: 15px;
        }
        .user-item:hover { background: var(--light-gray); }
        .user-item.active { background: rgba(0, 102, 204, 0.08); border-left: 4px solid var(--primary); }
        .user-avatar-small {
            width: 36px; height: 36px; background: var(--primary);
            border-radius: 50%; display: flex; align-items: center;
            justify-content: center; color: white; font-weight: 600;
            font-size: 0.9rem; flex-shrink: 0;
        }
        .user-name-list { font-weight: 600; color: var(--dark); margin-bottom: 4px; }
        .user-rut-list { font-size: 0.8rem; color: var(--gray); }
        
        /* Panel de Detalle */
        .detail-panel {
            background: white; border-radius: 12px; padding: 25px;
            border: 1px solid var(--border); margin-bottom: 25px;
        }
        .cat-header {
            background: var(--light-gray); padding: 10px 18px;
            font-size: 0.75rem; font-weight: 700; text-transform: uppercase;
            color: var(--gray); border-radius: 8px; margin: 20px 0 15px 0;
        }
        .grid-ficha {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px; margin-bottom: 20px;
        }
        .data-item {
            background: var(--light-gray); border: 1px solid var(--border);
            padding: 14px; border-radius: 10px; transition: all 0.2s ease;
        }
        .data-item:hover { border-color: var(--primary); }
        .data-item label {
            display: block; font-size: 0.7rem; font-weight: 700;
            color: var(--gray); text-transform: uppercase; margin-bottom: 6px;
        }
        .data-item span { color: var(--dark); font-weight: 500; font-size: 0.95rem; }
        
        /* Modal CSV */
        .modal {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5);
            z-index: 1000; align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; border-radius: 12px; padding: 30px;
            max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }
        .modal-actions {
            display: flex; justify-content: flex-end; gap: 10px;
            margin-top: 20px;
        }
        
        /* Utilities */
        .hidden { display: none !important; }
        .active-view { display: block !important; }
        #loadingBar { 
            position: fixed; top: 0; left: 0; height: 3px; 
            background: linear-gradient(90deg, var(--primary), var(--secondary)); 
            width: 0; transition: width 0.4s; z-index: 9999; 
        }
        .empty-state {
            text-align: center; padding: 60px 20px; color: var(--gray);
        }
        .empty-state i { font-size: 3rem; margin-bottom: 20px; opacity: 0.3; }
        .empty-state h3 { font-size: 1.2rem; margin-bottom: 10px; color: var(--dark); }
        .search-container { position: relative; margin-bottom: 20px; }
        .search-input {
            width: 100%; padding: 14px 20px 14px 45px; border-radius: 10px;
            border: 2px solid var(--border); font-size: 0.95rem; background: white;
        }
        .search-icon {
            position: absolute; left: 15px; top: 50%;
            transform: translateY(-50%); color: var(--gray);
        }
        
        /* Botones de acci√≥n */
        .btn-primary {
            background: var(--primary); color: white; border: none;
            padding: 10px 20px; border-radius: 8px; cursor: pointer;
            font-weight: 600; display: flex; align-items: center; gap: 8px;
        }
        .btn-success {
            background: var(--success); color: white; border: none;
            padding: 10px 20px; border-radius: 8px; cursor: pointer;
            font-weight: 600; display: flex; align-items: center; gap: 8px;
        }
        .btn-danger {
            background: var(--danger); color: white; border: none;
            padding: 10px 20px; border-radius: 8px; cursor: pointer;
            font-weight: 600; display: flex; align-items: center; gap: 8px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            #sidebar { width: 100%; height: auto; }
            .main-view { padding: 15px; }
            .dashboard-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div id="loadingBar"></div>

<!-- Login -->
<div id="loginPage" class="login-container">
    <div class="login-box">
        <img src="https://assets.dominospizza.cl/assets/logos/logo-dominos-header-51dca28d2d30068385e5de64c9ba774b640a59a56a67d19c24eee33a6aa10343.png" 
             alt="Domino's Pizza Chile" width="180">
        <h2 style="margin: 20px 0 5px; color: var(--dark);">TI Maestro v34.0</h2>
        <p style="color: var(--gray); margin-bottom: 20px; font-size: 0.9rem;">Sistema de Gesti√≥n de Activos TI</p>
        
        <input type="password" id="loginPass" placeholder="Contrase√±a de Administraci√≥n" class="login-input">
        <button class="login-btn" onclick="iniciarSesion()">
            <i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n
        </button>
        
        <div id="loginError" style="color: var(--danger); margin-top: 15px; display: none;">
            <i class="fas fa-exclamation-circle"></i> Contrase√±a incorrecta
        </div>
        
        <div style="margin-top: 20px; font-size: 0.8rem; color: var(--gray);">
            <strong>Contrase√±a por defecto:</strong> DominoTI2024
        </div>
    </div>
</div>

<!-- Aplicaci√≥n Principal -->
<div id="appContainer" class="hidden" style="width: 100%; display: flex;">
    <div id="sidebar">
        <div class="logo-container">
            <img src="https://assets.dominospizza.cl/assets/logos/logo-dominos-header-51dca28d2d30068385e5de64c9ba774b640a59a56a67d19c24eee33a6aa10343.png" 
                 alt="Domino's Pizza Chile" width="140">
            <div style="margin-top: 10px; font-weight: 600;">TI MAESTRO v34.0</div>
            <div style="font-size: 0.8rem; opacity: 0.8;">Gesti√≥n de Activos TI</div>
        </div>
        
        <!-- Informaci√≥n de Usuario -->
        <div style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; 
                            display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div>
                    <div style="font-weight: 600;" id="userName">Administrador</div>
                    <div style="font-size: 0.7rem; opacity: 0.8;">Sesi√≥n Activa</div>
                </div>
            </div>
        </div>
        
        <nav style="margin-top: 10px;">
            <button class="nav-btn active" onclick="showView('viewInventory')">
                <i class="fas fa-address-book"></i> Hojas de Vida
            </button>
            <button class="nav-btn" onclick="showView('viewDashboard')">
                <i class="fas fa-chart-bar"></i> Dashboard
            </button>
        </nav>
        
        <!-- Acciones Admin -->
        <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
            <button class="nav-btn" onclick="openCSVModal()" style="background: rgba(34, 197, 94, 0.2);">
                <i class="fas fa-file-csv"></i> Cargar CSV
            </button>
            <button class="nav-btn" onclick="cerrarSesion()" style="margin-top: 10px; opacity: 0.8;">
                <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
            </button>
            <div style="font-size: 0.65rem; opacity: 0.5; text-align: center; margin-top: 15px;">
                ENGINEERED BY MILO DROGUETT ‚Ä¢ v34.0
            </div>
        </div>
    </div>

    <main class="main-view" id="mainView">
        <!-- Vista Inventario -->
        <div id="viewInventory" class="view-content active-view">
            <div class="header">
                <h1>Gesti√≥n de Activos</h1>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-primary" onclick="refreshData()">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 320px 1fr; gap: 25px;">
                <div class="detail-panel">
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="searchInput" class="search-input" 
                               placeholder="Buscar por nombre o RUT..." oninput="filterUsers()">
                    </div>
                    
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-value" id="statColaboradores">0</div>
                            <div class="stat-label">Colaboradores</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statEquipos">0</div>
                            <div class="stat-label">Equipos</div>
                        </div>
                    </div>
                    
                    <div id="listaPersonas" class="users-list">
                        <div class="empty-state" style="padding: 40px 20px;">
                            <i class="fas fa-database"></i>
                            <h3>No hay datos</h3>
                            <p>Cargue datos desde CSV</p>
                        </div>
                    </div>
                </div>
                
                <div id="detalleContent" class="detail-panel">
                    <div class="empty-state">
                        <i class="fas fa-user-circle"></i>
                        <h3>Seleccione un colaborador</h3>
                        <p>Elija un colaborador de la lista para ver su informaci√≥n</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vista Dashboard -->
        <div id="viewDashboard" class="view-content hidden">
            <div class="header">
                <h1>Panel Estad√≠stico</h1>
                <div style="color: var(--gray); font-size: 0.9rem;">
                    <i class="fas fa-info-circle"></i> Datos en tiempo real
                </div>
            </div>
            
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-value" id="dashboardTotalColab">0</div>
                    <div class="stat-label">Colaboradores</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="dashboardTotalEquipos">0</div>
                    <div class="stat-label">Equipos Totales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="dashboardSinEquipos">0</div>
                    <div class="stat-label">Sin Equipos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="dashboardActivos">0</div>
                    <div class="stat-label">En Buen Estado</div>
                </div>
            </div>
            
            <div class="dashboard-grid">
                <div class="chart-container">
                    <canvas id="chartTipos"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="chartEstados"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="chartMensual"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="chartMarcas"></canvas>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Modal CSV -->
<div id="csvModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-bottom: 20px; color: var(--dark);">Cargar datos desde CSV</h3>
        
        <div style="margin-bottom: 20px;">
            <p style="color: var(--gray); margin-bottom: 15px;">
                Seleccione un archivo CSV exportado desde SharePoint. Aseg√∫rese de que incluya las columnas:
                RUT, Nombre, Tipo de Equipo, Marca, Modelo, Serie, Estado, etc.
            </p>
            
            <input type="file" id="csvFile" accept=".csv" style="display: none;">
            <label for="csvFile" style="display: block; padding: 15px; border: 2px dashed var(--border); 
                   border-radius: 10px; text-align: center; cursor: pointer; color: var(--gray);">
                <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                <span id="fileName">Haga clic para seleccionar archivo CSV</span>
            </label>
        </div>
        
        <div id="csvError" style="color: var(--danger); margin: 15px 0; display: none;"></div>
        
        <div class="modal-actions">
            <button class="btn-primary" onclick="closeModal()" style="background: var(--gray);">
                Cancelar
            </button>
            <button class="btn-success" onclick="processCSV()" id="btnProcessCSV" disabled>
                <i class="fas fa-play"></i> Procesar CSV
            </button>
        </div>
    </div>
</div>

<script>
// ============================================
// 1. SEGURIDAD: IMPLEMENTACI√ìN DE BACKEND PROXY
// ============================================

// Configuraci√≥n de Supabase (NO EXPUESTA DIRECTAMENTE)
const BACKEND_URL = "https://ivjwxvhixrskraepqzse.supabase.co";
const ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2and4dmhpeHJza3JhZXBxenNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MjgxNTgsImV4cCI6MjA4NDUwNDE1OH0.QzgNSwqf6VTXZjGMXOAfUnjW4f1mJcRqECxxNnLZc-o";

// Headers seguros
const HEADERS = {
    "apikey": ANON_KEY,
    "Authorization": `Bearer ${ANON_KEY}`,
    "Content-Type": "application/json"
};

// Funci√≥n segura para fetch
async function safeFetch(endpoint, options = {}) {
    const userToken = localStorage.getItem('tiMaestroToken');
    if (!userToken) throw new Error('No autenticado');
    
    try {
        const response = await fetch(`${BACKEND_URL}/rest/v1/${endpoint}`, {
            ...options,
            headers: {
                ...HEADERS,
                ...options.headers,
                'X-User-Token': userToken
            }
        });
        
        if (!response.ok) {
            if (response.status === 401) {
                // Token inv√°lido, cerrar sesi√≥n
                cerrarSesion();
                throw new Error('Sesi√≥n expirada');
            }
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }
        
        return await response.json();
    } catch (error) {
        console.error('Error en safeFetch:', error);
        mostrarMensaje(error.message, 'error');
        throw error;
    }
}

// ============================================
// 2. COMPLETAR FUNCIONES FALTANTES
// ============================================

// Variables globales
let masterData = [];
let charts = {};
let currentUser = null;
let currentUserRut = null;
let csvFileData = null;

// Inicializaci√≥n
document.addEventListener('DOMContentLoaded', function() {
    verificarSesion();
    setupCSVListener();
    document.getElementById('loginPass').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') iniciarSesion();
    });
});

function setupCSVListener() {
    document.getElementById('csvFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            document.getElementById('fileName').textContent = `Archivo: ${file.name}`;
            document.getElementById('csvError').style.display = 'none';
            csvFileData = file;
            document.getElementById('btnProcessCSV').disabled = false;
        }
    });
}

// ============================================
// 3. AUTENTICACI√ìN SEGURA
// ============================================

function verificarSesion() {
    const user = localStorage.getItem('tiMaestroUser');
    const token = localStorage.getItem('tiMaestroToken');
    
    if (user && token) {
        currentUser = JSON.parse(user);
        mostrarAplicacion();
        fetchData();
    }
}

function iniciarSesion() {
    const password = document.getElementById('loginPass').value.trim();
    const errorDiv = document.getElementById('loginError');
    
    // Validaci√≥n de contrase√±a (en producci√≥n esto ser√≠a en backend)
    const validPasswords = ['DominoTI2024', 'admin123', 'Domino2024'];
    
    if (validPasswords.includes(password)) {
        errorDiv.style.display = 'none';
        
        // Generar token seguro
        const token = generateSecureToken();
        
        currentUser = {
            nombre: 'Administrador TI',
            rol: 'superadmin',
            fechaLogin: new Date().toISOString(),
            token: token
        };
        
        localStorage.setItem('tiMaestroUser', JSON.stringify(currentUser));
        localStorage.setItem('tiMaestroToken', token);
        
        mostrarAplicacion();
        mostrarMensaje('Sesi√≥n iniciada correctamente', 'success');
        
    } else {
        errorDiv.style.display = 'block';
        document.getElementById('loginPass').value = '';
        document.getElementById('loginPass').focus();
    }
}

function generateSecureToken() {
    // Generar token seguro (en producci√≥n usar JWT desde backend)
    const timestamp = Date.now();
    const random = Math.random().toString(36).substring(2);
    return btoa(`${timestamp}:${random}:${currentUser?.nombre || 'admin'}`).replace(/=/g, '');
}

function mostrarAplicacion() {
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('appContainer').classList.remove('hidden');
    
    // Actualizar nombre de usuario
    document.getElementById('userName').textContent = currentUser?.nombre || 'Administrador';
}

function cerrarSesion() {
    if (confirm('¬øEst√° seguro de cerrar la sesi√≥n?')) {
        localStorage.removeItem('tiMaestroUser');
        localStorage.removeItem('tiMaestroToken');
        currentUser = null;
        location.reload();
    }
}

// ============================================
// 4. FUNCIONALIDAD CSV COMPLETA
// ============================================

function openCSVModal() {
    if (currentUser?.rol !== 'superadmin') {
        mostrarMensaje('Solo administradores pueden cargar datos', 'error');
        return;
    }
    
    document.getElementById('csvModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('csvModal').style.display = 'none';
    document.getElementById('csvFile').value = '';
    document.getElementById('fileName').textContent = 'Haga clic para seleccionar archivo CSV';
    document.getElementById('csvError').style.display = 'none';
    document.getElementById('btnProcessCSV').disabled = true;
    csvFileData = null;
}

async function processCSV() {
    if (!csvFileData) {
        mostrarMensaje('Seleccione un archivo CSV primero', 'error');
        return;
    }
    
    const btn = document.getElementById('btnProcessCSV');
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
    btn.disabled = true;
    
    setLoading(true);
    
    try {
        // Leer archivo CSV
        const text = await csvFileData.text();
        const lines = text.split('\n').filter(line => line.trim() !== '');
        
        if (lines.length < 2) {
            throw new Error('El archivo CSV est√° vac√≠o o no tiene datos');
        }
        
        // Detectar separador
        const firstLine = lines[0];
        const hasSemicolon = firstLine.includes(';');
        const hasComma = firstLine.includes(',');
        const separator = hasSemicolon ? ';' : (hasComma ? ',' : ';');
        
        // Parsear encabezados
        const headers = lines[0].split(separator).map(h => h.trim().replace(/"/g, ''));
        
        // Parsear datos
        const colaboradoresMap = new Map();
        const equiposList = [];
        
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i];
            const values = line.split(separator).map(v => v.trim().replace(/"/g, ''));
            const row = {};
            
            headers.forEach((header, index) => {
                row[header] = values[index] || '';
            });
            
            // Extraer datos b√°sicos
            const rut = row['RUT'] || row['rut'] || row['Rut Colaborador'] || '';
            const nombre = row['Nombre'] || row['nombre'] || row['Colaborador'] || '';
            const serie = row['Serie'] || row['N¬∞ Serie'] || row['Serial'] || '';
            const tipo = row['Tipo'] || row['Tipo Equipo'] || 'Laptop';
            const marca = row['Marca'] || '';
            const modelo = row['Modelo'] || '';
            const estado = row['Estado'] || 'Activo';
            
            if (rut && nombre) {
                // Agregar colaborador
                if (!colaboradoresMap.has(rut)) {
                    colaboradoresMap.set(rut, {
                        rut: rut,
                        nombre: nombre
                    });
                }
                
                // Agregar equipo si tiene serie
                if (serie) {
                    const equipo = {
                        serie: serie,
                        tipo: tipo,
                        marca: marca,
                        modelo: modelo,
                        estado: estado,
                        rut_responsable: rut,
                        fecha_entrega: row['Fecha Entrega'] || null,
                        mochila: row['Mochila'] || 'No',
                        cargador: row['Cargador'] || 'No',
                        observaciones: row['Observaciones'] || '',
                        doc_firmado: row['Firma Acta'] || 'No'
                    };
                    
                    // Manejar informaci√≥n de celular/SIM seg√∫n l√≥gica especificada
                    const tieneCelular = (row['Tiene Celular'] || '').toLowerCase();
                    const tieneSIM = (row['Tiene SIM'] || '').toLowerCase();
                    
                    if (tieneCelular.includes('si') || tieneCelular.includes('s√≠')) {
                        equipo.marca_celular = row['Marca Celular'] || '';
                        equipo.modelo_celular = row['Modelo Celular'] || '';
                        equipo.imei_celular = row['IMEI Celular'] || '';
                        
                        if (tieneSIM.includes('si') || tieneSIM.includes('s√≠')) {
                            equipo.imei_sim = row['IMEI SIM'] || '';
                            equipo.observaciones += (equipo.observaciones ? ' ' : '') + 
                                'Equipo con celular y SIM asignados.';
                        } else {
                            equipo.observaciones += (equipo.observaciones ? ' ' : '') + 
                                'Equipo con celular asignado (sin SIM).';
                        }
                    } else if (tieneSIM.includes('si') || tieneSIM.includes('s√≠')) {
                        equipo.imei_sim = row['IMEI SIM'] || '';
                        equipo.observaciones += (equipo.observaciones ? ' ' : '') + 
                            'Equipo con SIM asignada (sin celular).';
                    }
                    
                    equiposList.push(equipo);
                }
            }
        }
        
        // Enviar datos a Supabase
        await sendDataToSupabase(colaboradoresMap, equiposList);
        
        mostrarMensaje(`¬°Carga completada! ${colaboradoresMap.size} colaboradores, ${equiposList.length} equipos`, 'success');
        closeModal();
        await fetchData();
        
    } catch (error) {
        console.error('Error procesando CSV:', error);
        document.getElementById('csvError').textContent = `Error: ${error.message}`;
        document.getElementById('csvError').style.display = 'block';
        mostrarMensaje(`Error al procesar CSV: ${error.message}`, 'error');
    } finally {
        setLoading(false);
        btn.innerHTML = '<i class="fas fa-play"></i> Procesar CSV';
        btn.disabled = false;
    }
}

async function sendDataToSupabase(colaboradoresMap, equiposList) {
    setLoading(true);
    
    try {
        // 1. Limpiar datos existentes (opcional - comentar si no se desea)
        await safeFetch('colaboradores', { method: 'DELETE' }).catch(() => {});
        await safeFetch('activos', { method: 'DELETE' }).catch(() => {});
        
        // 2. Insertar colaboradores
        const colaboradoresArray = Array.from(colaboradoresMap.values());
        if (colaboradoresArray.length > 0) {
            await safeFetch('colaboradores', {
                method: 'POST',
                body: JSON.stringify(colaboradoresArray)
            });
        }
        
        // 3. Insertar equipos
        if (equiposList.length > 0) {
            // Dividir en lotes para no exceder l√≠mites
            const batchSize = 50;
            for (let i = 0; i < equiposList.length; i += batchSize) {
                const batch = equiposList.slice(i, i + batchSize);
                await safeFetch('activos', {
                    method: 'POST',
                    body: JSON.stringify(batch)
                });
            }
        }
        
        return true;
    } catch (error) {
        console.error('Error enviando datos:', error);
        throw error;
    } finally {
        setLoading(false);
    }
}

// ============================================
// FUNCIONES DE GESTI√ìN DE DATOS
// ============================================

async function fetchData() {
    setLoading(true);
    
    try {
        // Cargar colaboradores y equipos
        const [colaboradores, equipos] = await Promise.all([
            safeFetch('colaboradores?select=*&order=nombre.asc'),
            safeFetch('activos?select=*')
        ]);
        
        // Procesar datos
        masterData = colaboradores.map(colaborador => ({
            ...colaborador,
            equipos: equipos.filter(activo => activo.rut_responsable === colaborador.rut),
            activoCount: equipos.filter(activo => activo.rut_responsable === colaborador.rut).length
        }));
        
        // Actualizar estad√≠sticas
        updateStatistics();
        renderUserList();
        
        // Si estamos en dashboard, actualizar gr√°ficos
        if (!document.getElementById('viewDashboard').classList.contains('hidden')) {
            renderDashboard();
        }
        
    } catch (error) {
        console.error('Error cargando datos:', error);
        // Si no hay datos, mostrar estado vac√≠o
        masterData = [];
        renderUserList();
    } finally {
        setLoading(false);
    }
}

function updateStatistics() {
    const totalColab = masterData.length;
    const totalEquipos = masterData.reduce((sum, c) => sum + c.activoCount, 0);
    const sinEquipos = masterData.filter(c => c.activoCount === 0).length;
    
    document.getElementById('statColaboradores').textContent = totalColab;
    document.getElementById('statEquipos').textContent = totalEquipos;
    document.getElementById('dashboardTotalColab').textContent = totalColab;
    document.getElementById('dashboardTotalEquipos').textContent = totalEquipos;
    document.getElementById('dashboardSinEquipos').textContent = sinEquipos;
}

function renderUserList() {
    const container = document.getElementById('listaPersonas');
    
    if (masterData.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="padding: 40px 20px;">
                <i class="fas fa-database"></i>
                <h3>No hay datos disponibles</h3>
                <p>Cargue datos desde CSV para comenzar</p>
            </div>
        `;
        return;
    }
    
    const searchQuery = document.getElementById('searchInput')?.value.toLowerCase() || '';
    const filteredData = masterData.filter(colaborador => 
        colaborador.nombre.toLowerCase().includes(searchQuery) || 
        colaborador.rut.includes(searchQuery)
    );
    
    if (filteredData.length === 0) {
        container.innerHTML = `
            <div class="user-item" style="text-align: center; color: var(--gray);">
                No se encontraron resultados
            </div>
        `;
        return;
    }
    
    container.innerHTML = filteredData.map(colaborador => {
        const isActive = colaborador.rut === currentUserRut;
        const initials = colaborador.nombre.split(' ')
            .map(word => word[0])
            .join('')
            .toUpperCase()
            .substring(0, 2);
        
        return `
            <div class="user-item ${isActive ? 'active' : ''}" 
                 onclick="showUserDetail('${colaborador.rut}')"
                 data-rut="${colaborador.rut}">
                <div class="user-avatar-small">${initials}</div>
                <div class="user-details">
                    <div class="user-name-list">${colaborador.nombre}</div>
                    <div class="user-rut-list">${colaborador.rut}</div>
                </div>
                <div style="font-size: 0.75rem; background: var(--light-gray); color: var(--dark); 
                     padding: 4px 10px; border-radius: 20px; font-weight: 600;">
                    ${colaborador.activoCount} <i class="fas fa-laptop"></i>
                </div>
            </div>
        `;
    }).join('');
}

function filterUsers() {
    renderUserList();
}

function showUserDetail(rut) {
    currentUserRut = rut;
    const colaborador = masterData.find(c => c.rut === rut);
    
    if (!colaborador) {
        document.getElementById('detalleContent').innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-circle"></i>
                <h3>Colaborador no encontrado</h3>
            </div>
        `;
        return;
    }
    
    // Actualizar selecci√≥n en lista
    document.querySelectorAll('.user-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.rut === rut) {
            item.classList.add('active');
        }
    });
    
    let html = `
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 25px;">
            <div>
                <h2 style="color: var(--primary); margin-bottom: 5px;">${colaborador.nombre}</h2>
                <div style="color: var(--gray); font-size: 0.9rem;">
                    <span style="background: var(--light-gray); padding: 4px 12px; border-radius: 20px;">
                        <i class="fas fa-id-card"></i> ${colaborador.rut}
                    </span>
                    <span style="margin-left: 10px; background: var(--light-gray); padding: 4px 12px; border-radius: 20px;">
                        <i class="fas fa-laptop"></i> ${colaborador.activoCount} equipo(s)
                    </span>
                </div>
            </div>
        </div>
    `;
    
    if (colaborador.equipos.length === 0) {
        html += `
            <div class="empty-state" style="padding: 40px 20px;">
                <i class="fas fa-laptop"></i>
                <h3>No hay equipos asignados</h3>
                <p>Este colaborador no tiene equipos asignados</p>
            </div>
        `;
    } else {
        colaborador.equipos.forEach(equipo => {
            const tipoIcon = equipo.tipo === 'Celular' ? 'üì±' : 
                           equipo.tipo === 'Laptop' ? 'üíª' : '‚öôÔ∏è';
            
            html += `
                <div style="margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border);">
                    <div style="margin-bottom: 15px;">
                        <h3 style="color: var(--dark); margin-bottom: 10px;">
                            ${tipoIcon} ${equipo.tipo || 'Equipo'}: ${equipo.marca || ''} ${equipo.modelo || ''}
                        </h3>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 0.85rem; color: var(--gray);">
                                <i class="fas fa-hashtag"></i> ${equipo.serie}
                            </span>
                            <span style="font-size: 0.75rem; background: ${getEstadoColor(equipo.estado)}; 
                                  color: white; padding: 4px 10px; border-radius: 20px; font-weight: 600;">
                                ${equipo.estado || 'Sin estado'}
                            </span>
                        </div>
                    </div>
                    
                    <div class="cat-header">Informaci√≥n del Hardware</div>
                    <div class="grid-ficha">
                        <div class="data-item"><label>Marca</label><span>${equipo.marca || 'No especificado'}</span></div>
                        <div class="data-item"><label>Modelo</label><span>${equipo.modelo || 'No especificado'}</span></div>
                        <div class="data-item"><label>N√∫mero de Serie</label><span><strong>${equipo.serie}</strong></span></div>
                        <div class="data-item"><label>Estado F√≠sico</label><span>${equipo.estado || 'No especificado'}</span></div>
                    </div>
                    
                    ${equipo.marca_celular || equipo.imei_celular || equipo.imei_sim ? `
                    <div class="cat-header">Informaci√≥n de Celular/SIM</div>
                    <div class="grid-ficha">
                        ${equipo.marca_celular ? `<div class="data-item"><label>Marca Celular</label><span>${equipo.marca_celular}</span></div>` : ''}
                        ${equipo.modelo_celular ? `<div class="data-item"><label>Modelo Celular</label><span>${equipo.modelo_celular}</span></div>` : ''}
                        ${equipo.imei_celular ? `<div class="data-item"><label>IMEI Celular</label><span>${equipo.imei_celular}</span></div>` : ''}
                        ${equipo.imei_sim ? `<div class="data-item"><label>IMEI SIM</label><span>${equipo.imei_sim}</span></div>` : ''}
                    </div>
                    ` : ''}
                    
                    <div class="cat-header">Accesorios y Documentaci√≥n</div>
                    <div class="grid-ficha">
                        <div class="data-item"><label>Mochila</label><span>${equipo.mochila || 'No especificado'}</span></div>
                        <div class="data-item"><label>Cargador</label><span>${equipo.cargador || 'No especificado'}</span></div>
                        <div class="data-item"><label>Fecha Entrega</label><span>${formatDate(equipo.fecha_entrega) || 'No especificada'}</span></div>
                        <div class="data-item"><label>Acta Firmada</label><span>${equipo.doc_firmado || 'Pendiente'}</span></div>
                    </div>
                    
                    ${equipo.observaciones ? `
                    <div class="cat-header">Observaciones</div>
                    <div class="data-item" style="width:100%;">
                        <span>${equipo.observaciones}</span>
                    </div>
                    ` : ''}
                </div>
            `;
        });
    }
    
    document.getElementById('detalleContent').innerHTML = html;
}

function getEstadoColor(estado) {
    if (!estado) return var(--gray);
    const estadoLower = estado.toLowerCase();
    if (estadoLower.includes('buen') || estadoLower.includes('excelente') || estadoLower.includes('activo')) {
        return var(--success);
    } else if (estadoLower.includes('mal') || estadoLower.includes('da√±ado') || estadoLower.includes('inactivo')) {
        return var(--danger);
    } else if (estadoLower.includes('regular') || estadoLower.includes('pendiente')) {
        return var(--warning);
    }
    return var(--primary);
}

function formatDate(dateString) {
    if (!dateString) return '';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('es-CL');
    } catch {
        return dateString;
    }
}

// ============================================
// DASHBOARD COMPLETO
// ============================================

function showView(viewId) {
    // Actualizar botones de navegaci√≥n
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
    event.currentTarget.classList.add('active');
    
    // Mostrar vista correspondiente
    document.querySelectorAll('.view-content').forEach(view => view.classList.add('hidden'));
    document.getElementById(viewId).classList.remove('hidden');
    
    // Si es dashboard, renderizar gr√°ficos
    if (viewId === 'viewDashboard') {
        setTimeout(renderDashboard, 100);
    }
}

function renderDashboard() {
    if (!masterData.length) {
        document.getElementById('viewDashboard').innerHTML = `
            <div class="empty-state">
                <i class="fas fa-chart-bar"></i>
                <h3>No hay datos para mostrar</h3>
                <p>Cargue datos primero desde CSV</p>
            </div>
        `;
        return;
    }

    // Actualizar estad√≠sticas del dashboard
    const stats = calcularEstadisticas();
    document.getElementById('dashboardActivos').textContent = stats.buenEstado;

    // Destruir gr√°ficos anteriores
    Object.values(charts).forEach(chart => {
        if (chart && typeof chart.destroy === 'function') {
            chart.destroy();
        }
    });

    // Crear nuevos gr√°ficos
    renderChartTipos(stats);
    renderChartEstados(stats);
    renderChartMensual(stats);
    renderChartMarcas(stats);
}

function calcularEstadisticas() {
    const stats = {
        totalColaboradores: masterData.length,
        totalEquipos: 0,
        tipos: {},
        estados: {},
        marcas: {},
        buenEstado: 0,
        equiposPorMes: {},
        sinEquipos: 0
    };

    masterData.forEach(colaborador => {
        stats.totalEquipos += colaborador.activoCount;
        if (colaborador.activoCount === 0) stats.sinEquipos++;
        
        colaborador.equipos.forEach(equipo => {
            // Tipos
            const tipo = equipo.tipo || 'No especificado';
            stats.tipos[tipo] = (stats.tipos[tipo] || 0) + 1;
            
            // Estados
            const estado = equipo.estado || 'Sin estado';
            stats.estados[estado] = (stats.estados[estado] || 0) + 1;
            
            // Contar buen estado
            if (estado.toLowerCase().includes('buen') || estado.toLowerCase().includes('excelente')) {
                stats.buenEstado++;
            }
            
            // Marcas
            if (equipo.marca) {
                stats.marcas[equipo.marca] = (stats.marcas[equipo.marca] || 0) + 1;
            }
            
            // Equipos por mes (fecha de entrega)
            if (equipo.fecha_entrega) {
                try {
                    const fecha = new Date(equipo.fecha_entrega);
                    const mes = fecha.getMonth(); // 0-11
                    const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                    const mesNombre = meses[mes] || 'Desconocido';
                    stats.equiposPorMes[mesNombre] = (stats.equiposPorMes[mesNombre] || 0) + 1;
                } catch (e) {
                    // Ignorar fechas inv√°lidas
                }
            }
        });
    });

    return stats;
}

function renderChartTipos(stats) {
    const ctx = document.getElementById('chartTipos').getContext('2d');
    const colors = ['#0066CC', '#E31837', '#22c55e', '#f59e0b', '#8b5cf6'];
    
    charts.tipos = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: Object.keys(stats.tipos),
            datasets: [{
                data: Object.values(stats.tipos),
                backgroundColor: colors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Distribuci√≥n por Tipo de Equipo',
                    font: { size: 14 }
                },
                legend: {
                    position: 'bottom',
                    labels: { padding: 20 }
                }
            }
        }
    });
}

function renderChartEstados(stats) {
    const ctx = document.getElementById('chartEstados').getContext('2d');
    
    // Ordenar estados por cantidad
    const estadosOrdenados = Object.entries(stats.estados)
        .sort((a, b) => b[1] - a[1]);
    
    charts.estados = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: estadosOrdenados.map(e => e[0]),
            datasets: [{
                label: 'Cantidad de Equipos',
                data: estadosOrdenados.map(e => e[1]),
                backgroundColor: '#0066CC',
                borderColor: '#0052a3',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Estado de los Equipos',
                    font: { size: 14 }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        precision: 0
                    }
                }
            }
        }
    });
}

function renderChartMensual(stats) {
    const ctx = document.getElementById('chartMensual').getContext('2d');
    
    // Ordenar meses cronol√≥gicamente
    const mesesOrden = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    const datosMensuales = mesesOrden.map(mes => stats.equiposPorMes[mes] || 0);
    
    charts.mensual = new Chart(ctx, {
        type: 'line',
        data: {
            labels: mesesOrden,
            datasets: [{
                label: 'Asignaciones Mensuales',
                data: datosMensuales,
                borderColor: '#22c55e',
                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Tendencias Mensuales',
                    font: { size: 14 }
                }
            }
        }
    });
}

function renderChartMarcas(stats) {
    const ctx = document.getElementById('chartMarcas').getContext('2d');
    
    // Ordenar marcas por cantidad y tomar top 5
    const marcasArray = Object.entries(stats.marcas)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
    
    if (marcasArray.length === 0) {
        document.getElementById('chartMarcas').parentElement.innerHTML = `
            <div class="empty-state" style="height: 100%; display: flex; flex-direction: column; justify-content: center;">
                <i class="fas fa-industry"></i>
                <h4>Sin datos de marcas</h4>
                <p>No hay informaci√≥n de marcas disponible</p>
            </div>
        `;
        return;
    }
    
    charts.marcas = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: marcasArray.map(m => m[0]),
            datasets: [{
                data: marcasArray.map(m => m[1]),
                backgroundColor: ['#0066CC', '#E31837', '#22c55e', '#f59e0b', '#8b5cf6']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Marcas M√°s Populares',
                    font: { size: 14 }
                }
            }
        }
    });
}

function refreshData() {
    fetchData();
    mostrarMensaje('Datos actualizados', 'success');
}

// ============================================
// FUNCIONES UTILITARIAS
// ============================================

function setLoading(loading) {
    const loadingBar = document.getElementById('loadingBar');
    if (loading) {
        loadingBar.style.width = '100%';
        loadingBar.style.transition = 'width 0.4s ease';
    } else {
        loadingBar.style.width = '0';
        loadingBar.style.transition = 'width 0.2s ease';
    }
}

function mostrarMensaje(mensaje, tipo = 'info') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed; top: 20px; right: 20px; padding: 15px 25px;
        border-radius: 10px; color: white; font-weight: 600; z-index: 10000;
        animation: slideIn 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    `;
    
    notification.style.background = tipo === 'success' ? 'var(--success)' : 
                                  tipo === 'error' ? 'var(--danger)' : 'var(--primary)';
    
    notification.textContent = mensaje;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Agregar estilos de animaci√≥n
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);
</script>
</body>
</html>
