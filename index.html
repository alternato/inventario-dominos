async function analizarCSV() {
    const file = document.getElementById('csvFile').files[0];
    if(!file) return alert("Seleccione un archivo");

    const text = await file.text();
    const lines = text.split('\n').filter(l => l.trim() !== '');
    temporalCSVData = [];

    // --- MEJORA: DETECCIÓN AUTOMÁTICA DE SEPARADOR ---
    const firstLine = lines[0];
    const numComas = (firstLine.match(/,/g) || []).length;
    const numPuntoComas = (firstLine.match(/;/g) || []).length;
    
    // Elegimos el que más aparezca en la cabecera
    const separador = numPuntoComas >= numComas ? ';' : ',';
    console.log(`Separador detectado: "${separador}"`);
    // -------------------------------------------------

    for(let i=1; i<lines.length; i++) {
        // Usamos el separador detectado dinámicamente
        const cols = lines[i].split(separador).map(c => c.trim().replace(/"/g, ''));
        
        const rut = cols[0] || "";
        const esValido = validarRUT(rut);

        temporalCSVData.push({
            rut: rut,
            nombre: cols[1] || "SIN NOMBRE",
            serie: cols[2] || "SIN SERIE",
            tipo: cols[3] || "Laptop",
            estado: cols[5] || "Activo",
            valido: esValido,
            revisarLuego: false
        });
    }

    renderValidacion();
    document.getElementById('uploadStep').classList.add('hidden');
    document.getElementById('validationStep').classList.remove('hidden');
}
