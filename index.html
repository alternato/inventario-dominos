<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TI Maestro v35.0 - Enterprise</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --primary: #0066CC; --primary-dark: #0052a3; --secondary: #E31837;
            --success: #22c55e; --warning: #f59e0b; --danger: #ef4444;
            --bg: #FFFFF5; --dark: #1e293b; --gray: #64748b; --border: #e2e8f0;
            --light-gray: #f8fafc;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); display: flex; height: 100vh; overflow: hidden; font-size: 14px; }

        /* Estilos Sidebar y Login (Simplificados para brevedad, mantener los tuyos) */
        #sidebar { width: 280px; background: var(--primary); color: white; padding: 25px 20px; display: flex; flex-direction: column; flex-shrink: 0; }
        .main-view { flex-grow: 1; padding: 25px; overflow-y: auto; background: var(--light-gray); }
        
        /* Dashboard */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .chart-container { background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border); height: 350px; }
        
        /* RUT Error Style */
        .input-error { border-color: var(--danger) !important; background-color: #fff1f2 !important; }
        
        /* Animaciones */
        .hidden { display: none !important; }
        #loadingBar { position: fixed; top: 0; left: 0; height: 3px; background: var(--secondary); width: 0; transition: width 0.3s; z-index: 10000; }
        
        .nav-btn { background: rgba(255, 255, 255, 0.08); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; margin-bottom: 8px; text-align: left; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .nav-btn.active { background: var(--secondary); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div id="loadingBar"></div>

<div id="loginPage" class="login-container" style="display: flex; width:100%; height:100vh; align-items:center; justify-content:center; background: var(--primary);">
    <div style="background:white; padding:40px; border-radius:20px; width:100%; max-width:400px; text-align:center;">
        <img src="https://assets.dominospizza.cl/assets/logos/logo-dominos-header-51dca28d2d30068385e5de64c9ba774b640a59a56a67d19c24eee33a6aa10343.png" width="150">
        <h2 style="margin: 20px 0;">TI Maestro v35.0</h2>
        <input type="password" id="loginPass" placeholder="Contraseña Admin" style="width:100%; padding:12px; margin-bottom:15px; border-radius:8px; border:1px solid #ccc;">
        <button onclick="iniciarSesion()" style="width:100%; padding:12px; background:var(--secondary); color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">ACCEDER</button>
        <p id="loginError" style="color:var(--danger); display:none; margin-top:10px;">Acceso Denegado</p>
    </div>
</div>

<div id="appContainer" class="hidden" style="width:100%; display:flex;">
    <div id="sidebar">
        <div style="text-align:center; margin-bottom:30px;">
            <h3>TI MAESTRO</h3>
            <p style="font-size:10px; opacity:0.7;">DOMINO'S PIZZA CHILE</p>
        </div>
        <nav>
            <button class="nav-btn active" id="btnInv" onclick="showView('viewInventory')"><i class="fas fa-list"></i> Inventario</button>
            <button class="nav-btn" id="btnDash" onclick="showView('viewDashboard')"><i class="fas fa-chart-pie"></i> Dashboard</button>
            <button class="nav-btn" onclick="descargarReportePDF()" style="background:var(--success);"><i class="fas fa-file-pdf"></i> Reporte Diario</button>
        </nav>
        <button onclick="cerrarSesion()" style="margin-top:auto; padding:10px; background:transparent; border:1px solid white; color:white; border-radius:8px; cursor:pointer;">Cerrar Sesión</button>
    </div>

    <main class="main-view">
        <div id="viewInventory" class="view-content">
            <h1>Inventario General</h1>
            <div style="margin:20px 0; display:flex; gap:10px;">
                <input type="text" id="uSearch" placeholder="Buscar por RUT o Nombre..." style="flex-grow:1; padding:10px; border-radius:8px; border:1px solid #ccc;" oninput="renderLista()">
                <button onclick="openCSVModal()" style="padding:10px; background:var(--primary); color:white; border:none; border-radius:8px; cursor:pointer;"><i class="fas fa-upload"></i> Cargar CSV</button>
            </div>
            <div id="listaPersonas"></div>
        </div>

        <div id="viewDashboard" class="view-content hidden">
            <h1>Panel de Control TI</h1>
            <div class="dashboard-grid" id="dashCaptureArea">
                <div class="chart-container"><canvas id="chartTipos"></canvas></div>
                <div class="chart-container"><canvas id="chartEstados"></canvas></div>
            </div>
        </div>
    </main>
</div>

<div id="csvModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:11000;">
    <div style="background:white; padding:30px; border-radius:15px; max-width:500px; width:90%;">
        <h3>Carga Inteligente de Activos</h3>
        <p style="font-size:12px; margin:10px 0;">El sistema actualizará datos existentes y creará los nuevos automáticamente.</p>
        <input type="file" id="csvFile" accept=".csv" style="margin:20px 0;">
        <div style="display:flex; gap:10px; justify-content:flex-end;">
            <button onclick="closeCSVModal()" style="padding:10px; border:none; border-radius:5px;">Cancelar</button>
            <button id="btnProcessCSV" onclick="processCSV()" style="padding:10px; background:var(--success); color:white; border:none; border-radius:5px;">Iniciar Carga</button>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURACIÓN ---
    const SUPABASE_URL = "https://ivjwxvhixrskraepqzse.supabase.co";
    const SUPABASE_KEY = "TU_KEY_AQUI"; 
    const HEADERS = { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}`, "Content-Type": "application/json" };

    let masterData = [];
    let charts = {};

    // --- 1. VALIDACIÓN DE RUT CHILENO (Algoritmo de Módulo 11) ---
    function validarRUT(rut) {
        if (!/^[0-9]+-[0-9kK]{1}$/.test(rut)) return false;
        let [num, dv] = rut.split('-');
        let sum = 0, mul = 2;
        for (let i = num.length - 1; i >= 0; i--) {
            sum += num[i] * mul;
            mul = mul === 7 ? 2 : mul + 1;
        }
        let res = 11 - (sum % 11);
        let dvr = res === 11 ? '0' : res === 10 ? 'K' : res.toString();
        return dvr.toUpperCase() === dv.toUpperCase();
    }

    // --- 2. CARGA MASIVA SIN DESTRUCCIÓN (UPSERT) ---
    async function processCSV() {
        const file = document.getElementById('csvFile').files[0];
        if(!file) return alert("Seleccione archivo");

        setLoading(true);
        const text = await file.text();
        const lines = text.split('\n').filter(l => l.trim() !== '');
        
        let colaboradores = [];
        let activos = [];
        let errors = [];

        // Parseo (Asumiendo encabezados estándar)
        for(let i=1; i<lines.length; i++) {
            const cols = lines[i].split(';').map(c => c.trim().replace(/"/g, ''));
            const rut = cols[0]; // RUT debe estar en col 0
            
            if(!validarRUT(rut)) {
                errors.push(`Línea ${i}: RUT ${rut} inválido.`);
                continue;
            }

            colaboradores.push({ rut: rut, nombre: cols[1] });
            if(cols[2]) { // Serie en col 2
                activos.push({
                    serie: cols[2], tipo: cols[3], marca: cols[4],
                    estado: cols[5] || 'Activo', rut_responsable: rut
                });
            }
        }

        if(errors.length > 0) alert("Se encontraron errores:\n" + errors.slice(0,5).join('\n'));

        try {
            // UPSERT: Inserta o actualiza basado en la Primary Key (RUT y Serie)
            await fetch(`${SUPABASE_URL}/rest/v1/colaboradores`, {
                method: 'POST',
                headers: { ...HEADERS, "Prefer": "resolution=merge-duplicates" },
                body: JSON.stringify(colaboradores)
            });

            await fetch(`${SUPABASE_URL}/rest/v1/activos`, {
                method: 'POST',
                headers: { ...HEADERS, "Prefer": "resolution=merge-duplicates" },
                body: JSON.stringify(activos)
            });

            alert("Sincronización completa");
            fetchData();
            closeCSVModal();
        } catch(e) { console.error(e); }
        setLoading(false);
    }

    // --- 3. DASHBOARD EMPRESARIAL ---
    function renderDashboard() {
        const ctxT = document.getElementById('chartTipos').getContext('2d');
        const ctxE = document.getElementById('chartEstados').getContext('2d');

        const stats = { Laptops: 0, Celulares: 0, Otros: 0, BuenEstado: 0, Dañado: 0 };
        masterData.forEach(c => {
            c.equipos.forEach(e => {
                if(e.tipo?.toLowerCase().includes('laptop')) stats.Laptops++;
                else if(e.tipo?.toLowerCase().includes('celu')) stats.Celulares++;
                else stats.Otros++;

                if(e.estado?.toLowerCase().includes('buen')) stats.BuenEstado++;
                else stats.Dañado++;
            });
        });

        if(charts.t) charts.t.destroy();
        charts.t = new Chart(ctxT, {
            type: 'bar',
            data: {
                labels: ['Laptops', 'Celulares', 'Otros'],
                datasets: [{ label: 'Stock por Tipo', data: [stats.Laptops, stats.Celulares, stats.Otros], backgroundColor: '#0066CC' }]
            }
        });

        if(charts.e) charts.e.destroy();
        charts.e = new Chart(ctxE, {
            type: 'doughnut',
            data: {
                labels: ['Operativos', 'Críticos'],
                datasets: [{ data: [stats.BuenEstado, stats.Dañado], backgroundColor: ['#22c55e', '#ef4444'] }]
            },
            options: { plugins: { title: { display:true, text:'Estado de Salud de la Flota' } } }
        });
    }

    // --- 4. EXPORTACIÓN PDF (Reporte Pro) ---
    async function descargarReportePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'pt', 'a4');
        const element = document.getElementById('dashCaptureArea');

        setLoading(true);
        const canvas = await html2canvas(element);
        const imgData = canvas.toDataURL('image/png');
        
        doc.setFontSize(20);
        doc.text("Reporte de Activos TI - Domino's Pizza", 40, 50);
        doc.setFontSize(10);
        doc.text(`Fecha de emisión: ${new Date().toLocaleString()}`, 40, 70);
        
        doc.addImage(imgData, 'PNG', 40, 100, 520, 250);
        doc.save(`Reporte_TI_${Date.now()}.pdf`);
        setLoading(false);
    }

    // --- FUNCIONES CORE ---
    async function fetchData() {
        setLoading(true);
        const [c, a] = await Promise.all([
            fetch(`${SUPABASE_URL}/rest/v1/colaboradores?select=*&order=nombre.asc`, { headers: HEADERS }).then(r => r.json()),
            fetch(`${SUPABASE_URL}/rest/v1/activos?select=*`, { headers: HEADERS }).then(r => r.json())
        ]);
        masterData = c.map(col => ({
            ...col,
            equipos: a.filter(act => act.rut_responsable === col.rut),
            activoCount: a.filter(act => act.rut_responsable === col.rut).length
        }));
        renderLista();
        setLoading(false);
    }

    function showView(viewId) {
        document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(viewId).classList.remove('hidden');
        if(viewId === 'viewDashboard') renderDashboard();
    }

    function iniciarSesion() {
        if(document.getElementById('loginPass').value === 'DominoTI2024') {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            fetchData();
        } else {
            document.getElementById('loginError').style.display = 'block';
        }
    }

    function setLoading(l) { document.getElementById('loadingBar').style.width = l ? '100%' : '0'; }
    function openCSVModal() { document.getElementById('csvModal').classList.remove('hidden'); }
    function closeCSVModal() { document.getElementById('csvModal').classList.add('hidden'); }
</script>
</body>
</html>
