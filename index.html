<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TI Maestro v38.5 - Enterprise Edition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #0066CC; --primary-dark: #0052a3; --secondary: #E31837;
            --success: #22c55e; --warning: #f59e0b; --danger: #ef4444;
            --bg: #FFFFF5; --dark: #1e293b; --gray: #64748b; --border: #e2e8f0;
            --light-gray: #f8fafc;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); display: flex; height: 100vh; overflow: hidden; font-size: 14px; }

        /* Login */
        .login-container { display: flex; width: 100%; height: 100vh; background: var(--primary); align-items: center; justify-content: center; }
        .login-box { background: white; border-radius: 20px; padding: 40px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }

        /* Sidebar */
        #sidebar { width: 280px; background: var(--primary); color: white; padding: 25px; display: flex; flex-direction: column; flex-shrink: 0; }
        .nav-btn { background: rgba(255,255,255,0.08); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; margin-bottom: 8px; text-align: left; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .nav-btn:hover { background: rgba(255,255,255,0.15); }
        .nav-btn.active { background: var(--secondary); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }

        /* Main View */
        .main-view { flex-grow: 1; padding: 25px; overflow-y: auto; background: var(--light-gray); }
        
        /* Table / Validation */
        .validation-table-container { max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; margin-top: 15px; }
        .validation-table { width: 100%; border-collapse: collapse; background: white; font-size: 12px; }
        .validation-table th { position: sticky; top: 0; background: #f1f5f9; padding: 12px; text-align: left; border-bottom: 2px solid var(--border); z-index: 10; }
        .validation-table td { padding: 10px; border-bottom: 1px solid #eee; }
        .row-error { background-color: #fff1f2 !important; }
        .cell-edit { border: 1px solid #ddd; padding: 5px; border-radius: 4px; width: 100%; transition: 0.2s; }
        .cell-edit:focus { border-color: var(--primary); outline: none; background: white; }

        .hidden { display: none !important; }
        #loadingBar { position: fixed; top: 0; left: 0; height: 3px; background: var(--secondary); width: 0; transition: 0.3s; z-index: 10000; }
        
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-top: 20px; }
        .chart-container { background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border); height: 300px; }

        .btn-success { background: var(--success); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div id="loadingBar"></div>

<div id="loginPage" class="login-container">
    <div class="login-box">
        <img src="https://assets.dominospizza.cl/assets/logos/logo-dominos-header-51dca28d2d30068385e5de64c9ba774b640a59a56a67d19c24eee33a6aa10343.png" width="160">
        <h2 style="margin: 20px 0 10px;">TI Maestro v38.5</h2>
        <input type="password" id="loginPass" placeholder="Clave: DominoTI2024" style="width:100%; padding:12px; margin-bottom:15px; border-radius:8px; border:1px solid #ccc;">
        <button onclick="iniciarSesion()" style="width:100%; padding:12px; background:var(--secondary); color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">ACCEDER</button>
        <p id="loginError" style="color:var(--danger); display:none; margin-top:10px;">Contraseña Incorrecta</p>
    </div>
</div>

<div id="appContainer" class="hidden" style="width: 100%; display: flex;">
    <div id="sidebar">
        <div style="text-align:center; margin-bottom:30px;">
            <img src="https://assets.dominospizza.cl/assets/logos/logo-dominos-header-51dca28d2d30068385e5de64c9ba774b640a59a56a67d19c24eee33a6aa10343.png" width="120">
            <h4 style="margin-top:10px;">TI MAESTRO</h4>
        </div>
        <nav>
            <button class="nav-btn active" id="navInv" onclick="showView('viewInventory')"><i class="fas fa-boxes"></i> Inventario</button>
            <button class="nav-btn" id="navDash" onclick="showView('viewDashboard')"><i class="fas fa-chart-line"></i> Dashboard</button>
            <button class="nav-btn" onclick="abrirModalCSV()" style="background: rgba(34, 197, 94, 0.2);"><i class="fas fa-file-csv"></i> Cargar CSV</button>
        </nav>
        <button onclick="location.reload()" style="margin-top:auto; background:none; border:1px solid white; color:white; padding:10px; border-radius:8px; cursor:pointer;">Cerrar Sesión</button>
    </div>

    <main class="main-view">
        <div id="viewInventory" class="view-content">
            <h1>Gestión de Activos</h1>
            <div id="listaPersonas" style="margin-top:20px;"></div>
        </div>

        <div id="viewDashboard" class="view-content hidden">
            <h1>Análisis de Flota</h1>
            <div class="dashboard-grid">
                <div class="chart-container"><canvas id="chartTipos"></canvas></div>
                <div class="chart-container"><canvas id="chartEstados"></canvas></div>
            </div>
        </div>
    </main>
</div>

<div id="csvModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:10000;">
    <div style="background:white; padding:30px; border-radius:15px; width:95%; max-width:1000px; max-height:90vh; display:flex; flex-direction:column; overflow:hidden;">
        
        <div id="pasoSubida">
            <h3>1. Cargar Archivo</h3>
            <p style="margin: 10px 0;">Seleccione el archivo CSV para analizar las columnas.</p>
            <input type="file" id="csvFile" accept=".csv" style="margin:20px 0;">
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button onclick="cerrarModalCSV()" class="nav-btn" style="width:auto; color:black;">Cancelar</button>
                <button onclick="analizarColumnas()" class="btn-primary">Siguiente</button>
            </div>
        </div>

        <div id="pasoMapeo" class="hidden">
            <h3>2. Mapeo de Columnas (Domino's Style)</h3>
            <p style="margin:10px 0;">Hemos detectado estas columnas. Verifica que coincidan:</p>
            <div id="mapeoContainer" style="display:grid; grid-template-columns: repeat(2, 1fr); gap:15px; margin:20px 0; background:#f1f5f9; padding:20px; border-radius:10px;"></div>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button onclick="volverASubida()" class="nav-btn" style="width:auto; color:black;">Atrás</button>
                <button onclick="procesarConMapeo()" class="btn-success">Analizar Datos</button>
            </div>
        </div>

        <div id="pasoValidacion" class="hidden" style="flex-grow:1; display:flex; flex-direction:column; overflow:hidden;">
            <h3>3. Mesa de Corrección</h3>
            <div class="validation-table-container">
                <table class="validation-table">
                    <thead>
                        <tr><th>RUT</th><th>Nombre</th><th>Serie</th><th>Tipo</th><th>Estado</th><th>Validación</th></tr>
                    </thead>
                    <tbody id="csvPreviewBody"></tbody>
                </table>
            </div>
            <div style="margin-top:20px; display:flex; justify-content:flex-end; gap:10px;">
                <button onclick="cerrarModalCSV()" class="nav-btn" style="width:auto; color:black;">Cancelar</button>
                <button onclick="confirmarSincronizacion()" class="btn-success">Sincronizar con Supabase</button>
            </div>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = "https://ivjwxvhixrskraepqzse.supabase.co";
    const SUPABASE_KEY = "TU_KEY_AQUI"; 
    const HEADERS = { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}`, "Content-Type": "application/json" };

    let masterData = [];
    let temporalData = [];
    let headersDetectados = [];
    let lineasRaw = [];
    let charts = {};

    // --- 1. VALIDACIÓN RUT CHILENO ---
    function validarRUT(rut) {
        if (!/^[0-9]+-[0-9kK]{1}$/.test(rut)) return false;
        let [num, dv] = rut.split('-');
        let sum = 0, mul = 2;
        for (let i = num.length - 1; i >= 0; i--) {
            sum += num[i] * mul;
            mul = mul === 7 ? 2 : mul + 1;
        }
        let res = 11 - (sum % 11);
        let dvr = res === 11 ? '0' : res === 10 ? 'K' : res.toString();
        return dvr.toUpperCase() === dv.toUpperCase();
    }

    // --- 2. ANALIZAR COLUMNAS ---
    async function analizarColumnas() {
        const file = document.getElementById('csvFile').files[0];
        if(!file) return alert("Seleccione archivo");

        const text = await file.text();
        lineasRaw = text.split(/\r?\n/).filter(l => l.trim() !== '');
        if (lineasRaw.length < 2) return alert("Archivo vacío");

        const firstLine = lineasRaw[0];
        const sep = (firstLine.split(';').length >= firstLine.split(',').length) ? ';' : ',';
        headersDetectados = firstLine.split(sep).map(h => h.trim().replace(/"/g, ''));

        const camposConfig = [
            { id: 'm_rut', label: 'RUT', sug: 'Rut' },
            { id: 'm_nombre', label: 'Persona/Nombre', sug: 'Persona' },
            { id: 'm_serie', label: 'Serie', sug: 'Nº de Serie' },
            { id: 'm_tipo', label: 'Tipo Equipo', sug: 'Modelo' },
            { id: 'm_estado', label: 'Estado', sug: 'Estado' }
        ];

        document.getElementById('mapeoContainer').innerHTML = camposConfig.map(c => `
            <div style="display:flex; flex-direction:column; gap:5px;">
                <label style="font-weight:bold; font-size:12px;">${c.label}</label>
                <select id="${c.id}" style="padding:8px; border-radius:5px;">
                    ${headersDetectados.map((h, i) => `<option value="${i}" ${h.toLowerCase() === c.sug.toLowerCase() ? 'selected' : ''}>${h}</option>`).join('')}
                </select>
            </div>
        `).join('');

        document.getElementById('pasoSubida').classList.add('hidden');
        document.getElementById('pasoMapeo').classList.remove('hidden');
    }

    // --- 3. PROCESAR CON REGEX (RESPETA COMILLAS) ---
    async function procesarConMapeo() {
        const idx = {
            rut: parseInt(document.getElementById('m_rut').value),
            nombre: parseInt(document.getElementById('m_nombre').value),
            serie: parseInt(document.getElementById('m_serie').value),
            tipo: parseInt(document.getElementById('m_tipo').value),
            estado: parseInt(document.getElementById('m_estado').value)
        };

        const firstLine = lineasRaw[0];
        const sep = (firstLine.split(';').length >= firstLine.split(',').length) ? ';' : ',';
        // Regex mágica: separa por coma/punto-coma pero ignora lo que está dentro de " "
        const regex = new RegExp(`(?!\\s*${sep}|\\s*$)(?:(?:"(?:[^"]|"")*"|[^${sep}"\\s\\n\\r]*))`, 'g');

        temporalData = [];
        for(let i=1; i<lineasRaw.length; i++) {
            let cols = lineasRaw[i].match(regex) || [];
            cols = cols.map(c => c.replace(/^"|"$/g, '').trim());

            if (cols.length < 2) continue;

            const rutLimpio = (cols[idx.rut] || "").replace(/\./g, '').replace(/\s/g, '');

            temporalData.push({
                rut: rutLimpio,
                nombre: cols[idx.nombre] || "DESCONOCIDO",
                serie: cols[idx.serie] || "S/S",
                tipo: cols[idx.tipo] || "Equipo",
                estado: cols[idx.estado] || "Asignado",
                valido: validarRUT(rutLimpio)
            });
        }

        renderMesaEdicion();
        document.getElementById('pasoMapeo').classList.add('hidden');
        document.getElementById('pasoValidacion').classList.remove('hidden');
    }

    function renderMesaEdicion() {
        const body = document.getElementById('csvPreviewBody');
        body.innerHTML = temporalData.map((d, i) => `
            <tr class="${d.valido ? '' : 'row-error'}">
                <td><input class="cell-edit" value="${d.rut}" onchange="updateTemp(${i}, 'rut', this.value)"></td>
                <td><input class="cell-edit" value="${d.nombre}" onchange="updateTemp(${i}, 'nombre', this.value)"></td>
                <td><input class="cell-edit" value="${d.serie}" onchange="updateTemp(${i}, 'serie', this.value)"></td>
                <td>${d.tipo}</td>
                <td>${d.estado}</td>
                <td style="text-align:center">${d.valido ? '✅' : '❌'}</td>
            </tr>
        `).join('');
    }

    function updateTemp(i, field, val) {
        temporalData[i][field] = val;
        if(field === 'rut') temporalData[i].valido = validarRUT(val);
        renderMesaEdicion();
    }

    // --- 4. SINCRONIZACIÓN (UPSERT) ---
    async function confirmarSincronizacion() {
        setLoading(true);
        try {
            const colabs = temporalData.map(d => ({ rut: d.rut, nombre: d.nombre }));
            const activos = temporalData.map(d => ({ serie: d.serie, tipo: d.tipo, estado: d.estado, rut_responsable: d.rut }));

            // Enviar a Supabase ( resolution=merge-duplicates evita borrar datos )
            await fetch(`${SUPABASE_URL}/rest/v1/colaboradores`, {
                method: 'POST', headers: { ...HEADERS, "Prefer": "resolution=merge-duplicates" },
                body: JSON.stringify(colabs)
            });

            await fetch(`${SUPABASE_URL}/rest/v1/activos`, {
                method: 'POST', headers: { ...HEADERS, "Prefer": "resolution=merge-duplicates" },
                body: JSON.stringify(activos)
            });

            alert("Sincronización Exitosa");
            cerrarModalCSV();
            fetchData();
        } catch(e) { alert("Error de conexión"); }
        setLoading(false);
    }

    // --- CORE TOOLS ---
    function iniciarSesion() {
        if(document.getElementById('loginPass').value === 'DominoTI2024') {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            fetchData();
        } else { document.getElementById('loginError').style.display='block'; }
    }

    function showView(v) {
        document.querySelectorAll('.view-content').forEach(x => x.classList.add('hidden'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(v).classList.remove('hidden');
        if(v === 'viewDashboard') {
            renderDashboard(); 
            document.getElementById('navDash').classList.add('active');
        } else {
            document.getElementById('navInv').classList.add('active');
        }
    }

    function renderDashboard() {
        const ctxT = document.getElementById('chartTipos').getContext('2d');
        const ctxE = document.getElementById('chartEstados').getContext('2d');
        const stats = { l: 0, c: 0, ok: 0, err: 0 };
        
        masterData.forEach(p => p.equipos.forEach(e => {
            if(e.tipo?.toLowerCase().includes('lap')) stats.l++; else stats.c++;
            if(e.estado?.toLowerCase().includes('buen')) stats.ok++; else stats.err++;
        }));

        if(charts.t) charts.t.destroy();
        charts.t = new Chart(ctxT, { type:'bar', data: { labels:['Laptops','Cels'], datasets:[{label:'Stock', data:[stats.l, stats.c], backgroundColor:'#0066CC'}]}});
        
        if(charts.e) charts.e.destroy();
        charts.e = new Chart(ctxE, { type:'doughnut', data: { labels:['Operativos','Revisión'], datasets:[{data:[stats.ok, stats.err], backgroundColor:['#22c55e','#ef4444']}]}});
    }

    async function fetchData() {
        setLoading(true);
        try {
            const [c, a] = await Promise.all([
                fetch(`${SUPABASE_URL}/rest/v1/colaboradores?select=*&order=nombre.asc`, { headers: HEADERS }).then(r => r.json()),
                fetch(`${SUPABASE_URL}/rest/v1/activos?select=*`, { headers: HEADERS }).then(r => r.json())
            ]);
            masterData = c.map(col => ({
                ...col, equipos: a.filter(act => act.rut_responsable === col.rut),
                activoCount: a.filter(act => act.rut_responsable === col.rut).length
            }));
            // renderLista() logic...
        } catch(e) {}
        setLoading(false);
    }

    function abrirModalCSV() { document.getElementById('csvModal').classList.remove('hidden'); document.getElementById('pasoSubida').classList.remove('hidden'); document.getElementById('pasoMapeo').classList.add('hidden'); document.getElementById('pasoValidacion').classList.add('hidden'); }
    function cerrarModalCSV() { document.getElementById('csvModal').classList.add('hidden'); }
    function volverASubida() { document.getElementById('pasoMapeo').classList.add('hidden'); document.getElementById('pasoSubida').classList.remove('hidden'); }
    function setLoading(v) { document.getElementById('loadingBar').style.width = v ? '100%' : '0'; }
</script>
</body>
</html>
