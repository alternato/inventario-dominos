<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TI Maestro v36.5 - Pro Enterprise</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #0066CC; --primary-dark: #0052a3; --secondary: #E31837;
            --success: #22c55e; --warning: #f59e0b; --danger: #ef4444;
            --bg: #FFFFF5; --dark: #1e293b; --gray: #64748b; --border: #e2e8f0;
            --light-gray: #f8fafc;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); display: flex; height: 100vh; overflow: hidden; font-size: 14px; }

        /* Login */
        .login-container { display: flex; width: 100%; height: 100vh; background: var(--primary); align-items: center; justify-content: center; }
        .login-box { background: white; border-radius: 20px; padding: 40px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }

        /* Sidebar */
        #sidebar { width: 280px; background: var(--primary); color: white; padding: 25px; display: flex; flex-direction: column; flex-shrink: 0; }
        .nav-btn { background: rgba(255,255,255,0.08); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; margin-bottom: 8px; text-align: left; display: flex; align-items: center; gap: 10px; }
        .nav-btn.active { background: var(--secondary); }

        /* Main View */
        .main-view { flex-grow: 1; padding: 25px; overflow-y: auto; background: var(--light-gray); }
        
        /* Table / Validation */
        .validation-table-container { max-height: 450px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; margin-top: 15px; }
        .validation-table { width: 100%; border-collapse: collapse; background: white; font-size: 12px; }
        .validation-table th { position: sticky; top: 0; background: #f1f5f9; padding: 12px; text-align: left; border-bottom: 2px solid var(--border); }
        .validation-table td { padding: 10px; border-bottom: 1px solid #eee; }
        .row-error { background-color: #fff1f2 !important; }
        .cell-edit { border: 1px solid #ddd; padding: 5px; border-radius: 4px; width: 100%; transition: 0.2s; }
        .cell-edit:focus { border-color: var(--primary); outline: none; background: white; }

        .hidden { display: none !important; }
        #loadingBar { position: fixed; top: 0; left: 0; height: 3px; background: var(--secondary); width: 0; transition: 0.3s; z-index: 10000; }
        
        /* Dashboard */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-top: 20px; }
        .chart-container { background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border); height: 300px; }
    </style>
</head>
<body>

<div id="loadingBar"></div>

<div id="loginPage" class="login-container">
    <div class="login-box">
        <img src="https://assets.dominospizza.cl/assets/logos/logo-dominos-header-51dca28d2d30068385e5de64c9ba774b640a59a56a67d19c24eee33a6aa10343.png" width="160">
        <h2 style="margin: 20px 0 10px;">TI Maestro v36.5</h2>
        <input type="password" id="loginPass" placeholder="Contraseña de Administración" style="width:100%; padding:12px; margin-bottom:15px; border-radius:8px; border:1px solid #ccc;">
        <button onclick="iniciarSesion()" style="width:100%; padding:12px; background:var(--secondary); color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">ENTRAR</button>
        <p id="loginError" style="color:var(--danger); display:none; margin-top:10px;">Acceso Incorrecto</p>
    </div>
</div>

<div id="appContainer" class="hidden" style="width: 100%; display: flex;">
    <div id="sidebar">
        <div style="text-align:center; margin-bottom:30px;">
            <img src="https://assets.dominospizza.cl/assets/logos/logo-dominos-header-51dca28d2d30068385e5de64c9ba774b640a59a56a67d19c24eee33a6aa10343.png" width="120">
            <h4 style="margin-top:10px;">TI MAESTRO v36.5</h4>
        </div>
        <nav>
            <button class="nav-btn active" id="navInv" onclick="showView('viewInventory')"><i class="fas fa-boxes"></i> Inventario</button>
            <button class="nav-btn" id="navDash" onclick="showView('viewDashboard')"><i class="fas fa-chart-line"></i> Dashboard</button>
            <button class="nav-btn" onclick="abrirModalCSV()" style="background: rgba(34, 197, 94, 0.2);"><i class="fas fa-file-csv"></i> Cargar CSV</button>
        </nav>
        <button onclick="location.reload()" style="margin-top:auto; background:none; border:1px solid white; color:white; padding:10px; border-radius:8px; cursor:pointer;">Cerrar Sesión</button>
    </div>

    <main class="main-view">
        <div id="viewInventory" class="view-content">
            <h1>Gestión de Activos</h1>
            <div id="listaPersonas" style="margin-top:20px;"></div>
        </div>

        <div id="viewDashboard" class="view-content hidden">
            <h1>Análisis de Flota</h1>
            <div class="dashboard-grid">
                <div class="chart-container"><canvas id="chartTipos"></canvas></div>
                <div class="chart-container"><canvas id="chartEstados"></canvas></div>
            </div>
        </div>
    </main>
</div>

<div id="csvModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:10000;">
    <div style="background:white; padding:30px; border-radius:15px; width:95%; max-width:1000px; max-height:90vh; display:flex; flex-direction:column;">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h3>Importación Inteligente</h3>
            <button onclick="cerrarModalCSV()" style="border:none; background:none; font-size:20px; cursor:pointer;">&times;</button>
        </div>

        <div id="pasoSubida">
            <p style="margin-bottom:15px;">Seleccione el archivo CSV para procesar:</p>
            <input type="file" id="csvFile" accept=".csv" style="margin-bottom:10px;">
            <button onclick="procesarAnalisisCSV()" style="padding:10px 20px; background:var(--primary); color:white; border:none; border-radius:8px; cursor:pointer;">Analizar Archivo</button>
        </div>

        <div id="pasoValidacion" class="hidden" style="flex-grow:1; display:flex; flex-direction:column; overflow:hidden;">
            <div class="validation-table-container">
                <table class="validation-table">
                    <thead>
                        <tr>
                            <th>RUT</th>
                            <th>Nombre</th>
                            <th>Serie</th>
                            <th>Tipo</th>
                            <th>Estado</th>
                            <th>Validación</th>
                        </tr>
                    </thead>
                    <tbody id="csvPreviewBody"></tbody>
                </table>
            </div>
            <div style="margin-top:20px; display:flex; justify-content:flex-end; gap:10px;">
                <button onclick="cerrarModalCSV()" style="padding:10px 20px; border-radius:8px; border:1px solid #ccc;">Cancelar</button>
                <button onclick="confirmarSincronizacion()" style="padding:10px 20px; background:var(--success); color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">Sincronizar Datos</button>
            </div>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = "https://ivjwxvhixrskraepqzse.supabase.co";
    const SUPABASE_KEY = "TU_KEY_AQUI"; 
    const HEADERS = { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}`, "Content-Type": "application/json" };

    let masterData = [];
    let temporalData = [];
    let charts = {};

    // --- 1. VALIDACIÓN RUT CHILENO ---
    function validarRUT(rut) {
        if (!/^[0-9]+-[0-9kK]{1}$/.test(rut)) return false;
        let [num, dv] = rut.split('-');
        let sum = 0, mul = 2;
        for (let i = num.length - 1; i >= 0; i--) {
            sum += num[i] * mul;
            mul = mul === 7 ? 2 : mul + 1;
        }
        let res = 11 - (sum % 11);
        let dvr = res === 11 ? '0' : res === 10 ? 'K' : res.toString();
        return dvr.toUpperCase() === dv.toUpperCase();
    }

    // --- 2. MOTOR DE PARSEO CSV ULTRA-RESISTENTE ---
    async function procesarAnalisisCSV() {
        const file = document.getElementById('csvFile').files[0];
        if(!file) return alert("Seleccione archivo");

        const text = await file.text();
        // Separar por líneas considerando Windows/Unix
        const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
        if (lines.length < 2) return alert("Archivo insuficiente");

        // Detección de separador automático
        const header = lines[0];
        const sep = (header.split(';').length >= header.split(',').length) ? ';' : ',';
        
        // Expresión regular que respeta comillas
        const regex = new RegExp(`(?!\\s*${sep}|\\s*$)(?:(?:"(?:[^"]|"")*"|[^${sep}"\\s\\n\\r]*))`, 'g');
        
        temporalData = [];

        for(let i=1; i<lines.length; i++) {
            let cols = lines[i].match(regex) || [];
            cols = cols.map(c => c.replace(/^"|"$/g, '').trim());

            if (cols.length < 2) continue;

            const rut = cols[0] || "";
            temporalData.push({
                rut: rut,
                nombre: cols[1] || "DESCONOCIDO",
                serie: cols[2] || "S/S",
                tipo: cols[3] || "Laptop",
                estado: cols[5] || "Activo",
                valido: validarRUT(rut)
            });
        }

        renderMesaEdicion();
        document.getElementById('pasoSubida').classList.add('hidden');
        document.getElementById('pasoValidacion').classList.remove('hidden');
    }

    function renderMesaEdicion() {
        const body = document.getElementById('csvPreviewBody');
        body.innerHTML = temporalData.map((d, i) => `
            <tr class="${d.valido ? '' : 'row-error'}">
                <td><input class="cell-edit" value="${d.rut}" onchange="editItem(${i}, 'rut', this.value)"></td>
                <td><input class="cell-edit" value="${d.nombre}" onchange="editItem(${i}, 'nombre', this.value)"></td>
                <td><input class="cell-edit" value="${d.serie}" onchange="editItem(${i}, 'serie', this.value)"></td>
                <td>${d.tipo}</td>
                <td>${d.estado}</td>
                <td style="color:${d.valido ? 'green' : 'red'}">${d.valido ? '✅' : '❌ RUT'}</td>
            </tr>
        `).join('');
    }

    function editItem(index, field, value) {
        temporalData[index][field] = value;
        if(field === 'rut') temporalData[index].valido = validarRUT(value);
        renderMesaEdicion();
    }

    // --- 3. SINCRONIZACIÓN (UPSERT) ---
    async function confirmarSincronizacion() {
        const errores = temporalData.filter(d => !d.valido).length;
        if(errores > 0 && !confirm(`Hay ${errores} RUTs inválidos. ¿Desea ignorar la validación y subir de todas formas?`)) return;

        setLoading(true);
        try {
            const colab = temporalData.map(d => ({ rut: d.rut, nombre: d.nombre }));
            const acti = temporalData.map(d => ({ 
                serie: d.serie, tipo: d.tipo, estado: d.estado, rut_responsable: d.rut 
            }));

            // Inserción por lotes para mayor estabilidad
            await fetch(`${SUPABASE_URL}/rest/v1/colaboradores`, {
                method: 'POST', headers: { ...HEADERS, "Prefer": "resolution=merge-duplicates" },
                body: JSON.stringify(colab)
            });

            await fetch(`${SUPABASE_URL}/rest/v1/activos`, {
                method: 'POST', headers: { ...HEADERS, "Prefer": "resolution=merge-duplicates" },
                body: JSON.stringify(acti)
            });

            alert("Sincronización Exitosa");
            cerrarModalCSV();
            fetchData();
        } catch(e) { alert("Error de red"); }
        setLoading(false);
    }

    // --- 4. DASHBOARD ---
    function renderDashboard() {
        const ctxT = document.getElementById('chartTipos').getContext('2d');
        const ctxE = document.getElementById('chartEstados').getContext('2d');

        const stats = { l: 0, c: 0, o: 0, ok: 0, bad: 0 };
        masterData.forEach(p => p.equipos.forEach(e => {
            const t = e.tipo?.toLowerCase();
            if(t.includes('lap')) stats.l++; else if(t.includes('cel')) stats.c++; else stats.o++;
            if(e.estado?.toLowerCase().includes('buen')) stats.ok++; else stats.bad++;
        }));

        if(charts.t) charts.t.destroy();
        charts.t = new Chart(ctxT, { type:'bar', data:{ labels:['Laptops','Cels','Otros'], datasets:[{label:'Stock', data:[stats.l,stats.c,stats.o], backgroundColor:'#0066CC'}]}});
        
        if(charts.e) charts.e.destroy();
        charts.e = new Chart(ctxE, { type:'doughnut', data:{ labels:['Operativos','Criticos'], datasets:[{data:[stats.ok,stats.bad], backgroundColor:['#22c55e','#ef4444']}]}});
    }

    // --- CORE ---
    function iniciarSesion() {
        if(document.getElementById('loginPass').value === 'DominoTI2024') {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            fetchData();
        } else { document.getElementById('loginError').style.display='block'; }
    }

    async function fetchData() {
        setLoading(true);
        try {
            const [c, a] = await Promise.all([
                fetch(`${SUPABASE_URL}/rest/v1/colaboradores?select=*&order=nombre.asc`, { headers: HEADERS }).then(r => r.json()),
                fetch(`${SUPABASE_URL}/rest/v1/activos?select=*`, { headers: HEADERS }).then(r => r.json())
            ]);
            masterData = c.map(col => ({
                ...col, equipos: a.filter(act => act.rut_responsable === col.rut),
                activoCount: a.filter(act => act.rut_responsable === col.rut).length
            }));
            // Implementar renderLista() aquí...
        } catch(e) {}
        setLoading(false);
    }

    function showView(v) {
        document.querySelectorAll('.view-content').forEach(x => x.classList.add('hidden'));
        document.getElementById(v).classList.remove('hidden');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        if(v === 'viewDashboard') { renderDashboard(); document.getElementById('navDash').classList.add('active'); }
        else document.getElementById('navInv').classList.add('active');
    }

    function abrirModalCSV() { document.getElementById('csvModal').classList.remove('hidden'); }
    function cerrarModalCSV() { document.getElementById('csvModal').classList.add('hidden'); }
    function setLoading(v) { document.getElementById('loadingBar').style.width = v ? '100%' : '0'; }
</script>
</body>
</html>
