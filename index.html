let headersDetectados = [];
let lineasRaw = [];

async function leerColumnasCSV() {
    const file = document.getElementById('csvFile').files[0];
    if(!file) return alert("Seleccione archivo");

    const text = await file.text();
    lineasRaw = text.split(/\r?\n/).filter(l => l.trim() !== '');
    
    const firstLine = lineasRaw[0];
    const sep = (firstLine.split(';').length >= firstLine.split(',').length) ? ';' : ',';
    
    headersDetectados = firstLine.split(sep).map(h => h.trim().replace(/"/g, ''));

    // Lista de campos que necesitamos en nuestra base de datos
    const camposMaestro = [
        { id: 'm_rut', label: 'RUT', sugerencia: 'Rut' },
        { id: 'm_nombre', label: 'Nombre Colaborador', sugerencia: 'Persona' },
        { id: 'm_serie', label: 'Nº de Serie', sugerencia: 'Nº de Serie' },
        { id: 'm_tipo', label: 'Tipo de Equipo', sugerencia: 'Modelo' }, // Usaremos modelo o marca si no hay tipo
        { id: 'm_estado', label: 'Estado/Asignación', sugerencia: 'Estado' },
        { id: 'm_marca', label: 'Marca', sugerencia: 'Marca' },
        { id: 'm_area', label: 'Área/Departamento', sugerencia: 'Área' }
    ];

    const container = document.getElementById('mapeoContainer');
    container.innerHTML = camposMaestro.map(campo => `
        <div style="display:flex; flex-direction:column; gap:5px;">
            <label style="font-weight:bold; font-size:12px; color:var(--dark);">${campo.label}</label>
            <select id="${campo.id}" style="padding:10px; border-radius:8px; border:1px solid var(--border); background:white;">
                <option value="-1">-- Ignorar --</option>
                ${headersDetectados.map((h, index) => `
                    <option value="${index}" ${h.toLowerCase() === campo.sugerencia.toLowerCase() ? 'selected' : ''}>
                        ${h}
                    </option>
                `).join('')}
            </select>
        </div>
    `).join('');

    document.getElementById('pasoSubida').classList.add('hidden');
    document.getElementById('pasoMapeo').classList.remove('hidden');
}

async function procesarConMapeo() {
    const idx = {
        rut: parseInt(document.getElementById('m_rut').value),
        nombre: parseInt(document.getElementById('m_nombre').value),
        serie: parseInt(document.getElementById('m_serie').value),
        tipo: parseInt(document.getElementById('m_tipo').value),
        estado: parseInt(document.getElementById('m_estado').value),
        marca: parseInt(document.getElementById('m_marca').value),
        area: parseInt(document.getElementById('m_area').value)
    };

    temporalData = [];
    const sep = (lineasRaw[0].split(';').length >= lineasRaw[0].split(',').length) ? ';' : ',';
    const regex = new RegExp(`(?!\\s*${sep}|\\s*$)(?:(?:"(?:[^"]|"")*"|[^${sep}"\\s\\n\\r]*))`, 'g');

    for(let i = 1; i < lineasRaw.length; i++) {
        let cols = lineasRaw[i].match(regex) || [];
        cols = cols.map(c => c.replace(/^"|"$/g, '').trim());

        if (cols.length < 2) continue;

        const rutRaw = idx.rut !== -1 ? cols[idx.rut] : "";
        // Limpiamos el RUT de puntos y espacios, pero mantenemos el guión para validación
        const rutLimpio = rutRaw.replace(/\./g, '').replace(/\s/g, '');

        temporalData.push({
            rut: rutLimpio,
            nombre: idx.nombre !== -1 ? cols[idx.nombre] : "SIN NOMBRE",
            serie: idx.serie !== -1 ? cols[idx.serie] : "S/S",
            marca: idx.marca !== -1 ? cols[idx.marca] : "N/A",
            tipo: idx.tipo !== -1 ? cols[idx.tipo] : "Equipo",
            estado: idx.estado !== -1 ? cols[idx.estado] : "Asignado",
            area: idx.area !== -1 ? cols[idx.area] : "General",
            valido: validarRUT(rutLimpio)
        });
    }

    renderMesaEdicion();
    document.getElementById('pasoMapeo').classList.add('hidden');
    document.getElementById('pasoValidacion').classList.remove('hidden');
}
